/*!
 * maptalks.three v0.17.2
 * LICENSE : MIT
 * (c) 2016-2021 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks"),require("three")):"function"==typeof define&&define.amd?define(["exports","maptalks","three"],e):e((t=t||self).maptalks=t.maptalks||{},t.maptalks,t.THREE)}(this,(function(t,e,n){"use strict";const i=parseInt(n.REVISION.replace("dev",""));function r(t,e,n){return i>109?t.setAttribute(e,n):t.addAttribute(e,n),t}function o(){return!n.VertexColors||n.VertexColors}console.log(`maptalks.three log: current three.js version is %c${i}`,"color:red;font-size: 16px;font-weight: bold;");class s extends n.InstancedBufferGeometry{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),r(this,"position",new n.Float32BufferAttribute([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),r(this,"uv",new n.Float32BufferAttribute([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))}applyMatrix(t){var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;return void 0!==e&&(t.applyToBufferAttribute(e),t.applyToBufferAttribute(n),e.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}setPositions(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var i=new n.InstancedInterleavedBuffer(e,6,1);return r(this,"instanceStart",new n.InterleavedBufferAttribute(i,3,0)),r(this,"instanceEnd",new n.InterleavedBufferAttribute(i,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var i=new n.InstancedInterleavedBuffer(e,6,1);return r(this,"instanceColorStart",new n.InterleavedBufferAttribute(i,3,0)),r(this,"instanceColorEnd",new n.InterleavedBufferAttribute(i,3,3)),this}fromWireframeGeometry(t){return this.setPositions(t.attributes.position.array),this}fromEdgesGeometry(t){return this.setPositions(t.attributes.position.array),this}fromMesh(t){return this.fromWireframeGeometry(new n.WireframeGeometry(t.geometry)),this}fromLineSegements(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this}computeBoundingBox(){var t=new n.Box3;null===this.boundingBox&&(this.boundingBox=new n.Box3);var e=this.attributes.instanceStart,i=this.attributes.instanceEnd;void 0!==e&&void 0!==i&&(this.boundingBox.setFromBufferAttribute(e),t.setFromBufferAttribute(i),this.boundingBox.union(t))}computeBoundingSphere(){var t=new n.Vector3;null===this.boundingSphere&&(this.boundingSphere=new n.Sphere),null===this.boundingBox&&this.computeBoundingBox();var e=this.attributes.instanceStart,i=this.attributes.instanceEnd;if(void 0!==e&&void 0!==i){var r=this.boundingSphere.center;this.boundingBox.getCenter(r);for(var o=0,s=0,a=e.count;s<a;s++)t.fromBufferAttribute(e,s),o=Math.max(o,r.distanceToSquared(t)),t.fromBufferAttribute(i,s),o=Math.max(o,r.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(o),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}copy(t){return this}}const a={},c={};a.line={linewidth:{value:1},resolution:{value:new n.Vector2(1,1)},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},c.line={uniforms:n.UniformsUtils.merge([n.UniformsLib.common,n.UniformsLib.fog,a.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying vec2 vUv;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}\n\t\t"};class h extends n.ShaderMaterial{constructor(t){super({uniforms:n.UniformsUtils.clone(c.line.uniforms),vertexShader:c.line.vertexShader,fragmentShader:c.line.fragmentShader}),this.dashed=!0,this.isLineMaterial=!0,this.type="LineMaterial",Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}}}),this.setValues(t)}}class l extends n.Mesh{constructor(t,e){super(t,e),this.isLineSegments2=!0,this.type="LineSegments2",this.geometry=void 0!==t?t:new s,this.material=void 0!==e?e:new h({color:16777215*Math.random()})}computeLineDistances(){for(var t=new n.Vector3,e=new n.Vector3,i=this.geometry,o=i.attributes.instanceStart,s=i.attributes.instanceEnd,a=new Float32Array(2*o.data.count),c=0,h=0,l=o.data.count;c<l;c++,h+=2)t.fromBufferAttribute(o,c),e.fromBufferAttribute(s,c),a[h]=0===h?0:a[h-1],a[h+1]=a[h]+t.distanceTo(e);var u=new n.InstancedInterleavedBuffer(a,2,1);return r(i,"instanceDistanceStart",new n.InterleavedBufferAttribute(u,1,0)),r(i,"instanceDistanceEnd",new n.InterleavedBufferAttribute(u,1,1)),this}}class u extends s{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}fromLine(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this}}class d extends l{constructor(t,e){super(t,e),this.isLine2=!0,this.type="Line2",this.geometry=void 0!==t?t:new u,this.material=void 0!==e?e:new h({color:16777215*Math.random()})}copy(t){return this}}const f={interactive:!0,altitude:0,minZoom:0,maxZoom:30,asynchronous:!1};function g(){}class p extends(e.Eventable(g)){constructor(t){super(),this.isAdd=!1,this._mouseover=!1,this._visible=!0,this._zoomVisible=!0,this.picked=!1,this.isBaseObject=!0,void 0===t&&(t=e.Util.GUID()),this.id=t}addTo(t){return t&&"ThreeLayer"===t.type?t.addMesh([this]):console.error("layer only support maptalks.ThreeLayer"),this}remove(){const t=this.getLayer();return t&&t.removeMesh([this]),this}getObject3d(){return this.object3d}getId(){return this.id}setId(t){const e=this.getId();return this.id=t,this._fire("idchange",{old:e,new:t,target:this}),this}getType(){return this.type}getOptions(){return this.options}getProperties(){return(this.options||{}).properties}setProperties(t){const e=Object.assign({},this.getProperties());return this.options.properties=t,this._fire("propertieschange",{old:e,new:t,target:this}),this}getLayer(){return this.options.layer}getMap(){const t=this.getLayer();if(t)return t.getMap()}getCenter(){const t=this.getOptions(),{coordinate:n,lineString:i,polygon:r}=t;if(n)return n instanceof e.Coordinate?n:new e.Coordinate(n);{const t=r||i;if(t&&t.getCenter)return t.getCenter()}}getAltitude(){return this.getOptions().altitude}setAltitude(t){if(e.Util.isNumber(t)){const e=this.getLayer().distanceToVector3(t,t).x;if(this.getObject3d().position.z=e,this.options.altitude=t,this.pickObject3d&&(this.pickObject3d.position.z=e),this._baseObjects&&Array.isArray(this._baseObjects))for(let t=0,n=this._baseObjects.length;t<n;t++)this._baseObjects[t]&&(this._baseObjects[t].getObject3d().position.z=e)}return this}show(){return this._zoomVisible&&(this.getObject3d().visible=!0,this._fire("show")),this._visible=!0,this}hide(){return this.getObject3d().visible=!1,this._fire("hide"),this._visible=!1,this}isVisible(){return!!this.getObject3d().visible}getSymbol(){return this.getObject3d().material}setSymbol(t){if(t&&t instanceof n.Material){t.needsUpdate=!0,t.vertexColors=this.getObject3d().material.vertexColors;const e=this.getObject3d().material.clone();this.getObject3d().material=t,this._fire("symbolchange",{old:e,new:t,target:this})}return this}setInfoWindow(t){return this.removeInfoWindow(),this.infoWindow=new e.ui.InfoWindow(t),this.infoWindow.addTo(this),this}getInfoWindow(){return this.infoWindow}openInfoWindow(t){return(t=t||this.getCenter())instanceof e.Coordinate||(t=new e.Coordinate(t)),t&&this.infoWindow&&this.infoWindow.show(t),this}closeInfoWindow(){return this.infoWindow&&this.infoWindow.hide(),this}removeInfoWindow(){return this.infoWindow&&(this.infoWindow.remove(),delete this.infoWindow),this}setToolTip(t,n){return this.removeToolTip(),this.toolTip=new e.ui.ToolTip(t,n),this.toolTip.addTo(this),this}getToolTip(){return this.toolTip}openToolTip(t){return(t=t||this.getCenter())instanceof e.Coordinate||(t=new e.Coordinate(t)),t&&this.toolTip&&this.toolTip.show(t),this}closeToolTip(){return this.toolTip&&this.toolTip.hide(),this}removeToolTip(){return this.toolTip&&(this.toolTip.remove(),delete this.toolTip),this}animateShow(t={},n){this._showPlayer&&this._showPlayer.cancel(),e.Util.isFunction(t)&&(n=t={});const i=t.duration||1e3,r=t.easing||"out",o=this._showPlayer=e.animation.Animation.animate({scale:1},{duration:i,easing:r},(t=>{const e=t.styles.scale;e>0&&(this.getObject3d().scale.z=e),n&&n(t,e)}));return o.play(),o}getMinZoom(){return this.getOptions().minZoom}getMaxZoom(){return this.getOptions().maxZoom}isAsynchronous(){return this.getOptions().asynchronous}fire(t,e){return this._fire(t,e),this._vt&&this._vt.onSelectMesh&&this._vt.onSelectMesh(t,e),this}config(){return this}setPickObject3d(t){return this.pickObject3d=t,this.pickObject3d.__parent=this,this}_initOptions(t){return this.options=e.Util.extend({},f,t),this}_createMesh(t,e){return this.object3d=new n.Mesh(t,e),this.object3d.__parent=this,this}_createGroup(){return this.object3d=new n.Group,this.object3d.__parent=this,this}_createLine(t,e){return this.object3d=new n.Line(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this,this}_createLine2(t,e){return this.object3d=new d(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this,this}_createPoints(t,e){return this.object3d=new n.Points(t,e),this.object3d.__parent=this,this}_createLineSegments(t,e){return this.object3d=new n.LineSegments(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this,this}}function x(t){const{position:e,normal:i,uv:o,indices:s}=v(t),a=new n.BufferGeometry,c=new Float32Array(e.length);return c.fill(1,0,e.length),r(a,"color",new n.BufferAttribute(c,3)),r(a,"normal",new n.BufferAttribute(i,3)),r(a,"position",new n.BufferAttribute(e,3)),o&&o.length&&r(a,"uv",new n.BufferAttribute(o,2)),a.setIndex(new n.BufferAttribute(s,1)),a}function v(t){const e={},n={};for(let i=0;i<t.length;++i){const r=t[i];for(const t in r)void 0===e[t]&&(e[t]=[],n[t]=0),e[t].push(r[t]),n[t]+=r[t].length}const i={};let r=0;const o=new Uint32Array(n.indices);for(const t in e)if("indices"===t){const n=e[t];let i=0;for(let t=0,s=n.length;t<s;t++){const s=n[t];for(let t=0,e=s.length;t<e;t++)o[i]=s[t]+r,i++;r+=e.position[t].length/3}}else{const r=y(e[t],n[t]);if(!r)return null;i[t]=r}return i.indices=o,i}function y(t,e){const n=new Float32Array(e);let i=0;for(let e=0;e<t.length;++e)n.set(t[e],i),i+=t[e].length;return n}function m(t){const{position:e,normal:i,uv:o,indices:s}=t,a=new n.BufferGeometry;return r(a,"normal",new n.BufferAttribute(new Float32Array(i),3)),r(a,"position",new n.BufferAttribute(new Float32Array(e),3)),r(a,"uv",new n.BufferAttribute(new Float32Array(o),2)),a.setIndex(new n.BufferAttribute(new Uint32Array(s),1)),a}function b(t){const e=new n.BufferGeometry;return r(e,"normal",t.getAttribute("normal")),r(e,"position",t.getAttribute("position").clone()),e.setIndex(t.getIndex()),e}let _;function w(){if(!_){const t=1e-6;_=new n.BoxBufferGeometry(t,t,t)}return _}var M=Object.freeze({__proto__:null,mergeBufferGeometries:x,mergeBufferGeometriesAttribute:v,generateBufferGeometry:m,generatePickBufferGeometry:b,getDefaultBufferGeometry:w});const O={},S=new n.BoxBufferGeometry(1,1,1);S.translate(0,0,.5);const j=new n.Color("#fff"),A=new n.Color("#fff");function C(t){const{height:e,radialSegments:i,radius:r}=t,o=function(t=6){if(!O[t]){const e=new n.CylinderBufferGeometry(1,1,1,t,1);e.rotateX(Math.PI/2),e.translate(0,0,.5),e.rotateZ(Math.PI/6),O[t]=e}return O[t]}(i).clone();return o.scale(r,r,e),o}function T(t,e,i,o="y",s=0){let a=0;"y"===o?a=1:"z"===o&&(a=2);const c=t.attributes.position.array,h=c.length;A.setStyle(e),j.setStyle(i);const l=new Float32Array(h);for(let t=0;t<h;t+=3){c[t+a]>s?(l[t]=j.r,l[t+1]=j.g,l[t+2]=j.b):(l[t]=A.r,l[t+1]=A.g,l[t+2]=A.b)}return r(t,"color",new n.BufferAttribute(l,3,!0)),l}function L(t){const e=[],i=t.length;let o=0;for(let e=0;e<i;e++){const{color:n}=t[e].attributes;n&&(o+=n.array.length)}const s=new Float32Array(o);let a=0;for(let n=0,i=t.length;n<i;n++){const{color:i,normal:r,position:o,uv:c}=t[n].attributes,h=t[n].index;i&&(s.set(i.array,a),a+=i.array.length),e.push({normal:r.array,uv:c.array,position:o.array,indices:h.array})}const c=x(e);s.length&&r(c,"color",new n.BufferAttribute(s,3,!0));for(let e=0,n=t.length;e<n;e++)t[e].dispose();return c}function B(){return S}const z={radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61"};class P extends p{constructor(t,n,i,r){n=e.Util.extend({},z,n,{layer:r,coordinate:t}),super(),this._initOptions(n);const{height:s,radius:a,topColor:c,bottomColor:h,altitude:l}=n;n.height=r.distanceToVector3(s,s).x,n.radius=r.distanceToVector3(a,a).x,n._radius=this.options.radius,n._height=this.options.height;const u=C(n);c&&(T(u,h,c,"z",n.height/2),i.vertexColors=o()),this._createMesh(u,i);const d=r.distanceToVector3(l,l).x,f=r.coordinateToVector3(t,d);this.getObject3d().position.copy(f),this.type="Bar"}}function k(t,e,n={}){return void 0===n[t]&&(n[t]=e.distanceToVector3(t,t).x),n[t]}function V(t=[]){let n=0,i=0;const r=t.length;for(let o=0;o<r;o++){const{coordinate:r,lnglat:s,lnglats:a,xy:c,xys:h}=t[o],l=r||s||a||c||h||t[o];let u,d;Array.isArray(l)?(u=l[0],d=l[1]):l instanceof e.Coordinate&&(u=l.x,d=l.y),n+=u,i+=d}return new e.Coordinate(n/r,i/r)}function I(t,e,i,r){if(void 0===e||"number"!=typeof e||0===e)return 0;let o;o=t instanceof n.BufferGeometry?t.attributes.position.array:Array.isArray(t)?t:t.position;let s=0;if(o){r?(void 0===r[e]&&(r[e]=i.distanceToVector3(e,e).x),s=r[e]):s=i.distanceToVector3(e,e).x;const t=o.length;if(o[0]instanceof n.Vector3)for(let e=0;e<t;e++)o[e].z+=s;else for(let e=0;e<t;e+=3)o[e+2]+=s}return s}function U(t){const e=t.length;let n=0;for(let i=0;i<e;i++){const{count:e}=t[i].position;n+=e}return new Float32Array(3*n)}var E=Z,R=Z;function Z(t,e,n){n=n||2;var i,r,o,s,a,c,h,l=e&&e.length,u=l?e[0]*n:t.length,d=G(t,0,u,n,!0),f=[];if(!d||d.next===d.prev)return f;if(l&&(d=function(t,e,n,i){var r,o,s,a=[];for(r=0,o=e.length;r<o;r++)(s=G(t,e[r]*i,r<o-1?e[r+1]*i:t.length,i,!1))===s.next&&(s.steiner=!0),a.push(Y(s));for(a.sort(K),r=0;r<a.length;r++)J(a[r],n),n=F(n,n.next);return n}(t,e,d,n)),t.length>80*n){i=o=t[0],r=s=t[1];for(var g=n;g<u;g+=n)(a=t[g])<i&&(i=a),(c=t[g+1])<r&&(r=c),a>o&&(o=a),c>s&&(s=c);h=0!==(h=Math.max(o-i,s-r))?1/h:0}return D(d,f,n,i,r,h),f}function G(t,e,n,i,r){var o,s;if(r===ut(t,e,n,i)>0)for(o=e;o<n;o+=i)s=ct(o,t[o],t[o+1],s);else for(o=n-i;o>=e;o-=i)s=ct(o,t[o],t[o+1],s);return s&&nt(s,s.next)&&(ht(s),s=s.next),s}function F(t,e){if(!t)return t;e||(e=t);var n,i=t;do{if(n=!1,i.steiner||!nt(i,i.next)&&0!==et(i.prev,i,i.next))i=i.next;else{if(ht(i),(i=e=i.prev)===i.next)break;n=!0}}while(n||i!==e);return e}function D(t,e,n,i,r,o,s){if(t){!s&&o&&function(t,e,n,i){var r=t;do{null===r.z&&(r.z=Q(r.x,r.y,e,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){var e,n,i,r,o,s,a,c,h=1;do{for(n=t,t=null,o=null,s=0;n;){for(s++,i=n,a=0,e=0;e<h&&(a++,i=i.nextZ);e++);for(c=h;a>0||c>0&&i;)0!==a&&(0===c||!i||n.z<=i.z)?(r=n,n=n.nextZ,a--):(r=i,i=i.nextZ,c--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;n=i}o.nextZ=null,h*=2}while(s>1)}(r)}(t,i,r,o);for(var a,c,h=t;t.prev!==t.next;)if(a=t.prev,c=t.next,o?W(t,i,r,o):H(t))e.push(a.i/n),e.push(t.i/n),e.push(c.i/n),ht(t),t=c.next,h=c.next;else if((t=c)===h){s?1===s?D(t=q(F(t),e,n),e,n,i,r,o,2):2===s&&N(t,e,n,i,r,o):D(F(t),e,n,i,r,o,1);break}}}function H(t){var e=t.prev,n=t,i=t.next;if(et(e,n,i)>=0)return!1;for(var r=t.next.next;r!==t.prev;){if($(e.x,e.y,n.x,n.y,i.x,i.y,r.x,r.y)&&et(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function W(t,e,n,i){var r=t.prev,o=t,s=t.next;if(et(r,o,s)>=0)return!1;for(var a=r.x<o.x?r.x<s.x?r.x:s.x:o.x<s.x?o.x:s.x,c=r.y<o.y?r.y<s.y?r.y:s.y:o.y<s.y?o.y:s.y,h=r.x>o.x?r.x>s.x?r.x:s.x:o.x>s.x?o.x:s.x,l=r.y>o.y?r.y>s.y?r.y:s.y:o.y>s.y?o.y:s.y,u=Q(a,c,e,n,i),d=Q(h,l,e,n,i),f=t.prevZ,g=t.nextZ;f&&f.z>=u&&g&&g.z<=d;){if(f!==t.prev&&f!==t.next&&$(r.x,r.y,o.x,o.y,s.x,s.y,f.x,f.y)&&et(f.prev,f,f.next)>=0)return!1;if(f=f.prevZ,g!==t.prev&&g!==t.next&&$(r.x,r.y,o.x,o.y,s.x,s.y,g.x,g.y)&&et(g.prev,g,g.next)>=0)return!1;g=g.nextZ}for(;f&&f.z>=u;){if(f!==t.prev&&f!==t.next&&$(r.x,r.y,o.x,o.y,s.x,s.y,f.x,f.y)&&et(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;g&&g.z<=d;){if(g!==t.prev&&g!==t.next&&$(r.x,r.y,o.x,o.y,s.x,s.y,g.x,g.y)&&et(g.prev,g,g.next)>=0)return!1;g=g.nextZ}return!0}function q(t,e,n){var i=t;do{var r=i.prev,o=i.next.next;!nt(r,o)&&it(r,i,i.next,o)&&st(r,o)&&st(o,r)&&(e.push(r.i/n),e.push(i.i/n),e.push(o.i/n),ht(i),ht(i.next),i=t=o),i=i.next}while(i!==t);return F(i)}function N(t,e,n,i,r,o){var s=t;do{for(var a=s.next.next;a!==s.prev;){if(s.i!==a.i&&tt(s,a)){var c=at(s,a);return s=F(s,s.next),c=F(c,c.next),D(s,e,n,i,r,o),void D(c,e,n,i,r,o)}a=a.next}s=s.next}while(s!==t)}function K(t,e){return t.x-e.x}function J(t,e){if(e=function(t,e){var n,i=e,r=t.x,o=t.y,s=-1/0;do{if(o<=i.y&&o>=i.next.y&&i.next.y!==i.y){var a=i.x+(o-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(a<=r&&a>s){if(s=a,a===r){if(o===i.y)return i;if(o===i.next.y)return i.next}n=i.x<i.next.x?i:i.next}}i=i.next}while(i!==e);if(!n)return null;if(r===s)return n;var c,h=n,l=n.x,u=n.y,d=1/0;i=n;do{r>=i.x&&i.x>=l&&r!==i.x&&$(o<u?r:s,o,l,u,o<u?s:r,o,i.x,i.y)&&(c=Math.abs(o-i.y)/(r-i.x),st(i,t)&&(c<d||c===d&&(i.x>n.x||i.x===n.x&&X(n,i)))&&(n=i,d=c)),i=i.next}while(i!==h);return n}(t,e)){var n=at(e,t);F(e,e.next),F(n,n.next)}}function X(t,e){return et(t.prev,t,e.prev)<0&&et(e.next,t,t.next)<0}function Q(t,e,n,i,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Y(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function $(t,e,n,i,r,o,s,a){return(r-s)*(e-a)-(t-s)*(o-a)>=0&&(t-s)*(i-a)-(n-s)*(e-a)>=0&&(n-s)*(o-a)-(r-s)*(i-a)>=0}function tt(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&it(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(st(t,e)&&st(e,t)&&function(t,e){var n=t,i=!1,r=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&r<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==t);return i}(t,e)&&(et(t.prev,t,e.prev)||et(t,e.prev,e))||nt(t,e)&&et(t.prev,t,t.next)>0&&et(e.prev,e,e.next)>0)}function et(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function nt(t,e){return t.x===e.x&&t.y===e.y}function it(t,e,n,i){var r=ot(et(t,e,n)),o=ot(et(t,e,i)),s=ot(et(n,i,t)),a=ot(et(n,i,e));return r!==o&&s!==a||(!(0!==r||!rt(t,n,e))||(!(0!==o||!rt(t,i,e))||(!(0!==s||!rt(n,t,i))||!(0!==a||!rt(n,e,i)))))}function rt(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function ot(t){return t>0?1:t<0?-1:0}function st(t,e){return et(t.prev,t,t.next)<0?et(t,e,t.next)>=0&&et(t,t.prev,e)>=0:et(t,e,t.prev)<0||et(t,t.next,e)<0}function at(t,e){var n=new lt(t.i,t.x,t.y),i=new lt(e.i,e.x,e.y),r=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=r,r.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function ct(t,e,n,i){var r=new lt(t,e,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function ht(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function lt(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function ut(t,e,n,i){for(var r=0,o=e,s=n-i;o<n;o+=i)r+=(t[s]-t[o])*(t[o+1]+t[s+1]),s=o;return r}function dt(t,e,n){var i=e[0],r=e[1],o=n[0]-i,s=n[1]-r;if(0!==o||0!==s){var a=((t[0]-i)*o+(t[1]-r)*s)/(o*o+s*s);a>1?(i=n[0],r=n[1]):a>0&&(i+=o*a,r+=s*a)}return(o=t[0]-i)*o+(s=t[1]-r)*s}function ft(t,e,n,i,r){for(var o,s=i,a=e+1;a<n;a++){var c=dt(t[a],t[e],t[n]);c>s&&(o=a,s=c)}s>i&&(o-e>1&&ft(t,e,o,i,r),r.push(t[o]),n-o>1&&ft(t,o,n,i,r))}function gt(t,e){var n=t.length-1,i=[t[0]];return ft(t,0,n,e,i),i.push(t[n]),i}function pt(t,e,n){if(t.length<=2)return t;var i=void 0!==e?e*e:1;return t=gt(t=n?t:function(t,e){for(var n,i,r,o,s,a=t[0],c=[a],h=1,l=t.length;h<l;h++)n=t[h],r=a,o=void 0,s=void 0,o=(i=n)[0]-r[0],s=i[1]-r[1],o*o+s*s>e&&(c.push(n),a=n);return a!==n&&c.push(n),c}(t,i),i)}function xt(t,e){return t[0]*e[0]+t[1]*e[1]}function vt(t,e){const n=e[0],i=e[1],r=Math.sqrt(n*n+i*i);return t[0]=n/r,t[1]=i/r,t}function yt(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t}function mt(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t}function bt(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function _t(t,e){const n=e[0],i=e[1],r=e[2],o=Math.sqrt(n*n+i*i+r*r);return t[0]=n/o,t[1]=i/o,t[2]=r/o,t}function wt(t,e,n){var i=e[0],r=e[1],o=e[2],s=n[0],a=n[1],c=n[2];return t[0]=r*c-o*a,t[1]=o*s-i*c,t[2]=i*a-r*s,t}Z.deviation=function(t,e,n,i){var r=e&&e.length,o=r?e[0]*n:t.length,s=Math.abs(ut(t,0,o,n));if(r)for(var a=0,c=e.length;a<c;a++){var h=e[a]*n,l=a<c-1?e[a+1]*n:t.length;s-=Math.abs(ut(t,h,l,n))}var u=0;for(a=0;a<i.length;a+=3){var d=i[a]*n,f=i[a+1]*n,g=i[a+2]*n;u+=Math.abs((t[d]-t[g])*(t[f+1]-t[d+1])-(t[d]-t[f])*(t[g+1]-t[d+1]))}return 0===s&&0===u?0:Math.abs((u-s)/s)},Z.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},i=0,r=0;r<t.length;r++){for(var o=0;o<t[r].length;o++)for(var s=0;s<e;s++)n.vertices.push(t[r][o][s]);r>0&&(i+=t[r-1].length,n.holes.push(i))}return n},E.default=R;const Mt=[];function Ot(t,e,n,i){const r=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}(e,n),o=Math.acos(r)*i;return yt(Mt,n,e,-r),function(t,e){const n=e[0],i=e[1],r=e[2],o=Math.sqrt(n*n+i*i+r*r);t[0]=n/o,t[1]=i/o,t[2]=r/o}(Mt,Mt),function(t,e,n){t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n}(t,e,Math.cos(o)),yt(t,t,Mt,Math.sin(o)),t}function St(t,e,n){if(n-e<3)return 0;let i=0;for(let r=2*(n-1),o=2*e;o<2*n;){const e=t[r],n=t[r+1],s=t[o],a=t[o+1];r=o,o+=2,i+=e*a-s*n}return i}function jt(t,e,n=2){return E(t,e,n)}const At=[],Ct=[],Tt=[];function Lt(t,e,n,i,r,o,s,a){const c=null!=s;let h=r,l=null;c&&(l=new Uint32Array(i-n));for(let r=n;r<i;r++){const u=r===i-1?n:r+1,d=r===n?i-1:r-1,f=t[2*d],g=t[2*d+1],p=t[2*r],x=t[2*r+1],v=t[2*u],y=t[2*u+1];if(At[0]=p-f,At[1]=x-g,Ct[0]=v-p,Ct[1]=y-x,vt(At,At),vt(Ct,Ct),c&&(l[r]=h),a||r!==n)if(a||r!==i-1){mt(Tt,Ct,At);const t=Tt[1];Tt[1]=-Tt[0],Tt[0]=t,vt(Tt,Tt);const n=xt(Tt,Ct),i=Math.sqrt(1-n*n),r=o*Math.min(10,1/i),a=o*n<0;if(c&&1/i>s&&a){const t=p+Tt[0]*o,n=x+Tt[1]*o,r=Math.acos(i)/2,s=Math.tan(r)*Math.abs(o);e[2*h]=t+Tt[1]*s,e[2*h+1]=n-Tt[0]*s,h++,e[2*h]=t-Tt[1]*s,e[2*h+1]=n+Tt[0]*s,h++}else e[2*h]=p+Tt[0]*r,e[2*h+1]=x+Tt[1]*r,h++}else Tt[0]=At[1],Tt[1]=-At[0],vt(Tt,Tt),e[2*h]=p+Tt[0]*o,e[2*h+1]=x+Tt[1]*o,h++;else Tt[0]=Ct[1],Tt[1]=-Ct[0],vt(Tt,Tt),e[2*h]=p+Tt[0]*o,e[2*h+1]=x+Tt[1]*o,h++}return l}function Bt(t,e,n,i,r){const o=null!=i?[]:new Float32Array(t.length);if(Lt(t,o,0,e&&e.length?e[0]:t.length/2,0,n,i,r),e)for(let s=0;s<e.length;s++){const a=e[s];Lt(t,o,a,e[s+1]||t.length/2,null!=i?o.length/2:a,n,i,r)}return o}function zt(t,e,n,i){for(let r=0;r<Math.floor((i-n)/2);r++)for(let o=0;o<e;o++){const s=(r+n)*e+o,a=(i-r-1)*e+o,c=t[s];t[s]=t[a],t[a]=c}return t}function Pt(t,e){let n=t.length/2,i=0,r=e&&e.length?e[0]:n;St(t,i,r)>0&&zt(t,2,i,r);for(let o=1;o<(e?e.length:0)+1;o++)i=e[o-1],r=e[o]||n,St(t,i,r)<0&&zt(t,2,i,r)}function kt(t){t.depth=t.depth||1,t.bevelSize=t.bevelSize||0,t.bevelSegments=null==t.bevelSegments?2:t.bevelSegments,t.smoothSide=t.smoothSide||!1,t.smoothBevel=t.smoothBevel||!1,t.simplify=t.simplify||0,"number"==typeof t.depth&&(t.bevelSize=Math.min(t.bevelSegments>0?t.bevelSize:0,t.depth/2)),t.bevelSize>0||(t.bevelSegments=0),t.bevelSegments=Math.round(t.bevelSegments);const e=t.boundingRect;if(t.translate=t.translate||[0,0],t.scale=t.scale||[1,1],t.fitRect){let n=null==t.fitRect.x?e.x||0:t.fitRect.x,i=null==t.fitRect.y?e.y||0:t.fitRect.y,r=t.fitRect.width,o=t.fitRect.height;null==r?null!=o?r=o/e.height*e.width:(r=e.width,o=e.height):null==o&&(o=r/e.width*e.height),t.scale=[r/e.width,o/e.height],t.translate=[(n-e.x)*t.scale[0],(i-e.y)*t.scale[1]]}}const Vt=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function It(t,{vertices:e,topVertices:n,depth:i,rect:r},o,s,a,c){const h=s-o,l=c.smoothSide?1:2,u=h*l,d=c.smoothBevel?1:2,f=Math.min(i/2,c.bevelSize),g=c.bevelSegments,p=a.vertex,x=Math.max(r.width,r.height,i);if(f>0){const r=[0,0,1],s=[],c=[0,0,-1],v=[];let y=0,m=new Float32Array(h);for(let b=0;b<2;b++){const _=0===b?i-f:f;for(let i=0;i<=g*d;i++){let w,M,O=0;for(let S=0;S<h;S++){for(let p=0;p<l;p++){let l=2*((S+p)%h+o);s[0]=e[l]-n[l],s[1]=e[l+1]-n[l+1],s[2]=0;const y=Math.sqrt(s[0]*s[0]+s[1]*s[1]);s[0]/=y,s[1]/=y;const j=(Math.floor(i/d)+i%d)/g;0===b?Ot(v,r,s,j):Ot(v,s,c,j);const A=0===b?j:1-j,C=f*Math.sin(A*Math.PI/2),T=y*Math.cos(A*Math.PI/2),L=f*y/Math.sqrt(C*C+T*T),B=v[0]*L+n[l],z=v[1]*L+n[l+1],P=v[2]*L+_;if(t.position[3*a.vertex]=B,t.position[3*a.vertex+1]=z,t.position[3*a.vertex+2]=P,(S>0||p>0)&&(O+=Math.sqrt((w-B)*(w-B)+(M-z)*(M-z))),i>0||b>0){let e=3*(a.vertex-u),n=t.position[e],i=t.position[e+1],r=t.position[e+2];m[S]+=Math.sqrt((n-B)*(n-B)+(i-z)*(i-z)+(r-P)*(r-P))}t.uv[2*a.vertex]=O/x,t.uv[2*a.vertex+1]=m[S]/x,w=B,M=z,a.vertex++}if(d>1&&i%d||1===d&&i>=1)for(let e=0;e<6;e++){const n=(Vt[e][0]+S*l)%u,i=Vt[e][1]+y;t.indices[a.index++]=(i-1)*u+n+p}}y++}}}else for(let n=0;n<2;n++){const r=0===n?i-f:f;let s,c,u=0;for(let n=0;n<h;n++)for(let i=0;i<l;i++){const l=2*((n+i)%h+o),d=e[l],f=e[l+1];t.position[3*a.vertex]=d,t.position[3*a.vertex+1]=f,t.position[3*a.vertex+2]=r,(n>0||i>0)&&(u+=Math.sqrt((s-d)*(s-d)+(c-f)*(c-f))),t.uv[2*a.vertex]=u/x,t.uv[2*a.vertex+1]=r/x,s=d,c=f,a.vertex++}}const v=f>0?g*d+1:1;for(let e=0;e<h;e++)for(let n=0;n<6;n++){const i=(Vt[n][0]+e*l)%u,r=Vt[n][1]+v;t.indices[a.index++]=(r-1)*u+i+p}}function Ut({indices:t,vertices:e,topVertices:n,rect:i,depth:r},o,s,a){if(e.length<=4)return;const c=s.vertex,h=t.length;for(let e=0;e<h;e++)o.indices[s.index++]=c+t[e];const l=Math.max(i.width,i.height);for(let t=0;t<(a.excludeBottom?1:2);t++)for(let e=0;e<n.length;e+=2){const a=n[e],c=n[e+1];o.position[3*s.vertex]=a,o.position[3*s.vertex+1]=c,o.position[3*s.vertex+2]=(1-t)*r,o.uv[2*s.vertex]=(a-i.x)/l,o.uv[2*s.vertex+1]=(c-i.y)/l,s.vertex++}if(!a.excludeBottom){const n=e.length/2;for(let e=0;e<h;e+=3)for(let i=0;i<3;i++)o.indices[s.index++]=c+n+t[e+2-i]}}function Et(t,e){let n=0,i=0;for(let r=0;r<t.length;r++){const{indices:o,vertices:s,holes:a,depth:c}=t[r],h=s.length/2,l=Math.min(c/2,e.bevelSize)>0?e.bevelSegments:0;n+=o.length*(e.excludeBottom?1:2),i+=h*(e.excludeBottom?1:2);const u=2+2*l;let d=0,f=0;for(let t=0;t<(a?a.length:0)+1;t++){0===t?f=a&&a.length?a[0]:h:(d=a[t-1],f=a[t]||h),n+=6*(f-d)*(u-1);const r=(f-d)*(e.smoothSide?1:2);i+=r*u+(e.smoothBevel?0:l*r*2)}}const r={position:new Float32Array(3*i),indices:new(i>65535?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*i)},o={vertex:0,index:0};for(let n=0;n<t.length;n++)Ut(t[n],r,o,e);for(let n=0;n<t.length;n++){const{holes:i,vertices:s}=t[n],a=s.length/2;let c=0,h=i&&i.length?i[0]:a;if(It(r,t[n],c,h,o,e),i)for(let s=0;s<i.length;s++)c=i[s],h=i[s+1]||a,It(r,t[n],c,h,o,e)}for(let t=0;t<r.uv.length;t++){const e=r.uv[t];e>0&&Math.round(e)===e?r.uv[t]=1:r.uv[t]=e%1}return r.normal=function(t,e){function n(t,e,n,i){t[0]=e,t[1]=n,t[2]=i}const i=[],r=[],o=[],s=[],a=[],c=[],h=t.length,l=new Float32Array(e.length);for(let u=0;u<h;){const h=3*t[u++],d=3*t[u++],f=3*t[u++];n(i,e[h],e[h+1],e[h+2]),n(r,e[d],e[d+1],e[d+2]),n(o,e[f],e[f+1],e[f+2]),bt(s,i,r),bt(a,r,o),wt(c,s,a);for(let t=0;t<3;t++)l[h+t]=l[h+t]+c[t],l[d+t]=l[d+t]+c[t],l[f+t]=l[f+t]+c[t]}for(var u=0;u<l.length;)n(c,l[u],l[u+1],l[u+2]),_t(c,c),l[u++]=c[0],l[u++]=c[1],l[u++]=c[2];return l}(r.indices,r.position),r.boundingRect=t[0]&&t[0].rect,r}function Rt(t,e,n){const i=n.lineWidth,r=t.length,o=new Float32Array(2*r),s=n.translate||[0,0],a=n.scale||[1,1];for(let e=0,n=0;e<r;e++)o[n++]=t[e][0]*a[0]+s[0],o[n++]=t[e][1]*a[1]+s[1];St(o,0,r)<0&&zt(o,2,0,r);const c=[],h=[],l=n.miterLimit,u=Lt(o,h,0,r,0,-i/2,l,!1);zt(o,2,0,r);const d=Lt(o,c,0,r,0,-i/2,l,!1),f=(c.length+h.length)/2,g=new Float32Array(2*f);let p=0;const x=h.length/2;for(let t=0;t<h.length;t++)g[p++]=h[t];for(let t=0;t<c.length;t++)g[p++]=c[t];const v=new(f>65535?Uint32Array:Uint16Array)(3*(2*(r-1)+(f-2*r)));let y=0;for(let t=0;t<r-1;t++){const e=t+1;v[y++]=x-1-u[t],v[y++]=x-1-u[t]-1,v[y++]=d[t]+1+x,v[y++]=x-1-u[t],v[y++]=d[t]+1+x,v[y++]=d[t]+x,d[e]-d[t]==2?(v[y++]=d[t]+2+x,v[y++]=d[t]+1+x,v[y++]=x-u[e]-1):u[e]-u[t]==2&&(v[y++]=d[e]+x,v[y++]=x-1-(u[t]+1),v[y++]=x-1-(u[t]+2))}const m=n.bevelSize>0?Bt(g,[],n.bevelSize,null,!0):g,b=n.boundingRect;return{vertices:g,indices:v,topVertices:m,rect:{x:b.x*a[0]+s[0],y:b.y*a[1]+s[1],width:b.width*a[0],height:b.height*a[1]},depth:"function"==typeof n.depth?n.depth(e):n.depth,holes:[]}}function Zt(t,e){const n=[];for(let i=0;i<t.length;i++){const r=t[i],o=[],s=r.length;let a=r[s-1][0],c=r[s-1][1],h=0;for(let t=0;t<s;t++){let n=r[t][0],i=r[t][1];const s=n-a,l=i-c;h+=Math.sqrt(s*s+l*l),h>e&&(o.push(r[t]),h=0),a=n,c=i}o.length>=3&&n.push(o)}return n.length>0?n:null}function Gt(t,e){const n=[];for(let i=0;i<t.length;i++){let r=t[i];r=pt(r,e,!0),r.length>=3&&n.push(r)}return n.length>0?n:null}function Ft(t,e){e=Object.assign({},e);const n=[1/0,1/0],i=[-1/0,-1/0];for(let e=0;e<t.length;e++)Ht(t[e][0],n,i);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:i[0]-n[0],height:i[1]-n[1]},kt(e);const r=[],o=e.translate||[0,0],s=e.scale||[1,1],a=e.boundingRect,c={x:a.x*s[0]+o[0],y:a.y*s[1]+o[1],width:a.width*s[0],height:a.height*s[1]},h=Math.min(a.width,a.height)/1e5;for(let n=0;n<t.length;n++){let i=Zt(t[n],h);if(!i)continue;const a=e.simplify/Math.max(s[0],s[1]);if(a>0&&(i=Gt(i,a)),!i)continue;const{vertices:l,holes:u,dimensions:d}=E.flatten(i);for(let t=0;t<l.length;)l[t]=l[t++]*s[0]+o[0],l[t]=l[t++]*s[1]+o[1];if(Pt(l,u),2!==d)throw new Error("Only 2D polygon points are supported");const f=e.bevelSize>0?Bt(l,u,e.bevelSize,null,!0):l,g=jt(f,u,d);r.push({indices:g,vertices:l,topVertices:f,holes:u,rect:c,depth:"function"==typeof e.depth?e.depth(n):e.depth})}return Et(r,e)}function Dt(t,e){e=Object.assign({},e);const n=[1/0,1/0],i=[-1/0,-1/0];for(let e=0;e<t.length;e++)Ht(t[e],n,i);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:i[0]-n[0],height:i[1]-n[1]},kt(e);const r=e.scale||[1,1];null==e.lineWidth&&(e.lineWidth=1),null==e.miterLimit&&(e.miterLimit=2);const o=[];for(let n=0;n<t.length;n++){let i=t[n];const s=e.simplify/Math.max(r[0],r[1]);s>0&&(i=pt(i,s,!0)),o.push(Rt(i,n,e))}return Et(o,e)}function Ht(t,e,n){for(let i=0;i<t.length;i++)e[0]=Math.min(t[i][0],e[0]),e[1]=Math.min(t[i][1],e[1]),n[0]=Math.max(t[i][0],n[0]),n[1]=Math.max(t[i][1],n[1])}var Wt=Object.freeze({__proto__:null,triangulate:jt,flatten:function(t){return E.flatten(t)},offsetPolygon:Bt,extrudePolygon:Ft,extrudePolyline:Dt,extrudeGeoJSON:function(t,e){e=Object.assign({},e);const n=[],i=[],r=[],o=[],s=[1/0,1/0],a=[-1/0,-1/0];for(let e=0;e<t.features.length;e++){const c=t.features[e].geometry;if(c&&c.coordinates)switch(c.type){case"LineString":n.push(c.coordinates),r.push(e),Ht(c.coordinates,s,a);break;case"MultiLineString":for(let t=0;t<c.coordinates.length;t++)n.push(c.coordinates[t]),r.push(e),Ht(c.coordinates[t],s,a);break;case"Polygon":i.push(c.coordinates),o.push(e),Ht(c.coordinates[0],s,a);break;case"MultiPolygon":for(let t=0;t<c.coordinates.length;t++)i.push(c.coordinates[t]),o.push(e),Ht(c.coordinates[t][0],s,a)}}e.boundingRect=e.boundingRect||{x:s[0],y:s[1],width:a[0]-s[0],height:a[1]-s[1]};const c=e.depth;return{polyline:Dt(n,Object.assign(e,{depth:function(e){return"function"==typeof c?c(t.features[r[e]]):c}})),polygon:Ft(i,Object.assign(e,{depth:function(e){return"function"==typeof c?c(t.features[o[e]]):c}}))}}});const qt=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"];function Nt(t){return t.geometry?t.geometry.type:null}function Kt(t){const e=Nt(t);if(e)for(let t=0,n=qt.length;t<n;t++)if(qt[t]===e)return!0;return!1}function Jt(t){const e=Nt(t);return!(!e||e!==qt[4]&&e!==qt[5])}function Xt(t){const e=Nt(t);return!(!e||e!==qt[2]&&e!==qt[3])}function Qt(t){const e=Nt(t);return!(!e||e!==qt[0]&&e!==qt[1])}function Yt(t){const e=Nt(t);return!!(e&&e.indexOf("Multi")>-1)}function $t(t){return t.geometry?t.geometry.coordinates:[]}function te(t,n){const i=Nt(t);if(!i||!t.geometry)return null;const r=t.geometry.coordinates;if(!r)return null;let o=0,s=0,a=0;switch(i){case"Point":o=r[0],s=r[1],a++;break;case"MultiPoint":case"LineString":for(let t=0,e=r.length;t<e;t++)o+=r[t][0],s+=r[t][1],a++;break;case"MultiLineString":case"Polygon":for(let t=0,e=r.length;t<e;t++)for(let e=0,n=r[t].length;e<n;e++)o+=r[t][e][0],s+=r[t][e][1],a++;break;case"MultiPolygon":for(let t=0,e=r.length;t<e;t++)for(let e=0,n=r[t].length;e<n;e++)for(let n=0,i=r[t][e].length;n<i;n++)o+=r[t][e][n][0],s+=r[t][e][n][1],a++}const c=o/a,h=s/a;return n?(n.x=c,n.y=h,n):new e.Coordinate(c,h)}function ee(t){const e=Nt(t);if(!e||!t.geometry)return null;const n=t.geometry,i=t.properties||{},r=n.coordinates;if(!r)return null;const o=[];let s;switch(e){case"MultiPoint":s="Point";break;case"MultiLineString":s="LineString";break;case"MultiPolygon":s="Polygon"}if(s)for(let t=0,e=r.length;t<e;t++)o.push({type:"Feature",geometry:{type:s,coordinates:r[t]},properties:i});else o.push(t);return o}var ne=Object.freeze({__proto__:null,isGeoJSON:Kt,isGeoJSONPolygon:Jt,isGeoJSONLine:Xt,isGeoJSONPoint:Qt,isGeoJSONMulti:Yt,getGeoJSONCoordinates:$t,getGeoJSONCenter:te,spliteGeoJSONMulti:ee});function ie(t,i,r){const o=[];if(Array.isArray(t)&&t[0]instanceof n.Vector3)for(let e=0,n=t.length;e<n;e++){const n=t[e];o.push(n)}else{Array.isArray(t)&&(t=new e.LineString(t));const n=0;let s,a;Kt(t)?(s=$t(t),r||(a=te(t))):t instanceof e.LineString&&(s=t.getCoordinates(),r||(a=t.getCenter()));const c=i.coordinateToVector3(r||a);for(let t=0,e=s.length;t<e;t++){const e=s[t],r=i.coordinateToVector3(e,n).sub(c);o.push(r)}}const s=new Float32Array(3*o.length),a=new Float32Array(2*o.length);for(let t=0,e=o.length;t<e;t++){const e=3*t,n=o[t];s[e]=n.x,s[e+1]=n.y,s[e+2]=n.z;const i=2*t;a[i]=n.x,a[i+1]=n.y}return{positions:s,positionsV:o,positions2d:a}}function re(t,e,n,i){const r=[],o=[],s=[];for(let e=0,n=t.length;e<n;e++){const n=t[e];for(let t=0,e=n.length;t<e;t++){const e=n[t];if(s.length>0){e.join(",").toString()!==s[s.length-1].join(",").toString()&&s.push(e)}else s.push(e)}}for(let t=0,a=s.length;t<a;t++){const a=s[t];let c;const h=a.join(",").toString();c=n&&n[h]?n[h]:e.coordinateToVector3(a,0).sub(i),o.push(c),r.push(c.x,c.y,c.z)}return{positions:r,positionsV:o,lnglats:s}}function oe(t,e=1,n=1,i,r){const o=ie(t,i,r).positionsV,s=[];for(let t=0,e=o.length;t<e;t++){const e=o[t];s.push([e.x,e.y])}const{indices:a,position:c,normal:h,uv:l}=Dt([s],{lineWidth:e,depth:n});return{position:c,normal:h,indices:a,uv:l}}function se(t){let n,i=[];return t instanceof e.MultiLineString?(i=t.getGeometries(),n=t.getCenter()):t instanceof e.LineString?(i.push(t),n=t.getCenter()):Kt(t)&&(n=te(t),Yt(t)?i=ee(t):i.push(t)),{lineStrings:i,center:n}}function ae(t,e){for(let n=0,i=e.length;n<i;n++){const r=e[n];n>0&&n<i-1&&t.push(r.x,r.y,r.z),t.push(r.x,r.y,r.z)}}var ce=Object.freeze({__proto__:null,getLinePosition:ie,getExtrudeLineGeometry:function(t,e=1,i=1,o,s){const{indices:a,position:c,normal:h,uv:l}=oe(t,e,i,o,s),u=new n.BufferGeometry;return r(u,"position",new n.BufferAttribute(c,3)),r(u,"normal",new n.BufferAttribute(h,3)),r(u,"uv",new n.BufferAttribute(l,2)),u.setIndex(new n.BufferAttribute(a,1)),u},getChunkLinesPosition:re,getExtrudeLineParams:oe,LineStringSplit:se,setLineSegmentPosition:ae});const he={altitude:0,bottomHeight:0,colors:null};class le extends p{constructor(t,i,s,a){i=e.Util.extend({},he,i,{layer:a,lineString:t}),super(),this._initOptions(i);const{lineStrings:c,center:h}=se(t),l=[];for(let t=0,e=c.length;t<e;t++){const e=c[t],{positionsV:n}=ie(e,a,h);ae(l,n)}const u=new n.BufferGeometry;r(u,"position",new n.Float32BufferAttribute(l,3)),I(u,i.bottomHeight,a);const d=function(t){const e=[];return t&&t.length&&t.forEach((t=>{t=t instanceof n.Color?t:new n.Color(t),e.push(t.r,t.g,t.b)})),e}(i.colors);d&&d.length&&(r(u,"color",new n.Float32BufferAttribute(d,3)),s.vertexColors=o()),this._createLineSegments(u,s);const{altitude:f}=i,g=a.distanceToVector3(f,f).x,p=a.coordinateToVector3(h,g);this.getObject3d().position.copy(p),this.type="Line"}}const ue=new n.Color("#fff"),de=new n.Color("#fff");function fe(t,e,i,o){const{position:s,normal:a,uv:c,indices:h}=ge(t,e,i,o),l=new Float32Array(s.length);l.fill(1,0,s.length);const u=new n.BufferGeometry;return r(u,"color",new n.BufferAttribute(l,3)),r(u,"normal",new n.BufferAttribute(a,3)),r(u,"position",new n.BufferAttribute(s,3)),r(u,"uv",new n.BufferAttribute(c,2)),u.setIndex(new n.Uint32BufferAttribute(h,1)),u}function ge(t,e,n,i,r,o){const s=xe(t,n,i,r,!1);if(!s)return null;o?(null==o[e]&&(o[e]=n.distanceToVector3(e,e).x),e=o[e]):e=n.distanceToVector3(e,e).x;const{position:a,normal:c,uv:h,indices:l}=Ft(s,{depth:e});return{position:a,normal:c,uv:h,indices:l}}function pe(t,e,i,o){void 0===o&&(o=0);const s=t.attributes.position.array,a=s.length;let c;if(de.setStyle(e),ue.setStyle(i),Array.isArray(o)){let t=0;for(let e=0,n=o.length;e<n;e++){const{count:n}=o[e].position;t+=3*n}c=new Float32Array(t)}else c=new Float32Array(s.length);if(Array.isArray(o))for(let t=0,e=o.length;t<e;t++){const{middleZ:e,start:n,end:i}=o[t].position;for(let t=n;t<i;t+=3){s[t+2]>e?(c[t]=ue.r,c[t+1]=ue.g,c[t+2]=ue.b):(c[t]=de.r,c[t+1]=de.g,c[t+2]=de.b)}}else for(let t=0;t<a;t+=3){s[t+2]>o?(c[t]=ue.r,c[t+1]=ue.g,c[t+2]=ue.b):(c[t]=de.r,c[t+1]=de.g,c[t+2]=de.b)}return r(t,"color",new n.BufferAttribute(c,3,!0)),c}function xe(t,n,i,r,o=!1){if(!t)return null;let s=[];if(t instanceof e.MultiPolygon)s=t.getGeometries().map((e=>ve(e,n,i||t.getCenter(),r,o)));else if(t instanceof e.Polygon){const e=ve(t,n,i||t.getCenter(),r,o);s.push(e)}else if(Jt(t))if(Yt(t)){const e=ee(t);for(let a=0,c=e.length;a<c;a++)s.push(ve(e[a],n,i||te(t),r,o))}else{const e=ve(t,n,i||te(t),r,o);s.push(e)}return s}function ve(t,n,i,r,o=!1){let s,a,c;if(Jt(t)){const e=$t(t);s=e[0],a=e.slice(1,e.length),i=i||te(t)}else t instanceof e.Polygon&&(s=t.getShell(),a=t.getHoles(),i=i||t.getCenter());r=r||n.coordinateToVector3(i),c=o?new Float32Array(2*s.length):[];for(let t=0,e=s.length;t<e;t++){const e=s[t],i=n.coordinateToVector3(e).sub(r);if(o){const e=2*t;c[e]=i.x,c[e+1]=i.y}else c.push([i.x,i.y])}const h=[o?c.buffer:c];if(a&&a.length>0)for(let t=0,e=a.length;t<e;t++){const e=o?new Float32Array(2*a[t].length):[];for(let i=0,s=a[t].length;i<s;i++){const s=a[t][i],c=n.coordinateToVector3(s).sub(r);if(o){const t=2*i;e[t]=c.x,e[t+1]=c.y}else e.push([c.x,c.y])}h.push(o?e.buffer:e)}return h}var ye=Object.freeze({__proto__:null,getExtrudeGeometry:fe,getExtrudeGeometryParams:ge,initVertexColors:pe,getPolygonPositions:xe,getSinglePolygonPositions:ve});const me={bottomHeight:0,width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61"};class be extends p{constructor(t,n,i,r){n=e.Util.extend({},me,n,{layer:r,lineString:t}),super(),this._initOptions(n);const{height:s,width:a,bottomColor:c,topColor:h,bottomHeight:l,altitude:u}=n,d=r.distanceToVector3(s,s).x,f=r.distanceToVector3(a,a).x,{lineStrings:g,center:p}=se(t),v=[];let y=0;const m={};for(let t=0,e=g.length;t<e;t++){const e=oe(g[t],f,d,r,p);y=I(e,l,r,m),v.push(e)}const b=x(v);h&&(pe(b,c,h,y+d/2),i.vertexColors=o()),this._createMesh(b,i);const _=r.distanceToVector3(u,u).x,w=r.coordinateToVector3(p,_);this.getObject3d().position.copy(w),this.type="ExtrudeLine"}}const _e={altitude:0,height:1,bottomHeight:0,topColor:null,bottomColor:"#2d2f61"};class we extends p{constructor(t,n,i,r){n=e.Util.extend({},_e,n,{layer:r,polygon:t}),super(),this._initOptions(n);const{height:s,topColor:a,bottomColor:c,altitude:h,bottomHeight:l}=n,u=fe(t,s,r),d=Jt(t)?te(t):t.getCenter(),f=I(u,l,r);if(a){pe(u,c,a,f+r.distanceToVector3(s,s).x/2),i.vertexColors=o()}this._createMesh(u,i);const g=r.distanceToVector3(h,h).x,p=r.coordinateToVector3(d,g);this.getObject3d().position.copy(p),this.type="ExtrudePolygon"}}const Me={altitude:0,coordinate:null};class Oe extends p{constructor(t,n={},i){n.coordinate||(console.warn("coordinate is null,it is important to locate the model"),n.coordinate=i.getMap().getCenter()),n=e.Util.extend({},Me,n,{layer:i,model:t}),super(),this._initOptions(n),this._createGroup(),this.getObject3d().add(t);const{altitude:r,coordinate:o}=n,s=i.distanceToVector3(r,r).x,a=i.coordinateToVector3(o,s);this.getObject3d().position.copy(a),this.type="Model"}}const Se=Math.PI/180;function je(t){return t.getCoordinates().map((t=>t.toArray()))}function Ae(t){return t*Se}function Ce(t,e){if(!t||!e)return 0;Array.isArray(t)||(t=t.toArray()),Array.isArray(e)||(e=e.toArray());let n=Ae(t[1]);const i=Ae(e[1]),r=n-i,o=Ae(t[0])-Ae(e[0]);return n=2*Math.asin(Math.sqrt(Math.pow(Math.sin(r/2),2)+Math.cos(n)*Math.cos(i)*Math.pow(Math.sin(o/2),2))),n*=6378137,Math.round(1e5*n)/1e5}function Te(t,e){const{len:n,c1:i,c2:r}=t,o=r[0]-i[0],s=r[1]-i[1],a=e/n;return[i[0]+a*o,i[1]+a*s]}function Le(t,e=10){e=Math.max(e,1),Array.isArray(t)||(t=je(t));const n=t.length;let i=[],r=0;for(let e=0;e<n-1;e++){const n=Ce(t[e],t[e+1]),o=Math.floor(n);i.push({c1:t[e],len:o,c2:t[e+1]}),r+=o}if(r<=e){return i.map((t=>[t.c1,t.c2]))}if(1===i.length&&i[0].len<=e)return[[i[0].c1,i[0].c2]];const o=i.length;let s,a=0,c=0;const h=[];let l=[i[0].c1];for(;a<o;){const{len:t,c2:n}=i[a];if(c+=t,c<e&&(l.push(n),a===o-1&&h.push(l),a++),c===e&&(l.push(n),c=0,h.push(l),l=[n],a++),c>e){const n=t-c+e;s=Te(i[a],n),l.push(s),h.push(l),c=0,i[a].c1=s,i[a].len=t-n,l=[],l.push(s)}}return h}var Be=Object.freeze({__proto__:null,distance:Ce,lineLength:function(t){let e=t;Array.isArray(t)||(e=je(t));let n=0;for(let t=0,i=e.length;t<i-1;t++)n+=Ce(e[t],e[t+1]);return n},lineSlice:Le});const ze=1e3;function Pe(t,e,n,i){const r=e.length;t.attributes.normal.count=r,t.attributes.position.count=r;const o=t.attributes.position.array,s=t.attributes.normal.array;for(let t=0;t<r;t++)o[t]=e[t],s[t]=n[t];t.index.count=i.length;for(let e=0,n=i.length;e<n;e++)t.index.array[e]=i[e]}const ke={trail:5,chunkLength:50,width:2,height:1,speed:1,altitude:0,interactive:!1};class Ve extends p{constructor(t,i,o,s){i=e.Util.extend({},ke,i,{layer:s,lineString:t}),super(),this._initOptions(i);const{width:a,height:c,altitude:h,speed:l,chunkLength:u,trail:d}=i;let f,g;Kt(t)?(f=te(t),g=$t(t)):(f=t.getCenter(),g=t);const p=Le(g,u),x=s.coordinateToVector3(f),v={};for(let t=0,e=p.length;t<e;t++){const e=p[t];for(let t=0,n=e.length;t<n;t++){const n=e[t],i=n.join(",").toString();v[i]||(v[i]=s.coordinateToVector3(n).sub(x))}}const y=re(p.slice(0,1),s,v,x).positionsV,m=new n.BufferGeometry,b=new Float32Array(3e3),_=new Float32Array(3e3),w=new Uint16Array(ze);r(m,"position",new n.BufferAttribute(b,3)),r(m,"normal",new n.BufferAttribute(_,3)),m.setIndex(new n.BufferAttribute(w,1));const M=s.distanceToVector3(a,a).x,O=s.distanceToVector3(c,c).x,S=oe(y,M,O,s);Pe(m,S.position,S.normal,S.indices),this._createMesh(m,o);const j=s.distanceToVector3(h,h).x,A=s.coordinateToVector3(f,j);this.getObject3d().position.copy(A),this._params={index:0,chunkLines:p,geometries:[],layer:s,trail:Math.max(1,d),lineWidth:M,depth:O,speed:Math.min(1,l),idx:0,loaded:!1,positionMap:v,centerPt:x},this._init(this._params),this.type="ExtrudeLineTrail"}_init(t){const{layer:e,trail:n,lineWidth:i,depth:r,chunkLines:o,positionMap:s,centerPt:a}=t,c=o.length,h=[];for(let t=0;t<c;t++){const c=re(o.slice(t,t+n),e,s,a).positionsV;h.push(oe(c,i,r,e))}this._params.geometries=h,this._params.loaded=!0}_animation(){const{index:t,geometries:e,speed:n,idx:i,chunkLines:r,trail:o,lineWidth:s,depth:a,loaded:c,layer:h,positionMap:l,centerPt:u}=this._params;if(!c)return;const d=Math.round(t);if(d>i){this._params.idx++;let t=e[d];if(!t){t=oe(re(r.slice(d,d+o),h,l,u).positionsV,s,a,h),e[d]=t}const n=this.getObject3d();Pe(n.geometry,t.position,t.normal,t.indices),n.geometry.attributes.position.needsUpdate=!0,n.geometry.attributes.normal.needsUpdate=!0,n.geometry.index.needsUpdate=!0}t>=r.length-1&&(this._params.index=-1,this._params.idx=-1),this._params.index+=n}}const Ie=["click","mousemove","mousedown","mouseup","dblclick","contextmenu"].join(" ").toString(),Ue=new n.MeshBasicMaterial;Ue.vertexColors=o();const Ee=t=>class extends t{_initBaseObjectsEvent(t){if(t&&Array.isArray(t)&&t.length)for(let e=0,n=t.length;e<n;e++){const n=t[e];this._proxyEvent(n)}return this}_proxyEvent(t){t.on("add",(t=>{this._showGeometry(t.target,!0)})),t.on("remove",(t=>{this._showGeometry(t.target,!1)})),t.on("mouseout",(t=>{this._mouseover=!1,this.fire("mouseout",Object.assign({},t,{target:this,selectMesh:this.getSelectMesh?this.getSelectMesh():null}))})),t.on(Ie,(t=>{this.fire(t.type,Object.assign({},t,{target:this,selectMesh:this.getSelectMesh?this.getSelectMesh():null}))}))}_getHideGeometryIndex(t){const e=[];let n=0;for(let i=0,r=this._geometriesAttributes.length;i<r;i++)!0===this._geometriesAttributes[i].hide&&(e.push(i),n+=this._geometriesAttributes[i][t].count);return{indexs:e,count:n}}_updateAttribute(t,e){const{indexs:i}=this._getHideGeometryIndex(e),r=this._geometryCache.attributes[e].array,o=r.length;for(let e=0;e<o;e++)t.array[e]=r[e];let s=NaN;this.getObject3d()instanceof n.LineSegments&&(s=0);for(let n=0;n<i.length;n++){const r=i[n],{start:o,end:a}=this._geometriesAttributes[r][e];for(let e=o;e<a;e++)t.array[e]=s}return this}_showGeometry(t,e){let n;if(t&&(n=t.getOptions().index),null!=n){const t=this._geometriesAttributes[n],{hide:i}=t;if(i===e)return this;t.hide=e;const r=this.getObject3d().geometry;this._updateAttribute(r.attributes.position,"position"),r.attributes.position.needsUpdate=!0,this.isHide=e}return this}getSelectMesh(){const t=this._getIndex();if(null!=t)return{data:this._datas[t],baseObject:this._baseObjects[t]}}_getIndex(t){return null==t&&(t=this.faceIndex||this.index),t}_init(){const t=this.getLayer().getPick();this.on("add",(()=>{t.add(this.pickObject3d)})),this.on("remove",(()=>{t.remove(this.pickObject3d)}))}_setPickObject3d(){const t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),{_geometriesAttributes:i}=this,o=i.length,s=U(i);let a=0;for(let t=0;t<o;t++){const n=e.getColor(),r=n.getHex();this._colorMap[r]=t;const{count:o}=i[t].position;this._datas[t].colorIndex=r;for(let t=0;t<o;t++)s[a]=n.r,s[a+1]=n.g,s[a+2]=n.b,a+=3}r(t,"color",new n.BufferAttribute(s,3,!0));const c=e.getColor().getHex(),h=new n.Mesh(t,Ue);h.position.copy(this.getObject3d().position),h._colorIndex=c,this.setPickObject3d(h)}};let Re;var Ze;function Ge(){return e.worker||console.error("maptalks.worker is not defined,You can't use ThreeVectorTileLayer"),Ze||(Ze=new Re("__maptalks.three__")),Ze}e.worker&&(Re=class extends e.worker.Actor{test(t,e){this.send(t,null,e)}pushQueue(t={}){const{type:e,data:n,callback:i,layer:r,key:o,center:s,lineStrings:a}=t;let c;"Polygon"===e?c=function(t=[],e,n){const i=n.coordinateToVector3(e),r=t.length,o=[],s=[],a={};for(let c=0;c<r;c++){const r=t[c],h=xe(r,n,e,i,!0);for(let t=0,e=h.length;t<e;t++){const e=h[t];for(let t=0,n=e.length;t<n;t++)s.push(e[t])}const l=Jt(r)?r.properties:r.getProperties()||{};let u=l.height||1,d=l.bottomHeight||0;void 0!==d&&"number"==typeof d&&0!==d&&(void 0===a[d]&&(a[d]=n.distanceToVector3(d,d).x),d=a[d]),void 0===a[u]&&(a[u]=n.distanceToVector3(u,u).x),u=a[u],o.push({data:h,height:u,bottomHeight:d})}return{datas:o,transfer:s}}(n,s,r):"LineString"===e&&(c=function(t,e,n,i){const r=[],o=[],s={},a=t.length;for(let c=0;c<a;c++){const a=t[c],h=Xt(i[c])?i[c].properties:i[c].getProperties()||{},l=h.width||1,u=h.height||1;let d=h.bottomHeight||0;void 0!==d&&"number"==typeof d&&0!==d&&(void 0===s[d]&&(s[d]=n.distanceToVector3(d,d).x),d=s[d]),void 0===s[u]&&(s[u]=n.distanceToVector3(u,u).x),void 0===s[l]&&(s[l]=n.distanceToVector3(l,l).x);const f=[];for(let t=0,i=a.length;t<i;t++){const i=ie(a[t],n,e).positions2d;o.push(i),f.push(i)}r.push({data:f,height:s[u],width:s[l],bottomHeight:d})}return{datas:r,transfer:o}}(n,s,r,a)),this.send({type:e,datas:c.datas},c.transfe,(function(t,e){t&&console.error(t),e.key=o,i(e)}))}});const Fe={altitude:0,height:1,bottomHeight:0,topColor:null,bottomColor:"#2d2f61"},De=new e.Coordinate(0,0);class He extends(Ee(p)){constructor(t,n,i,r){Array.isArray(t)||(t=[t]);const s=t.length;0===s&&console.error("polygons is empty");let a=1/0,c=1/0,h=-1/0,l=-1/0;for(let n=0;n<s;n++){const i=t[n],r=i.getCenter?i.getCenter():te(i,De);let o,s;Array.isArray(r)?(o=r[0],s=r[1]):r instanceof e.Coordinate&&(o=r.x,s=r.y),a=Math.min(a,o),c=Math.min(c,s),h=Math.max(h,o),l=Math.max(l,s)}const u=new e.Coordinate((a+h)/2,(c+l)/2);n=e.Util.extend({},Fe,n,{layer:r,polygons:t,coordinate:u});const{topColor:d,bottomColor:f,altitude:g,asynchronous:p}=n;let v;const y=[],_=[],M=[];if(p){var O=Ge();v=w(),O.pushQueue({type:"Polygon",layer:r,key:n.key,center:u,data:t,callback:t=>{const{faceMap:e,geometriesAttributes:n}=t;this._faceMap=e,this._geometriesAttributes=n;const r=m(t);this._geometryCache=b(r),d&&(pe(r,f,d,n),i.vertexColors=o());const s=this.getObject3d();if(s.geometry=r,s.material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}})}else{const e=r.coordinateToVector3(u),n=[];let a=0,c=0,h=0,l=0;const g={};for(let i=0;i<s;i++){const o=t[i],s=Jt(o)?o.properties:o.getProperties()||{},d=s.height||1,f=s.bottomHeight||0,p=ge(o,d,r,u,e,g);n.push(p);const x=I(p,f,r,g),{position:v,normal:y,uv:m,indices:b}=p,w=b.length/3;_[i]=[a+1,a+w],a+=w;const O=v.length/3,S=y.length/3,j=m.length/2;M[i]={position:{middleZ:x+g[d]/2,count:O,start:c,end:c+3*O},normal:{count:S,start:h,end:h+3*S},uv:{count:j,start:l,end:l+2*j},hide:!1},c+=3*O,h+=3*S,l+=2*j}v=x(n),d&&(pe(v,f,d,M),i.vertexColors=o())}super(),this._initOptions(n),this._createMesh(v,i);const S=r.distanceToVector3(g,g).x,j=r.coordinateToVector3(u,S);this.getObject3d().position.copy(j),this._faceMap=_,this._baseObjects=y,this._datas=t,this._geometriesAttributes=M,this.faceIndex=null,this._geometryCache=v.clone(),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(y),p||(this._setPickObject3d(),this._init()),this.type="ExtrudePolygons"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=Object.assign({},this.options,Jt(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new we(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){return this.picked}}function We(t,e,n){const i=t.project(n),r=e.width/2,o=e.height/2;return{x:Math.round(i.x*r+r),y:Math.round(-i.y*o+o)}}var qe=Object.freeze({__proto__:null,vectors2Pixel:function(t,e,i,r=0,o){return t[0]instanceof n.Vector3||(t=function(t,e=0,i){const r=[],o={};for(let s=0,a=t.length;s<a;s+=3){let a=t[s],c=t[s+1],h=t[s+2];e>0&&(h+=k(e,i,o)),r.push(new n.Vector3(a,c,h))}return r}(t,r,o)),t.map((t=>We(t,e,i)))},vector2Pixel:We});const Ne={altitude:0,height:0,color:null},Ke=new n.Vector3;class Je extends p{constructor(t,i,o,s){i=e.Util.extend({},Ne,i,{layer:s,coordinate:t}),super();let{height:a,altitude:c,color:h,size:l}=i;const u=[],d=[];h&&(h=h instanceof n.Color?h:new n.Color(h),d.push(h.r,h.g,h.b));const f=s.distanceToVector3(a,a).x,g=s.coordinateToVector3(t,f);u.push(0,0,g.z);const p=new n.BufferGeometry;r(p,"position",new n.Float32BufferAttribute(u,3,!0)),d.length&&r(p,"color",new n.Float32BufferAttribute(d,3,!0)),void 0!==l&&r(p,"size",new n.Float32BufferAttribute([l],1,!0)),i.positions=g,this._initOptions(i),this._createPoints(p,o);const x=s.distanceToVector3(c,c).x,v=new n.Vector3(g.x,g.y,x);this.getObject3d().position.copy(v),this.type="Point"}identify(t){const e=this.getLayer(),n=this.getMap().getSize(),i=this.getLayer().getCamera(),r=this.getOptions().positions,o=this.getOptions().altitude;let s=this.getObject3d().material.size;void 0===s&&(s=this.options.size||1);const a=this.getMap().coordToContainerPoint(t),c=e.distanceToVector3(o,o).x;Ke.x=r.x,Ke.y=r.y,Ke.z=r.z+c;const h=We(Ke,n,i);return Math.sqrt(Math.pow(a.x-h.x,2)+Math.pow(a.y-h.y,2))<=s/2}}function Xe(t,e){const{minx:n,miny:i,maxx:r,maxy:o}=t,[s,a]=e;return n<=s&&s<=r&&i<=a&&a<=o}class Qe{constructor(t,e,n,i){this.minlng=t,this.minlat=e,this.maxlng=n,this.maxlat=i,this.minx=1/0,this.miny=1/0,this.maxx=-1/0,this.maxy=-1/0,this.coordinates=[],this.positions=[],this.indexs=[],this.key=null}updateBBoxPixel(t){let n=1/0,i=1/0,r=-1/0,o=-1/0;const{minlng:s,minlat:a,maxlng:c,maxlat:h}=this;return[[s,a],[s,h],[c,a],[c,h]].map((t=>new e.Coordinate(t))).map((e=>t.coordToContainerPoint(e))).forEach((t=>{n=Math.min(n,t.x),i=Math.min(i,t.y),r=Math.max(r,t.x),o=Math.max(o,t.y)})),this.minx=n,this.miny=i,this.maxx=r,this.maxy=o,this}containsCoordinate(t){let n,i;Array.isArray(t)?(n=t[0],i=t[1]):t instanceof e.Coordinate&&(n=t.x,i=t.y);const{minlng:r,minlat:o,maxlng:s,maxlat:a}=this;return r<=n&&n<=s&&o<=i&&i<=a}isRecCross(t,e){const{x:n,y:i}=t,r={minx:n-e/2,miny:i-e/2,maxx:n+e/2,maxy:i+e/2},{minx:o,miny:s,maxx:a,maxy:c}=r;return!!(Xe(this,[o,s])||Xe(this,[o,c])||Xe(this,[a,s])||Xe(this,[a,c])||Xe(r,[this.minx,this.miny])||Xe(r,[this.minx,this.maxy])||Xe(r,[this.maxx,this.miny])||Xe(r,[this.maxx,this.maxy]))}static initGrids(t,e,n,i){const r=[],o=(n-t)/30,s=(i-e)/30;let a=t,c=e;for(let n=0;n<30;n++){a=t+n*o;for(let t=0;t<30;t++){c=e+t*s;const i=new Qe(a,c,a+o,c+s);i.key=t+"-"+n,r.push(i)}}return{grids:r,averageX:o,averageY:s,ROWS:30,COLS:30}}}const Ye={altitude:0},$e=new n.Vector3;function tn(t,e){const n=Math.pow(10,e);return Math.round(t*n)/n}class en extends(Ee(p)){constructor(t,i,o,s){Array.isArray(t)||(t=[t]),i=e.Util.extend({},Ye,i,{layer:s,points:t});let a=1/0,c=1/0,h=-1/0,l=-1/0;for(let n=0,i=t.length;n<i;n++){const{coordinate:i}=t[n];let r,o;Array.isArray(i)?(r=i[0],o=i[1]):i instanceof e.Coordinate&&(r=i.x,o=i.y),t[n].coords=[r,o],a=Math.min(a,r),c=Math.min(c,o),h=Math.max(h,r),l=Math.max(l,o)}const u=s.coordinateToVector3([(a+h)/2,(c+l)/2]),{grids:d,averageX:f,averageY:g,ROWS:p,COLS:x}=Qe.initGrids(a,c,h,l),v=(d.length,new Float32Array(3*t.length)),y=[],m=new Float32Array(3*t.length),b=new Float32Array(t.length),_=[],w=[],M={};let O=0,S=!1,j=!1;const A=new n.Vector3(0,0,0);for(let e=0,i=t.length;e<i;e++){let{coordinate:i,height:r,color:o,size:h,coords:l}=t[e];const x=3*e;o&&(S=!0,o=o instanceof n.Color?o:new n.Color(o),m[x]=o.r,m[x+1]=o.g,m[x+2]=o.b),h&&(j=!0,b[e]=h,O=Math.max(O,h));const _=k(r,s,M),C=s.coordinateToVector3(i,_);A.x=C.x,A.y=C.y,A.z=C.z,A.sub(u),v[x]=A.x,v[x+1]=A.y,v[x+2]=A.z,y.push(C),w[e]={position:{count:1,start:3*e,end:3*e+3},hide:!1};let T=tn((l[1]-c)/g,4),L=tn((l[0]-a)/f,4);T-=1,L-=1,T=Math.max(0,T),L=Math.max(0,L),T=Math.ceil(T),L=Math.ceil(L);const B=L*p+T;d[B]&&(d[B].positions.push(C),d[B].indexs.push(e))}const C=new n.BufferGeometry;r(C,"position",new n.BufferAttribute(v,3,!0)),S&&r(C,"color",new n.BufferAttribute(m,3,!0)),j&&r(C,"size",new n.BufferAttribute(b,1,!0)),i.positions=y,super(),this._initOptions(i),this._createPoints(C,o);const T=i.altitude,L=s.distanceToVector3(T,T).x,B=u.clone();B.z=L,this.getObject3d().position.copy(B),this._baseObjects=_,this._datas=t,this.faceIndex=null,this._geometriesAttributes=w,this._geometryCache=C.clone(),this.isHide=!1,this._initBaseObjectsEvent(_),this._grids=d,this._bindMapEvents(),this.type="Points",this.maxSize=O}_bindMapEvents(){const t=this.getMap(),e="zoomstart zooming zoomend movestart moving moveend pitch rotate";this.on("add",(()=>{this._updateGrids(),t.on(e,this._updateGrids,this)})),this.on("remove",(()=>{t.off(e,this._updateGrids,this)}))}_updateGrids(){const t=this.getMap();this._grids.forEach((e=>{e.indexs.length&&e.updateBBoxPixel(t)}))}getSelectMesh(){const t=this.faceIndex;if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],{coordinate:n,height:i,color:r,size:o}=e;this._baseObjects[t]=new Je(n,{height:i,index:t,color:r,size:o},this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){const e=this.getLayer(),n=this.getMap().getSize(),i=this.getLayer().getCamera(),r=this.getOptions().altitude,o=this.getMap(),s=e.distanceToVector3(r,r).x;let a=this.getObject3d().material.size;const c=void 0===a,h=o.coordToContainerPoint(t),l=[];if(this._grids.forEach((t=>{t.indexs.length&&t.isRecCross(h,c?this.maxSize:a)&&l.push(t)})),l.length<1)return!1;for(let t=0,e=l.length;t<e;t++)for(let e=l[t].positions.length-1;e>=0;e--){c&&(a=this._datas[l[t].indexs[e]].size||1);const r=l[t].positions[e];$e.x=r.x,$e.y=r.y,$e.z=r.z+s;const o=We($e,n,i);if(Math.sqrt(Math.pow(h.x-o.x,2)+Math.pow(h.y-o.y,2))<=a/2)return this.faceIndex=l[t].indexs[e],!0}return!1}}const nn={coordinate:"",radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61"};class rn extends(Ee(p)){constructor(t,n,i,r){Array.isArray(t)||(t=[t]);const s=t.length,a=V(t),c=r.coordinateToVector3(a),h=[],l=[],u=[],d=[];let f=0,g=0,p=0,x=0;const v={};for(let n=0;n<s;n++){const s=e.Util.extend({index:n},nn,t[n]),{radius:a,radialSegments:y,altitude:m,topColor:b,bottomColor:_,height:w,coordinate:M}=s,O=k(a,r,v),S=k(w,r,v),j=k(m,r,v),A=C({radius:O,height:S,radialSegments:y});b&&(T(A,_,b,"z",S/2),i.vertexColors=o());const L=r.coordinateToVector3(M).sub(c),B=A.attributes.position.array;for(let t=0,e=B.length;t<e;t+=3)B[t+2]+=j,B[t]+=L.x,B[t+1]+=L.y,B[t+2]+=L.z;h.push(A);const z=new P(M,s,i,r);l.push(z);const V=A.index.count/3;d[n]=[f+1,f+V],f+=V;const I=A.attributes.position.count,U=A.attributes.normal.count,E=A.attributes.uv.count;u[n]={position:{count:I,start:g,end:g+3*I},normal:{count:U,start:p,end:p+3*U},uv:{count:E,start:x,end:x+2*E},hide:!1},g+=3*I,p+=3*U,x+=2*E}super(),n=e.Util.extend({},{altitude:0,layer:r,points:t},n),this._initOptions(n);const y=L(h);this._createMesh(y,i);const m=n.altitude,b=r.distanceToVector3(m,m).x,_=c.clone();_.z=b,this.getObject3d().position.copy(_),this._faceMap=d,this._baseObjects=l,this._datas=t,this._geometriesAttributes=u,this.faceIndex=null,this._geometryCache=y.clone(),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(l),this._setPickObject3d(),this._init(),this.type="Bars"}identify(){return this.picked}}const on={width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61"};class sn extends(Ee(p)){constructor(t,n,i,r){Array.isArray(t)||(t=[t]);const s=[],a=[],c=t.length;for(let e=0;e<c;e++){const n=se(t[e]);s.push(n.center),a.push(n.lineStrings)}const h=V(s);n=e.Util.extend({},on,n,{layer:r,lineStrings:t,coordinate:h});const{altitude:l,topColor:u,bottomColor:d,asynchronous:f}=n;let g;const p=[],y=[];if(f){var _=Ge();g=w(),_.pushQueue({type:"LineString",layer:r,key:n.key,center:h,data:a,lineStrings:t,callback:t=>{const{faceMap:e,geometriesAttributes:n}=t;this._faceMap=e,this._geometriesAttributes=n;const r=m(t);if(this._geometryCache=b(r),u&&(pe(r,d,u,n),i.vertexColors=o()),this.getObject3d().geometry=r,this.getObject3d().material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}})}else{const n=[];let s=0,l=[],f=0,p=0;const m={};for(let i=0;i<c;i++){const o=t[i],c=e.Util.extend({},on,Kt(o)?o.properties:o.getProperties(),{index:i}),{height:u,width:d,bottomHeight:g}=c,x=k(d,r,m),b=k(u,r,m),_=a[i],w=[];let M=0;for(let t=0,e=_.length;t<e;t++){const e=oe(_[t],x,b,r,h);M=I(e,g,r,m),w.push(e)}const O=v(w);n.push(O);const{position:S,normal:j,indices:A}=O,C=A.length/3;l[i]=[s+1,s+C],s+=C;const T=S.length/3,L=j.length/3;y[i]={position:{middleZ:M+b/2,count:T,start:f,end:f+3*T},normal:{count:L,start:p,end:p+3*L},hide:!1},f+=3*T,p+=3*L}g=x(n),u&&(pe(g,d,u,y),i.vertexColors=o())}super(),this._initOptions(n),this._createMesh(g,i);const M=r.distanceToVector3(l,l).x,O=r.coordinateToVector3(h,M);this.getObject3d().position.copy(O),this._faceMap=[],this._baseObjects=p,this._datas=t,this._geometriesAttributes=y,this.faceIndex=null,this._geometryCache=g.clone(),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(p),f||(this._setPickObject3d(),this._init()),this.type="ExtrudeLines"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=Object.assign({},this.options,Xt(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new be(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){return this.picked}}const an={altitude:0,colors:null};class cn extends(Ee(p)){constructor(t,i,o,s){Array.isArray(t)||(t=[t]);const a=[],c=[],h=t.length;for(let e=0;e<h;e++){const n=se(t[e]);a.push(n.center),c.push(n.lineStrings)}const l=V(a);i=e.Util.extend({},an,i,{layer:s,lineStrings:t,coordinate:l});const u=[],d={};let f=0,g=[],p=[],x=0,v=[];for(let t=0;t<h;t++){const e=c[t];let n=0;for(let t=0,i=e.length;t<i;t++){const i=Xt(e[t])?e[t].properties:e[t].getProperties()||{},{positionsV:r}=ie(e[t],s,l);I(r,i.bottomHeight,s,d),n+=2*r.length-2,ae(v,r)}const i=n;g[t]=[f,f+i],f+=i,p[t]={position:{count:n,start:x,end:x+3*n},hide:!1},x+=3*n}const y=new n.BufferGeometry;r(y,"position",new n.Float32BufferAttribute(v,3)),super(),this._initOptions(i),this._createLineSegments(y,o);const{altitude:m}=i,b=s.distanceToVector3(m,m).x,_=s.coordinateToVector3(l,b);this.getObject3d().position.copy(_),this._faceMap=g,this._baseObjects=u,this._datas=t,this._geometriesAttributes=p,this.faceIndex=null,this.index=null,this._geometryCache=y.clone(),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(u),this._setPickObject3d(),this._init(),this.type="Lines"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const n=this._datas[t],i=e.Util.extend({},this.getOptions(),{index:t},Xt(n)?n.properties:n.getProperties());this._baseObjects[t]=new le(n,i,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}_setPickObject3d(){const t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),{_geometriesAttributes:i}=this,s=i.length,a=U(i);let c=0;for(let t=0;t<s;t++){const n=e.getColor(),r=n.getHex();this._colorMap[r]=t;const{count:o}=i[t].position;this._datas[t].colorIndex=r;for(let t=0;t<o;t++)a[c]=n.r,a[c+1]=n.g,a[c+2]=n.b,c+=3}r(t,"color",new n.BufferAttribute(a,3,!0));const h=this.getObject3d().material.clone();h.color.set("#fff"),h.vertexColors=o();const l=e.getColor().getHex(),u=new n.LineSegments(t,h);u.position.copy(this.getObject3d().position),u._colorIndex=l,this.setPickObject3d(u)}identify(t){return this.picked}}const hn=[],ln=[];function un(){return{waitingQueue:hn,currentQueue:ln}}function dn(t,e){for(let n=0,i=t.length;n<i;n++){const i=t[n];if(i){const{key:r,callback:o}=i;if(e===r)return t.splice(n,1),o}}return null}const fn=document.createElement("canvas"),gn=256;function pn(t,e=!1){const n=fn.getContext("2d");if(n.clearRect(0,0,gn,gn),n.save(),e){n.fillStyle="red",n.strokeStyle="rgba(255,0,0,0.4)",n.lineWidth=.2;const e=t||"tile";n.font="18px sans-serif",n.rect(0,0,gn,gn),n.stroke(),n.fillText(e,15,128)}return fn.toDataURL()}function xn(t=1,e=1){let n;return"undefined"==typeof document||(n=document.createElement("canvas"),t&&(n.width=t),e&&(n.height=e)),n}fn.width=fn.height=gn;class vn extends e.TileLayer{constructor(t,n={}){super(e.Util.GUID(),e.Util.extend({urlTemplate:t},n)),this._opts=null,this._layer=null,this.material=null,this.getMaterial=null,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._layerLaodTime=(new Date).getTime()}isAsynchronous(){return this._opts.worker}getBaseObjects(){const t=this._loadTiles,e=[];for(let n in t){const t=this._baseObjectKeys[n];if(t&&Array.isArray(t)&&t.length)for(let n=0,i=t.length;n<i;n++)e.push(t[n])}return e}onSelectMesh(t,e){}formatBaseObjects(t,e){return[]}loopMessage(t){}getTileData(t){const{key:n,url:i,callback:r,img:o}=t;e.Ajax.getJSON(i,{},(function(t,e){t?(console.error(t),r(n,null,o)):r(n,e,o)}))}_getCurentTileKeys(){const t=this.getTiles().tileGrids||[],e=[],n={};for(let i=0,r=t.length;i<r;i++){const r=t[i].tiles||[];for(let t=0,i=r.length;t<i;t++){const{id:i}=r[t];e.push(i),n[i]=!0}}return{keys:e,keysMap:n}}_isLoad(){const{keys:t}=this._getCurentTileKeys(),e=Object.keys(this._renderer.tilesInView);return t.length===e.length}_layerOnLoad(){const t=(new Date).getTime();if(t-this._layerLaodTime<20)return;this._layerLaodTime=t;const e=this._renderer.tilesInView,n=this._loadTiles,i=this._layer,r=this._baseObjectKeys,o=Object.keys(e).length,s=Object.keys(n).length,a=[];if(o&&s)for(let t in n)e[t]||r[t]&&(r[t]||[]).forEach((t=>{a.push(t)}));if(a.length&&i.removeMesh(a,!1),o&&s)for(let t in e)if(!n[t])if(r[t]){const e=r[t];i.addMesh(e)}else{const{x:e,y:n,z:i}=this._getXYZOfIndex(t);this.getTileUrl(e,n,i)}this._loadTiles=Object.assign({},e),this._diffCache()}_init(){}_workerLoad(t){const e=t.target._img;e.currentCount++,e.currentCount===e.needCount&&(e.src=pn(e._key,this._opts.debug))}_generateBaseObjects(t,e,n){if(e&&n){const{keysMap:i}=this._getCurentTileKeys();if(!i[t])return void(n.src=pn(t,this._opts.debug));const r=this.formatBaseObjects(t,e);if(r.length){n.needCount=r.length,n.currentCount=0;for(let e=0,i=r.length;e<i;e++){const i=r[e];i._img=n,i._vt=this,this.isVisible()||i.hide(),this._cachetile(t,i),i.isAsynchronous()||n.currentCount++}this._layer.addMesh(r,!1),n.needCount===n.currentCount&&(n.src=pn(t,this._opts.debug)),this.isAsynchronous()?r.filter((t=>t.isAsynchronous())).forEach((t=>{t.on("workerload",this._workerLoad,this)})):n.src=pn(t,this._opts.debug)}else n.src=pn(t,this._opts.debug);this._loadTiles[t]=!0}else n&&(n.src=pn(t,this._opts.debug))}_diffCache(){if(Object.keys(this._baseObjectKeys).length>this._renderer.tileCache.max){const t=this._renderer.tileCache.data,e=this._renderer.tilesInView,n=[];for(let i in this._baseObjectKeys)t[i]||e[i]||((this._baseObjectKeys[i]||[]).forEach((t=>{t.isAdd&&n.push(t)})),this._diposeBaseObject(i),delete this._baseObjectKeys[i]);n.length&&this._layer.removeMesh(n,!1)}}_diposeBaseObject(t){const e=this._baseObjectKeys[t];e&&e.length&&e.forEach((t=>{t.getObject3d().geometry.dispose(),t._geometryCache&&t._geometryCache.dispose();const e=t._baseObjects;e&&e.length&&e.forEach((t=>{t.getObject3d().geometry.dispose(),t=null})),t._datas=null,t._geometriesAttributes=null,t._faceMap=null,t._colorMap=null,t.pickObject3d&&t.pickObject3d.geometry.dispose(),t=null}))}_cachetile(t,e){this._baseObjectKeys[t]||(this._baseObjectKeys[t]=[]),this._baseObjectKeys[t].push(e)}_getXYZOfIndex(t){const e=t.indexOf("_")>-1?"_":"-";let[n,i,r]=t.split(e).slice(1,4);return{x:parseInt(i),y:parseInt(n),z:parseInt(r)}}_getTileExtent(t,e,n){const i=this.getMap()._getResolution(n);return this._getTileConfig().getTilePrjExtent(t,e,i)}_getTileLngLatExtent(t,n,i){const r=this._getTileExtent(t,n,i);let o=r.getMax(),s=r.getMin();const a=this.getMap().getProjection();return s=a.unproject(s),o=a.unproject(o),new e.Extent(s,o)}}const yn={worker:!1};class mn extends vn{constructor(t,n={},i,r){super(e.Util.GUID(),e.Util.extend({urlTemplate:t},yn,n)),this._opts=n,this._layer=r,this.getMaterial=i,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._layerLaodTime=(new Date).getTime(),this._init()}formatBaseObjects(t,i){const r=this._opts,o=[],s=this.isAsynchronous();for(let a in i){const c=i[a]||{};let h;if(Array.isArray(c)?h=c:"FeatureCollection"===c.type&&(h=c.features),h&&h.length){const i=[],l=[],u=[];for(let t=0,n=h.length;t<n;t++){const n=h[t];if(Jt(n))i.push(n);else if(Xt(n)){const t=ee(n);for(let e=0,n=t.length;e<n;e++)l.push(t[e])}else if(Qt(n)){const t=ee(n);for(let n=0,i=t.length;n<i;n++)u.push(e.Util.extend({},t[n].properties,t[n],{coordinate:$t(t[n])}))}}if(i.length){const n=this._getMaterial(a,i,t,c);if(n){const c=this._layer.toExtrudePolygons(i,e.Util.extend({},{topColor:"#fff",layerName:a,asynchronous:s,key:t},r),n);o.push(c)}}if(l.length){const i=this._getMaterial(a,l,t,c);if(i&&(i instanceof n.LineBasicMaterial||i instanceof n.LineDashedMaterial)){const t=this._layer.toLines(l,e.Util.extend({},{layerName:a},r),i);o.push(t)}}if(u.length){const i=this._getMaterial(a,u,t,c);if(i&&i instanceof n.PointsMaterial){const t=this._layer.toPoints(u,e.Util.extend({},{layerName:a},r),i);o.push(t)}}}}return o}loopMessage(t){const{currentQueue:e}=un();e.length>0&&this.getTileData(t)}_init(){this.on("layerload",this._layerOnLoad),this.on("add",(()=>{if(!1===this._add){const t=this.getBaseObjects();this._layer.addMesh(t)}this._add=!0,this.intervalId=setInterval((()=>{this._isLoad()&&!this._layer.getMap().isInteracting()&&this.fire("layerload")}),1e3)})),this.on("remove",(()=>{this._add=!1;const t=this.getBaseObjects();this._layer.removeMesh(t),clearInterval(this.intervalId)})),this.on("show",(()=>{this.getBaseObjects().forEach((t=>{t.show()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.show()}))}})),this.on("hide",(()=>{this.getBaseObjects().forEach((t=>{t.hide()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.hide()}))}})),this.on("renderercreate",(t=>{t.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e.width,n.height=e.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t.id),n},t.renderer.deleteTile=function(t){if(!t||!t.image)return;t.image.onload=null,t.image.onerror=null;!function(t){const e=dn(hn,t);e&&e(t)}((t.info||{}).id)},t.renderer.loadTileImage=(t,e,n)=>{t._key=n,function(t,e,n,i,r){const o={key:t,url:e,callback:n,img:i,vt:r};ln.length<10?(ln.push(o),r.loopMessage(o)):hn.push(o)}(n,e,((t,e,n)=>{this._generateBaseObjects(t,e,n),function(t,e){if(dn(ln,t),hn.length){ln.push(hn[0]),hn.splice(0,1);const t=ln[ln.length-1];e.loopMessage(t)}}(t,this)}),t,this)}}))}_getMaterial(t,n,i,r){return this.getMaterial&&e.Util.isFunction(this.getMaterial)?this.getMaterial(t,n,i,r):null}}function bn(t,e,i,o){const{position:s,uv:a,normal:c,indexs:h}=function(t,e,n,i){const r=t/n,o=e/i,s=-t/2,a=e/2,c=-e/2,h=(n+1)*(i+1),l=new Float32Array(3*h),u=new Float32Array(2*h),d=new Float32Array(3*h),f=new Uint32Array(10*h);let g=0,p=0,x=0;for(let h=0;h<=i;h++)for(let v=0;v<=n;v++){const y=s+r*v,m=a-o*h;l[g]=y,l[g+1]=m,l[g+2]=0,d[g]=0,d[g+1]=0,d[g+2]=1;const b=(y-s)/t,_=(m-c)/e;if(u[p]=b,u[p+1]=_,g+=3,p+=2,v<n&&h<i){const t=h*(n+1)+v,e=t+1,i=(n+1)*(h+1)+v,r=i+1;f[x]=t,f[x+1]=i,f[x+2]=e,f[x+3]=i,f[x+4]=r,f[x+5]=e,x+=6}}const v=new Uint32Array(x);for(let t=0,e=v.length;t<e;t++)v[t]=f[t];return{position:l,uv:u,normal:d,indexs:v}}(t,e,i,o),l=new n.BufferGeometry;return r(l,"position",new n.BufferAttribute(s,3)),r(l,"normal",new n.BufferAttribute(c,3)),r(l,"uv",new n.BufferAttribute(a,2)),l.setIndex(new n.BufferAttribute(h,1)),l}const _n=new n.TextureLoader,wn=document.createElement("canvas");function Mn(t){if(!t)return null;let e;return"string"==typeof t?(e=new Image,e.src=t):t instanceof HTMLCanvasElement?(e=new Image,e.src=t.toDataURL()):t instanceof Image&&(e=new Image,e.src=t.src,e.crossOrigin=t.crossOrigin),e&&!e.crossOrigin&&(e.crossOrigin="Anonymous"),e}const On={interactive:!1,altitude:0,image:null,imageWidth:256,imageHeight:256,texture:null};class Sn extends p{constructor(t,n,i,r){n=e.Util.extend({},On,n,{layer:r,extent:t});const{texture:o,image:s,altitude:a,imageHeight:c,imageWidth:h}=n;s||console.error("not find image"),t instanceof e.Extent||(t=new e.Extent(t));const{xmin:l,ymin:u,xmax:d,ymax:f}=t;let g=1/0,p=1/0,x=-1/0,v=-1/0;[[l,u],[l,f],[d,f],[d,u]].forEach((t=>{const e=r.coordinateToVector3(t),{x:n,y:i}=e;g=Math.min(n,g),p=Math.min(i,p),x=Math.max(n,x),v=Math.max(i,v)}));const y=Math.abs(x-g),m=Math.abs(v-p),b=Mn(s),_=Mn(o),w=bn(y,m,h-1,c-1);super(),this._initOptions(n),this._createMesh(w,i);const M=r.distanceToVector3(a,a).x,O=r.coordinateToVector3(t.getCenter(),M);this.getObject3d().position.copy(O),i.transparent=!0,b&&(i.opacity=0,b.onload=()=>{const t=function(t,e=256,n=256){wn.width=e,wn.height=n;const i=wn.getContext("2d");return i.drawImage(t,0,0,e,n),i.getImageData(0,0,e,n).data}(b,h,c);let e=0;const n={};for(let i=0,o=t.length;i<o;i+=4){const o=k(.1*(256*t[i]*256+256*t[i+1]+t[i+2])-1e4,r,n);w.attributes.position.array[3*e+2]=o,e++}w.attributes.position.needsUpdate=!0,_?_n.load(_.src,(t=>{i.map=t,i.opacity=1,i.needsUpdate=!0})):i.opacity=1},b.onerror=function(){console.error(`not load ${b.src}`)}),this.type="Terrain"}}const jn={scale:1,tileDivisor:4};class An extends vn{constructor(t,n={},i,r){super(e.Util.GUID(),e.Util.extend({urlTemplate:t},jn,n)),this._opts=n,this._layer=r,this.material=i,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._imgQueue={},this._layerLaodTime=(new Date).getTime(),this._init()}isAsynchronous(){return!1}formatBaseObjects(t,e){const n=this.options,i=[],{scale:r,tileDivisor:o}=n,{x:s,y:a,z:c}=this._getXYZOfIndex(t),h=this.getMap().getZoom(),l=this.getTileUrl(s,a,c),[u,d]=this.options.tileSize,f=this._getTileLngLatExtent(s,a,c),g=this.material.clone();if(c+1>=Math.round(h)){const t=new Sn(f,{image:e,imageWidth:u/o,imageHeight:d/o,texture:l},g,this._layer);t.getObject3d().scale.set(r,r,1),i.push(t)}return i}loopMessage(t){this.getTileData(t)}_init(){this.on("layerload",this._layerOnLoad),this.on("add",(()=>{if(!1===this._add){const t=this.getBaseObjects();this._layer.addMesh(t)}this._add=!0,this.intervalId=setInterval((()=>{this._isLoad()&&!this._layer.getMap().isInteracting()&&this.fire("layerload")}),1e3)})),this.on("remove",(()=>{this._add=!1;const t=this.getBaseObjects();this._layer.removeMesh(t),clearInterval(this.intervalId)})),this.on("show",(()=>{this.getBaseObjects().forEach((t=>{t.show()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.show()}))}})),this.on("hide",(()=>{this.getBaseObjects().forEach((t=>{t.hide()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.hide()}))}})),this.on("renderercreate",(t=>{t.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e.width,n.height=e.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t.id),n},t.renderer.deleteTile=t=>{if(!t||!t.image)return;t.image.onload=null,t.image.onerror=null;const e=t.info||{},n=this._imgQueue[e.id];n&&(n.src="",n.onload=null,n.onerror=null,delete this._imgQueue[e.id])},t.renderer.loadTileImage=(t,e,n)=>{t._key=n;const i=new Image;this._imgQueue[n]=i;const r={key:n,url:e,rgbImage:i,callback:(t,e,n)=>{this._generateBaseObjects(t,e,n)},img:t,vt:this};this.loopMessage(r)}}))}}
/*!
     * Code from baidu mapv
     * License: BSD-3
     * https://github.com/huiyan-fe/mapv
     *
     */function Cn(t){t=t||{},this.gradient=t.gradient||{.25:"rgba(0, 0, 255, 1)",.55:"rgba(0, 255, 0, 1)",.85:"rgba(255, 255, 0, 1)",1:"rgba(255, 0, 0, 1)"},this.maxSize=t.maxSize||35,this.minSize=t.minSize||0,this.max=t.max||100,this.min=t.min||0,this.initPalette()}function Tn(t,e,n){var i=Ln(n),r=function(t){return t.min||0}(n),o=i-r,s=n.range||null,a=0,c=1024;s&&2===s.length&&(a=(s[0]-r)/o*1024),s&&2===s.length&&(c=(s[1]-r)/o*1024);for(var h,l=n.maxOpacity||.8,u=n.minOpacity||0,d=3,f=t.length;d<f;d+=4)h=4*t[d],t[d]/256>l&&(t[d]=256*l),t[d]/256<u&&(t[d]=256*u),h&&h>=a&&h<=c?(t[d-3]=e[h],t[d-2]=e[h+1],t[d-1]=e[h+2]):t[d]=0}function Ln(t){return t.max||100}function Bn(t,e,n){var i=Ln(n),r=
/*!
     * Code from baidu mapv
     * License: BSD-3
     * https://github.com/huiyan-fe/mapv
     *
     */
function(t){var e=t/2,n=t+e,i=1e4,r=xn(2*n,2*n),o=r.getContext("2d");return o.shadowBlur=e,o.shadowColor="black",o.shadowOffsetX=o.shadowOffsetY=i,o.beginPath(),o.arc(n-i,n-i,t,0,2*Math.PI,!0),o.closePath(),o.fill(),r}(n._size||n.size||13),o=r.width/2,s=r.height/2,a=e,c={};for(var h in a.forEach((function(t){var e=void 0===t.count?1:t.count,n=Math.min(1,e/i).toFixed(2);c[n]=c[n]||[],c[n].push(t)})),c)if(!isNaN(h)){var l=c[h];t.beginPath(),n.withoutAlpha||(t.globalAlpha=h),l.forEach((function(e){var n=e.coordinate,a=void 0===e.count?1:e.count;t.globalAlpha=a/i,t.drawImage(r,n[0]-o,n[1]-s)}))}}Cn.prototype.setMax=function(t){this.max=t||100},Cn.prototype.setMin=function(t){this.min=t||0},Cn.prototype.setMaxSize=function(t){this.maxSize=t||35},Cn.prototype.setMinSize=function(t){this.minSize=t||0},Cn.prototype.initPalette=function(){var t=this.gradient,e=xn(256,1),n=this.paletteCtx=e.getContext("2d"),i=n.createLinearGradient(0,0,256,1);for(var r in t)i.addColorStop(parseFloat(r),t[r]);n.fillStyle=i,n.fillRect(0,0,256,1)},Cn.prototype.getColor=function(t){var e=this.getImageData(t);return"rgba("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]/256+")"},Cn.prototype.getImageData=function(t){var e=this.paletteCtx.getImageData(0,0,256,1).data;if(void 0===t)return e;var n=this.max,i=this.min;t>n&&(t=n),t<i&&(t=i);var r=4*Math.floor((t-i)/(n-i)*255);return[e[r],e[r+1],e[r+2],e[r+3]]},Cn.prototype.getSize=function(t){var e=this.max,n=this.min,i=this.maxSize,r=this.minSize;return t>e&&(t=e),t<n&&(t=n),e>n?r+(t-n)/(e-n)*(i-r):i},Cn.prototype.getLegend=function(t){var e=this.gradient,n=t.width||20,i=t.height||180,r=xn(n,i),o=r.getContext("2d"),s=o.createLinearGradient(0,i,0,0);for(var a in e)s.addColorStop(parseFloat(a),e[a]);return o.fillStyle=s,o.fillRect(0,0,n,i),r};var zn={draw:function(t,e,n){if(!(t.canvas.width<=0||t.canvas.height<=0)){var i=n.strength||.3;t.strokeStyle="rgba(0,0,0,"+i+")";var r=xn(t.canvas.width,t.canvas.height),o=r.getContext("2d");o.scale(devicePixelRatio,devicePixelRatio),n=n||{},t.save();var s=new Cn({gradient:n.gradient});if(Bn(o,e,n),!n.absolute){var a=o.getImageData(0,0,t.canvas.width,t.canvas.height);Tn(a.data,s.getImageData(),n),t.putImageData(a,0,0),t.restore()}s=null,r=null}},drawGray:Bn,colorize:Tn};const Pn={altitude:0,interactive:!1,min:0,max:100,size:13,gradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},gridScale:.5},kn=2048;class Vn extends p{constructor(t,i,s,a){Array.isArray(t)||(t=[t]);let c=1/0,h=1/0,l=-1/0,u=-1/0;const d=[];for(let e=0,n=t.length;e<n;e++){const{coordinate:n,lnglat:i,xy:r}=t[e],o=n||i||r;if(!o){console.warn("not find coordinate");continue}const s=a.coordinateToVector3(o);d.push(s);const{x:f,y:g}=s;c=Math.min(c,f),h=Math.min(h,g),l=Math.max(l,f),u=Math.max(u,g)}i=e.Util.extend({},Pn,i,{layer:a,points:t});let{gridScale:f,altitude:g}=i;const p=Math.abs(l-c),x=Math.abs(u-h),v=Math.max(p*f,x*f);if(v>kn){console.warn(`gridScale: ${f} it's too big. I hope it's a smaller value,canvas max size is 2048* 2048`);f=kn/(v/f)}const y=Math.ceil(p*f),m=Math.ceil(x*f),b=y/p,_=m/x,w=[];for(let e=0,n=d.length;e<n;e++){const n=d[e];n.x-=c,n.y-=h,n.x*=b,n.y*=_,n.y=m-n.y,w.push({coordinate:[n.x,n.y],count:t[e].count})}let M=xn(y,m),O=M.getContext("2d");zn.drawGray(O,w,i);const S=O.getImageData(0,0,O.canvas.width,O.canvas.height);let j=-1/0;const A=new Float32Array(S.data.length/4),C=new Float32Array(S.data.length/4);for(let t=3,e=S.data.length,n=0;t<e;t+=4){const e=S.data[t];j=Math.max(j,e),C[n]=e,e<=0&&(A[n]=1),n++}const T=new Cn({gradient:i.gradient});zn.colorize(S.data,T.getImageData(),i),M=null,O=null;const L=bn(p,x,y-1,m-1),B=L.getIndex().array,z=L.attributes.position.array,P=new Float32Array(z.length),k=new Uint32Array(6*z.length),V=new n.Color;let I=0;for(let t=0,e=z.length,n=0,i=B.length,r=0,o=S.data.length,s=0;t<Math.max(e,i,o);t+=3){if(t<e){const e=C[s];e>0&&(z[t+2]=e/j)}if(n<i){const t=B[n],e=B[n+1],i=B[n+2];A[t]&&A[e]&&A[i]||(k[I]=t,k[I+1]=e,k[I+2]=i,I+=3)}if(r<o){const t=`rgb(${S.data[r]},${S.data[r+1]},${S.data[r+2]})`;V.setStyle(t),P[n]=V.r,P[n+1]=V.g,P[n+2]=V.b}n+=3,r+=4,s++}const U=new Uint32Array(I);for(let t=0;t<I;t++)U[t]=k[t];L.setIndex(new n.BufferAttribute(U,1)),r(L,"color",new n.BufferAttribute(P,3,!0)),s.vertexColors=o(),super(),this._initOptions(i),this._createMesh(L,s);const E=a.distanceToVector3(g,g).x;this.getObject3d().position.copy(new n.Vector3((c+l)/2,(h+u)/2,E)),this.type="HeatMap"}}const In=new n.Color;let Un=1;class En{constructor(t){this.object3ds=[],this.layer=t,this.camera=t.getCamera(),this.renderer=t.getThreeRenderer(),this.pickingTexture=new n.WebGLRenderTarget(1,1),this.pickingScene=new n.Scene}getColor(){return In.setHex(Un),Un++,In}add(t){if(t){const e=t._colorIndex;e&&(this.object3ds[e]=t,this.pickingScene.add(t))}return this}remove(t){if(t){const e=t._colorIndex;e&&(this.object3ds[e]=null,this.pickingScene.remove(t))}return this}isEmpty(){if(0===this.pickingScene.children.length)return!0;for(let t=0,e=this.pickingScene.children.length;t<e;t++){const e=this.pickingScene.children[t];if(e){const t=e.__parent;if(t&&!0===t.getOptions().interactive)return!1}}return!0}pick(t){if(!t)return;if(this.isEmpty())return;const{camera:e,renderer:n,pickingTexture:i,pickingScene:r,object3ds:o,layer:s}=this,a=this.pickingScene.children.length;for(let t=0;t<a;t++){const e=this.pickingScene.children[t];e&&e.__parent&&(e.__parent.picked=!1)}const{width:c,height:h}=s._getRenderer().canvas,l=i.width,u=i.height;c===l&&h===u||i.setSize(c,h),n.setRenderTarget(i),n.clear(),n.render(r,e);const d=new Uint8Array(4),{x:f,y:g}=t,p=window.devicePixelRatio,x=f*p,v=i.height-g*p;n.readRenderTargetPixels(i,Math.round(x),Math.round(v),1,1,d);const y=d[0]<<16|d[1]<<8|d[2],m=o[y];if(m)m.__parent&&(o[y].__parent.picked=!0);else for(let t=0;t<a;t++){const e=this.pickingScene.children[t];if(e&&e.__parent){const t=e.__parent;if(t._colorMap&&null!=t._colorMap[y]){t.picked=!0,t.index=t._colorMap[y];break}}}n.setRenderTarget(null)}}const Rn={bottomHeight:0,altitude:0};class Zn extends p{constructor(t,n,i,r){n=e.Util.extend({},Rn,n,{layer:r,lineString:t}),super(),this._initOptions(n);const{lineStrings:o,center:s}=se(t),a=[],c={};for(let t=0,e=o.length;t<e;t++){const e=ie(o[t],r,s).positionsV;I(e,n.bottomHeight,r,c),ae(a,e)}const h=new u;h.setPositions(a),this._setMaterialRes(r,i),this._createLine2(h,i);const{altitude:l}=n,d=r.distanceToVector3(l,l).x,f=r.coordinateToVector3(s,d);this.getObject3d().position.copy(f),this._setPickObject3d(a,i.linewidth),this._init(),this.type="FatLine"}_init(){const t=this.getLayer().getPick();this.on("add",(()=>{t.add(this.pickObject3d)})),this.on("remove",(()=>{t.remove(this.pickObject3d)}))}_setMaterialRes(t,e){const n=t.getMap().getSize(),i=n.width,r=n.height;e.resolution.set(i,r)}_setPickObject3d(t,e){const n=new u;n.setPositions(t);const i=this.getLayer().getPick().getColor(),r=[];for(let e=0,n=t.length/3;e<n;e++)r.push(i.r,i.g,i.b);n.setColors(r);const s=new h({color:"#fff",linewidth:e,vertexColors:o()});this._setMaterialRes(this.getLayer(),s);const a=i.getHex(),c=new d(n,s);c.position.copy(this.getObject3d().position),c._colorIndex=a,this.setPickObject3d(c)}identify(t){return this.picked}setSymbol(t){if(t&&t instanceof n.Material){t.needsUpdate=!0;const e=this.getMap().getSize(),n=e.width,i=e.height;t.resolution.set(n,i),this.getObject3d().material=t}return this}}const Gn={altitude:0,colors:null};class Fn extends(Ee(p)){constructor(t,n,i,r){Array.isArray(t)||(t=[t]);const o=[],s=[],a=t.length;for(let e=0;e<a;e++){const n=se(t[e]);o.push(n.center),s.push(n.lineStrings)}const c=V(o);n=e.Util.extend({},Gn,n,{layer:r,lineStrings:t,coordinate:c});const h=[],l={};let d=0,f=[],g=[],p=0,x=[];for(let t=0;t<a;t++){const e=s[t];let n=0;for(let t=0,i=e.length;t<i;t++){const i=Xt(e[t])?e[t].properties:e[t].getProperties()||{},{positionsV:o}=ie(e[t],r,c);I(o,i.bottomHeight,r,l),n+=2*o.length-2,ae(x,o)}const i=n;f[t]=[d,d+i],d+=i,g[t]={position:{count:n,start:p,end:p+3*n},instanceStart:{count:n,start:p,end:p+3*n},instanceEnd:{count:n,start:p,end:p+3*n},hide:!1},p+=3*n}super(),this._initOptions(n);const v=new u;v.setPositions(x),this._setMaterialRes(r,i),this._createLine2(v,i);const{altitude:y}=n,m=r.distanceToVector3(y,y).x,b=r.coordinateToVector3(c,m);this.getObject3d().position.copy(b),this._faceMap=f,this._baseObjects=h,this._datas=t,this._geometriesAttributes=g,this.faceIndex=null,this.index=null,this._geometryCache=new u,this._geometryCache.setPositions(x),this._colorMap={},this.isHide=!1,this._initBaseObjectsEvent(h),this._setPickObject3d(x,i.linewidth),this._init(),this.type="FatLines"}_setMaterialRes(t,e){const n=t.getMap().getSize(),i=n.width,r=n.height;e.resolution.set(i,r)}_setPickObject3d(t,e){const n=this._geometryCache||new u;n.setPositions(t);const i=this.getLayer().getPick(),{_geometriesAttributes:r}=this,s=U(r);let a=0;for(let t=0,e=r.length;t<e;t++){const e=i.getColor(),n=e.getHex();this._colorMap[n]=t;const{count:o}=r[t].position;this._datas[t].colorIndex=n;for(let t=0;t<o;t++)s[a]=e.r,s[a+1]=e.g,s[a+2]=e.b,a+=3}n.setColors(s);const c=new h({color:"#fff",linewidth:e,vertexColors:o()});this._setMaterialRes(this.getLayer(),c);const l=i.getColor().getHex(),f=new d(n,c);f.position.copy(this.getObject3d().position),f._colorIndex=l,this.setPickObject3d(f)}identify(t){return this.picked}setSymbol(t){if(t&&t instanceof n.Material){t.needsUpdate=!0;const e=this.getMap().getSize(),n=e.width,i=e.height;t.resolution.set(n,i),this.getObject3d().material=t}return this}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const n=this._datas[t],i=e.Util.extend({},this.getOptions(),{index:t},Xt(n)?n.properties:n.getProperties());this._baseObjects[t]=new Zn(n,i,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}_updateAttribute(t,e){const{indexs:n}=this._getHideGeometryIndex(e),i=this._geometryCache.attributes[e].array,r=i.length;for(let e=0;e<r;e++)t.array[e]=i[e];for(let i=0;i<n.length;i++){const r=n[i],{start:o,end:s}=this._geometriesAttributes[r][e];for(let e=o;e<s;e++)t.array[e]=-1e5}return this}_showGeometry(t,e){let n;if(t&&(n=t.getOptions().index),null!=n){const t=this._geometriesAttributes[n],{hide:i}=t;if(i===e)return this;t.hide=e;const r=this.getObject3d().geometry;this._updateAttribute(r.attributes.instanceStart,"instanceStart"),this._updateAttribute(r.attributes.instanceEnd,"instanceEnd"),r.attributes.instanceStart.data.needsUpdate=!0,r.attributes.instanceEnd.data.needsUpdate=!0,this.isHide=e}return this}}const Dn={radius:10,height:100,altitude:0,topColor:"",bottomColor:"#2d2f61"};class Hn extends p{constructor(t,n,i,r){n=e.Util.extend({},Dn,n,{layer:r,coordinate:t}),super(),this._initOptions(n);const{height:s,radius:a,topColor:c,bottomColor:h,altitude:l}=n,u=r.distanceToVector3(s,s).x,d=r.distanceToVector3(a,a).x,f=B().clone();f.scale(2*d,2*d,u),c&&(T(f,h,c,"z",u/2),i.vertexColors=o()),this._createMesh(f,i);const g=r.distanceToVector3(l,l).x,p=r.coordinateToVector3(t,g);this.getObject3d().position.copy(p),this.type="Box"}}const Wn={radius:10,height:100,altitude:0,topColor:null,bottomColor:"#2d2f61"};class qn extends(Ee(p)){constructor(t,n,i,r){Array.isArray(t)||(t=[t]);const s=t.length,a=V(t),c=r.coordinateToVector3(a),h=[],l=[],u=[],d=[];let f=0,g=0,p=0,x=0;const v={};for(let n=0;n<s;n++){const s=e.Util.extend({index:n},Wn,t[n]),{radius:a,altitude:y,topColor:m,bottomColor:b,height:_,coordinate:w}=s,M=k(a,r,v),O=k(_,r,v),S=k(y,r,v),j=B().clone();j.scale(2*M,2*M,O),m&&(T(j,b,m,"z",O/2),i.vertexColors=o());const A=r.coordinateToVector3(w).sub(c),C=j.attributes.position.array;for(let t=0,e=C.length;t<e;t+=3)C[t+2]+=S,C[t]+=A.x,C[t+1]+=A.y,C[t+2]+=A.z;h.push(j);const L=new Hn(w,s,i,r);l.push(L);const z=j.index.count/3;d[n]=[f+1,f+z],f+=z;const P=j.attributes.position.count,V=j.attributes.normal.count,I=j.attributes.uv.count;u[n]={position:{count:P,start:g,end:g+3*P},normal:{count:V,start:p,end:p+3*V},uv:{count:I,start:x,end:x+2*I},hide:!1},g+=3*P,p+=3*V,x+=2*I}super(),n=e.Util.extend({},{altitude:0,layer:r,points:t},n),this._initOptions(n);const y=L(h);this._createMesh(y,i);const m=n.altitude,b=r.distanceToVector3(m,m).x,_=c.clone();_.z=b,this.getObject3d().position.copy(_),this._faceMap=d,this._baseObjects=l,this._datas=t,this._geometriesAttributes=u,this.faceIndex=null,this._geometryCache=y.clone(),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(l),this._setPickObject3d(),this._init(),this.type="Boxs"}identify(t){return this.picked}}const Nn=Math.PI/180,Kn=[[4e3,220],[2e3,100],[1e3,30],[500,15],[100,5],[50,2],[10,1],[5,.7],[2,.1],[1,.05],[.5,.02]],Jn=["mousemove","click","mousedown","mouseup","dblclick","contextmenu","touchstart","touchmove","touchend"],Xn=new e.Coordinate(0,0),Qn=new e.Point(0,0);class Yn extends e.CanvasLayer{constructor(t,e){super(t,e),this._animationBaseObjectMap={},this._needsUpdate=!0,this._mousemoveTimeOut=0,this._baseObjects=[],this._delayMeshes=[],this.type="ThreeLayer"}isRendering(){const t=this.getMap();return!!t&&(t.isInteracting()||t.isAnimating())}prepareToDraw(...t){}draw(){this.renderScene()}drawOnInteracting(){this.renderScene()}coordinateToVector3(t,i=0){const r=this.getMap();if(!r)return null;const o=Array.isArray(t);o&&(Xn.x=t[0],Xn.y=t[1]),o||t instanceof e.Coordinate||(t=new e.Coordinate(t));const s=ti(r),a=ei(r,o?Xn:t,s,Qn);return new n.Vector3(a.x,a.y,i)}distanceToVector3(t,i,r){if(0===t&&0===i||!e.Util.isNumber(t)||!e.Util.isNumber(i))return new n.Vector3(0,0,0);const o=this.getMap(),s=ti(o);let a=r||o.getCenter();a instanceof e.Coordinate||(a=new e.Coordinate(a));const c=o.locate(a,t,i),h=ei(o,a,s),l=ei(o,c,s),u=Math.abs(l.x-h.x)*e.Util.sign(t),d=Math.abs(l.y-h.y)*e.Util.sign(i);return new n.Vector3(u,d,0)}toShape(t){if(!t)return null;if(t instanceof e.MultiPolygon)return t.getGeometries().map((t=>this.toShape(t)));const i=t.getCenter(),r=this.coordinateToVector3(i),o=t.getShell().map((t=>{const e=this.coordinateToVector3(t).sub(r);return new n.Vector2(e.x,e.y)})),s=new n.Shape(o),a=t.getHoles();return a&&a.length>0&&(s.holes=a.map((t=>{const e=t.map((t=>{const e=this.coordinateToVector3(t).sub(r);return new n.Vector2(e.x,e.y)}));return new n.Shape(e)}))),s}toExtrudeMesh(t,i,r,o){if(!t)return null;if(t instanceof e.MultiPolygon)return t.getGeometries().map((t=>this.toExtrudeMesh(t,i,r,o)));const s=t.getCoordinates();s.forEach((t=>{for(let e=t.length-1;e>=1;e--)t[e].equals(t[e-1])&&t.splice(e,1)})),t.setCoordinates(s);const a=this.toShape(t),c=this.coordinateToVector3(t.getCenter());o=e.Util.isNumber(o)?o:i,o=this.distanceToVector3(o,o).x;const h=this.distanceToVector3(i,i).x,l={bevelEnabled:!1,bevelSize:1};l[parseInt(n.REVISION)>=93?"depth":"amount"]=o;const u=new n.ExtrudeGeometry(a,l);let d=u;n.BufferGeometry.prototype.fromGeometry&&(d=new n.BufferGeometry,d.fromGeometry(u));const f=new n.Mesh(d,r);return f.position.set(c.x,c.y,h-o),f}toExtrudePolygon(t,e,n){return new we(t,e,n,this)}toBar(t,e,n){return new P(t,e,n,this)}toLine(t,e,n){return new le(t,e,n,this)}toExtrudeLine(t,e,n){return new be(t,e,n,this)}toModel(t,e){return new Oe(t,e,this)}toExtrudeLineTrail(t,e,n){return new Ve(t,e,n,this)}toExtrudePolygons(t,e,n){return new He(t,e,n,this)}toPoint(t,e,n){return new Je(t,e,n,this)}toPoints(t,e,n){return new en(t,e,n,this)}toBars(t,e,n){return new rn(t,e,n,this)}toExtrudeLines(t,e,n){return new sn(t,e,n,this)}toLines(t,e,n){return new cn(t,e,n,this)}toThreeVectorTileLayer(t,e,n){return new mn(t,e,n,this)}toTerrain(t,e,n){return new Sn(t,e,n,this)}toTerrainVectorTileLayer(t,e,n){return new An(t,e,n,this)}toHeatMap(t,e,n){return new Vn(t,e,n,this)}toFatLine(t,e,n){return new Zn(t,e,n,this)}toFatLines(t,e,n){return new Fn(t,e,n,this)}toBox(t,e,n){return new Hn(t,e,n,this)}toBoxs(t,e,n){return new qn(t,e,n,this)}getBaseObjects(){return this.getMeshes().filter((t=>t instanceof p))}getMeshes(){const t=this.getScene();if(!t)return[];const e=[];for(let i=0,r=t.children.length;i<r;i++){const r=t.children[i];r instanceof n.Object3D&&!(r instanceof n.Camera)&&e.push(r.__parent||r)}return e}clear(){return this.clearMesh()}clearMesh(){const t=this.getScene();if(!t)return this;for(let e=t.children.length-1;e>=0;e--){const i=t.children[e];if(i instanceof n.Object3D&&!(i instanceof n.Camera)){t.remove(i);const e=i.__parent;e&&e instanceof p&&(e.isAdd=!1,e._fire("remove",{target:e}),delete this._animationBaseObjectMap[i.uuid])}}return this}lookAt(t){const e=this._getRenderer();return e&&e.context.lookAt(t),this}getCamera(){const t=this._getRenderer();return t?t.camera:null}getScene(){const t=this._getRenderer();return t?t.scene:null}renderScene(){const t=this._getRenderer();return t&&(t.clearCanvas(),t.renderScene()),this}loop(t=!1){const e=this._delayMeshes;if(!e.length)return;const n=this.getMap();if(!n||n.isAnimating()||n.isInteracting())return;const i=this.options.loopRenderCount||50,r=e.slice(0,i);r&&this.addMesh(r,t),e.splice(0,i)}renderPickScene(){const t=this._getRenderer();if(t){const e=t.pick;e&&e.pick(this._containerPoint)}return this}getThreeRenderer(){const t=this._getRenderer();return t?t.context:null}getPick(){const t=this._getRenderer();return t?t.pick:null}delayAddMesh(t){if(!t)return this;Array.isArray(t)||(t=[t]);for(let e=0,n=t.length;e<n;e++)this._delayMeshes.push(t[e]);return this}addMesh(t,i=!0){if(!t)return this;Array.isArray(t)||(t=[t]);const r=this.getScene();return t.forEach((t=>{t instanceof p?(r.add(t.getObject3d()),t.isAdd||(t.isAdd=!0,t._fire("add",{target:t})),t._animation&&e.Util.isFunction(t._animation)&&(this._animationBaseObjectMap[t.getObject3d().uuid]=t)):t instanceof n.Object3D&&r.add(t)})),this._zoomend(),i&&this.renderScene(),this}removeMesh(t,i=!0){if(!t)return this;Array.isArray(t)||(t=[t]);const r=this.getScene();return t.forEach((t=>{if(t instanceof p){r.remove(t.getObject3d()),t.isAdd&&(t.isAdd=!1,t._fire("remove",{target:t})),t._animation&&e.Util.isFunction(t._animation)&&delete this._animationBaseObjectMap[t.getObject3d().uuid];const n=this._delayMeshes;if(n.length)for(let e=0,i=n.length;e<i;e++)if(n[e]===t){n.splice(e,1);break}}else t instanceof n.Object3D&&r.remove(t)})),i&&this.renderScene(),this}_initRaycaster(){return this._raycaster||(this._raycaster=new n.Raycaster,this._mouse=new n.Vector2),this}identify(t,r){if(!t)return console.error("coordinate is null,it should be Coordinate"),[];if(Array.isArray(t)&&(t=new e.Coordinate(t)),!(t instanceof e.Coordinate))return console.error("coordinate type is error,it should be Coordinate"),[];const o=this.getMap().coordToContainerPoint(t);this._containerPoint=o;const{x:s,y:a}=o;this._initRaycaster();const c=this._raycaster,h=this._mouse,l=this.getCamera(),u=this.getScene(),d=this.getMap().getSize();if(!u)return[];const f=d.width,g=d.height;h.x=s/f*2-1,h.y=-a/g*2+1,c.setFromCamera(h,l),function(t,e){i>113?t.params.Line.threshold=e:t.linePrecision=e}(c,this._getLinePrecision(this.getMap().getResolution()));const p=[],x=[];u.children.forEach((t=>{const i=t.__parent;if(i&&i.getOptions){const n=i;n.getOptions().interactive&&n.isVisible()&&(n.identify&&e.Util.isFunction(n.identify)?x.push(n):p.push(t))}else(t instanceof n.Mesh||t instanceof n.Group)&&p.push(t)}));let v=[];const y=c.intersectObjects(p,!0);y&&Array.isArray(y)&&y.length&&(v=y.map((t=>{let e=t.object;e=this._recursionMesh(e)||{};const n=e.__parent||e;return n.faceIndex=t.faceIndex,n.index=t.index,n}))),this.renderPickScene(),x.length&&x.forEach((e=>{e.identify(t)&&v.push(e)}));const m=v.length;for(let t=0;t<m;t++)if(v[t])for(let e=t+1;e<m;e++)v[t]===v[e]&&v.splice(e,1);const b=(r=e.Util.extend({},r)).count;return e.Util.isNumber(b)&&b>0?v.slice(0,b):v}_recursionMesh(t){for(;t&&t.parent!==this.getScene();)t=t.parent;return t}_getLinePrecision(t=10){for(let e=0,n=Kn.length;e<n;e++){const[n,i]=Kn[e];if(t>n)return i}return.01}_identifyBaseObjectEvents(t){if(!this.options.geometryEvents)return this;const n=this.map||this.getMap();if(n.isInteracting()||!n.options.geometryEvents)return this;const{type:i,coordinate:r}=t,o=e.Util.now();if(this._mousemoveTimeOut&&"mousemove"===i&&o-this._mousemoveTimeOut<64)return this;this._mousemoveTimeOut=o,n.resetCursor("default");const s=this.options.identifyCountOnEvent;let a=Math.max(0,e.Util.isNumber(s)?s:0);0===a&&(a=1/0);const c=this.identify(r,{count:a}),h=this.getScene();if(0===c.length&&h)for(let e=0,n=h.children.length;e<n;e++){const n=(h.children[e]||{}).__parent;n&&n.fire("empty",Object.assign({},t,{target:n}))}if("mousemove"===i){c.length&&n.setCursor("pointer");const e=[];this._baseObjects&&this._baseObjects.forEach((t=>{let n=!0;c.forEach((e=>{t===e&&(n=!1)})),n&&e.push(t)})),e.forEach((e=>{e&&e instanceof p&&(e.getSelectMesh?e.isHide||(e._mouseover=!1,e.fire("mouseout",Object.assign({},t,{target:e,type:"mouseout",selectMesh:null})),e.closeToolTip()):(e._mouseover=!1,e.fire("mouseout",Object.assign({},t,{target:e,type:"mouseout"})),e.closeToolTip()))})),c.forEach((e=>{if(e instanceof p){e._mouseover||(e.fire("mouseover",Object.assign({},t,{target:e,type:"mouseover",selectMesh:e.getSelectMesh?e.getSelectMesh():null})),e._mouseover=!0),e.fire(i,Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null}));const n=e.getToolTip();n&&!n._owner&&n.addTo(e),e.openToolTip(r)}})),this._baseObjects=c}else c.forEach((e=>{if(e instanceof p&&(e.fire(i,Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null})),"click"===i)){const t=e.getInfoWindow();t&&!t._owner&&t.addTo(e),e.openInfoWindow(r)}}));return this}_zoomend(){const t=this.getScene();if(!t)return;const n=this.getMap().getZoom();t.children.forEach((t=>{const i=t.__parent;if(i&&i.getOptions){const t=i;t.zoomChange&&e.Util.isFunction(t.zoomChange)&&t.zoomChange(n);const r=t.getMinZoom(),o=t.getMaxZoom();n<r||n>o?(t.isVisible()&&(t.getObject3d().visible=!1),t._zoomVisible=!1):r<=n&&n<=o&&(t._visible&&(t.getObject3d().visible=!0),t._zoomVisible=!0)}}))}onAdd(){super.onAdd();const t=this.map||this.getMap();return t?(Jn.forEach((e=>{t.on(e,this._identifyBaseObjectEvents,this)})),this._needsUpdate=!0,this._animationBaseObjectMap||(this._animationBaseObjectMap={}),t.on("zooming zoomend",this._zoomend,this),this):this}onRemove(){super.onRemove();const t=this.map||this.getMap();return t?(Jn.forEach((e=>{t.off(e,this._identifyBaseObjectEvents,this)})),t.off("zooming zoomend",this._zoomend,this),this):this}_callbackBaseObjectAnimation(){const t=this;if(t._animationBaseObjectMap)for(const e in t._animationBaseObjectMap){t._animationBaseObjectMap[e]._animation()}return this}_getFovRatio(){const t=this.getMap().getFov();return Math.tan(t/2*Nn)}}Yn.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null,geometryEvents:!0,identifyCountOnEvent:0,forceRenderOnZooming:!0,loopRenderCount:50});class $n extends e.renderer.CanvasLayerRenderer{constructor(){super(...arguments),this._renderTime=0}getPrepareParams(){return[this.scene,this.camera]}getDrawParams(){return[this.scene,this.camera]}_drawLayer(){super._drawLayer.apply(this,arguments)}hitDetect(){return!1}createCanvas(){super.createCanvas(),this.createContext()}createContext(){if(this.canvas.gl&&this.canvas.gl.wrap)this.gl=this.canvas.gl.wrap();else{const t=this.layer.options.glOptions||{alpha:!0,depth:!0,antialias:!0,stencil:!0,preserveDrawingBuffer:!1};t.preserveDrawingBuffer=!0,this.gl=this.gl||this._createGLContext(this.canvas,t)}this._initThreeRenderer(),this.layer.onCanvasCreate(this.context,this.scene,this.camera)}_initThreeRenderer(){this.matrix4=new n.Matrix4;const t=new n.WebGLRenderer({context:this.gl,alpha:!0});t.autoClear=!1,t.setClearColor(new n.Color(1,1,1),0),t.setSize(this.canvas.width,this.canvas.height),t.clear(),this.context=t;const e=this.scene=new n.Scene,i=this.layer.getMap(),r=i.getFov()*Math.PI/180,o=this.camera=new n.PerspectiveCamera(r,i.width/i.height,i.cameraNear,i.cameraFar);o.matrixAutoUpdate=!1,this._syncCamera(),e.add(o),this.pick=new En(this.layer)}onCanvasCreate(){super.onCanvasCreate()}resizeCanvas(t){if(!this.canvas)return;let n,i=this.getMap();n=t||i.getSize();const r=i.getDevicePixelRatio?i.getDevicePixelRatio():e.Browser.retina?2:1,o=this.canvas;o.height=r*n.height,o.width=r*n.width,this.layer._canvas&&o.style&&(o.style.width=n.width+"px",o.style.height=n.height+"px"),this.context.setSize(o.width,o.height)}clearCanvas(){this.canvas&&this.context.clear()}prepareCanvas(){return this.canvas?this.clearCanvas():this.createCanvas(),this.layer.fire("renderstart",{context:this.context}),null}renderScene(){const t=e.Util.now();t-this._renderTime>=16&&(this.layer._callbackBaseObjectAnimation(),this._renderTime=t),this._syncCamera(),this.context.render(this.scene,this.camera),this.completeRender()}remove(){delete this._drawContext,super.remove()}_syncCamera(){const t=this.getMap(),e=this.camera;e.matrix.elements=t.cameraWorldMatrix,e.projectionMatrix.elements=t.projMatrix,this.matrix4.invert?e.projectionMatrixInverse.elements=this.matrix4.copy(e.projectionMatrix).invert().elements:e.projectionMatrixInverse.elements=this.matrix4.getInverse(e.projectionMatrix).elements}_createGLContext(t,e){const n=["webgl2","webgl","experimental-webgl"];let i=null;for(let r=0;r<n.length;++r){try{i=t.getContext(n[r],e)}catch(t){}if(i)break}return i}}function ti(t){return t.getGLRes?t.getGLRes():t.getGLZoom()}function ei(t,e,n,i){return t.coordToPointAtRes?t.coordToPointAtRes(e,n,i):t.coordinateToPoint(e,n,i)}Yn.registerRenderer("gl",$n),e.registerWorkerAdapter&&e.registerWorkerAdapter("__maptalks.three__",'function(e){"use strict";var d=n,t=n;function n(e,t,n){n=n||2;var r,i,o,a,v,h=t&&t.length,l=h?t[0]*n:e.length,u=p(e,0,l,n,!0),x=[];if(!u||u.next===u.prev)return x;if(h&&(u=function(e,t,n,r){var i,o,a,v,h=[];for(i=0,o=t.length;i<o;i++)a=t[i]*r,v=i<o-1?t[i+1]*r:e.length,(v=p(e,a,v,r,!1))===v.next&&(v.steiner=!0),h.push(function(e){var t=e,n=e;for(;(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next,t!==e;);return n}(v));for(h.sort(m),i=0;i<h.length;i++)!function(e,t){(t=function(e,t){var n,r=t,i=e.x,o=e.y,a=-1/0;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var v=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(v<=i&&a<v){if((a=v)===i){if(o===r.y)return r;if(o===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}}while(r=r.next,r!==t);if(!n)return null;if(i===a)return n;var h,l=n,u=n.x,x=n.y,f=1/0;r=n;for(;i>=r.x&&r.x>=u&&i!==r.x&&M(o<x?i:a,o,u,x,o<x?a:i,o,r.x,r.y)&&(h=Math.abs(o-r.y)/(i-r.x),Z(r,e)&&(h<f||h===f&&(r.x>n.x||r.x===n.x&&function(e,t){return w(e.prev,e,t.prev)<0&&w(t.next,e,e.next)<0}(n,r)))&&(n=r,f=h)),r=r.next,r!==l;);return n}(e,t))&&(e=S(t,e),g(t,t.next),g(e,e.next))}(h[i],n),n=g(n,n.next);return n}(e,t,u,n)),e.length>80*n){for(var f=r=e[0],s=i=e[1],c=n;c<l;c+=n)(o=e[c])<f&&(f=o),(a=e[c+1])<s&&(s=a),r<o&&(r=o),i<a&&(i=a);v=0!==(v=Math.max(r-f,i-s))?1/v:0}return y(u,x,n,f,s,v),x}function p(e,t,n,r,i){var o,a;if(i===0<z(e,t,n,r))for(o=t;o<n;o+=r)a=v(o,e[o],e[o+1],a);else for(o=n-r;t<=o;o-=r)a=v(o,e[o],e[o+1],a);return a&&u(a,a.next)&&(f(a),a=a.next),a}function g(e,t){if(!e)return e;t=t||e;var n,r=e;do{if(n=!1,r.steiner||!u(r,r.next)&&0!==w(r.prev,r,r.next))r=r.next;else{if(f(r),(r=t=r.prev)===r.next)break;n=!0}}while(n||r!==t);return t}function y(e,t,n,r,i,o,a){if(e){!a&&o&&function(e,t,n,r){for(var i=e;null===i.z&&(i.z=b(i.x,i.y,t,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next,i!==e;);i.prevZ.nextZ=null,i.prevZ=null,function(e){var t,n,r,i,o,a,v,h,l=1;do{for(n=e,o=e=null,a=0;n;){for(a++,r=n,t=v=0;t<l&&(v++,r=r.nextZ);t++);for(h=l;0<v||0<h&&r;)0!==v&&(0===h||!r||n.z<=r.z)?(n=(i=n).nextZ,v--):(r=(i=r).nextZ,h--),o?o.nextZ=i:e=i,i.prevZ=o,o=i;n=r}}while(o.nextZ=null,l*=2,1<a)}(i)}(e,r,i,o);for(var v,h,l=e;e.prev!==e.next;)if(v=e.prev,h=e.next,o?function(e,t,n,r){var i=e.prev,o=e,a=e.next;if(0<=w(i,o,a))return!1;var v=(i.x<o.x?i.x<a.x?i:a:o.x<a.x?o:a).x,h=(i.y<o.y?i.y<a.y?i:a:o.y<a.y?o:a).y,l=(i.x>o.x?i.x>a.x?i:a:o.x>a.x?o:a).x,u=(i.y>o.y?i.y>a.y?i:a:o.y>a.y?o:a).y,x=b(v,h,t,n,r),f=b(l,u,t,n,r),s=e.prevZ,c=e.nextZ;for(;s&&s.z>=x&&c&&c.z<=f;){if(s!==e.prev&&s!==e.next&&M(i.x,i.y,o.x,o.y,a.x,a.y,s.x,s.y)&&0<=w(s.prev,s,s.next))return!1;if(s=s.prevZ,c!==e.prev&&c!==e.next&&M(i.x,i.y,o.x,o.y,a.x,a.y,c.x,c.y)&&0<=w(c.prev,c,c.next))return!1;c=c.nextZ}for(;s&&s.z>=x;){if(s!==e.prev&&s!==e.next&&M(i.x,i.y,o.x,o.y,a.x,a.y,s.x,s.y)&&0<=w(s.prev,s,s.next))return!1;s=s.prevZ}for(;c&&c.z<=f;){if(c!==e.prev&&c!==e.next&&M(i.x,i.y,o.x,o.y,a.x,a.y,c.x,c.y)&&0<=w(c.prev,c,c.next))return!1;c=c.nextZ}return!0}(e,r,i,o):function(e){var t=e.prev,n=e,r=e.next;if(0<=w(t,n,r))return!1;var i=e.next.next;for(;i!==e.prev;){if(M(t.x,t.y,n.x,n.y,r.x,r.y,i.x,i.y)&&0<=w(i.prev,i,i.next))return!1;i=i.next}return!0}(e))t.push(v.i/n),t.push(e.i/n),t.push(h.i/n),f(e),e=h.next,l=h.next;else if((e=h)===l){a?1===a?y(e=function(e,t,n){var r=e;do{var i=r.prev,o=r.next.next}while(!u(i,o)&&x(i,r,r.next,o)&&Z(i,o)&&Z(o,i)&&(t.push(i.i/n),t.push(r.i/n),t.push(o.i/n),f(r),f(r.next),r=e=o),r=r.next,r!==e);return g(r)}(g(e),t,n),t,n,r,i,o,2):2===a&&function(e,t,n,r,i,o){var a=e;do{for(var v=a.next.next;v!==a.prev;){if(a.i!==v.i&&function(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&x(n,n.next,e,t))return!0}while(n=n.next,n!==e);return!1}(e,t)&&(Z(e,t)&&Z(t,e)&&function(e,t){var n=e,r=!1,i=(e.x+t.x)/2,o=(e.y+t.y)/2;for(;n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next,n!==e;);return r}(e,t)&&(w(e.prev,e,t.prev)||w(e,t.prev,t))||u(e,t)&&0<w(e.prev,e,e.next)&&0<w(t.prev,t,t.next))}(a,v)){var h=S(a,v);return a=g(a,a.next),h=g(h,h.next),y(a,t,n,r,i,o),y(h,t,n,r,i,o)}v=v.next}}while((a=a.next)!==e)}(e,t,n,r,i,o):y(g(e),t,n,r,i,o,1);break}}}function m(e,t){return e.x-t.x}function b(e,t,n,r,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*i)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*i)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function M(e,t,n,r,i,o,a,v){return 0<=(i-a)*(t-v)-(e-a)*(o-v)&&0<=(e-a)*(r-v)-(n-a)*(t-v)&&0<=(n-a)*(o-v)-(i-a)*(r-v)}function w(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function u(e,t){return e.x===t.x&&e.y===t.y}function x(e,t,n,r){var i=l(w(e,t,n)),o=l(w(e,t,r)),a=l(w(n,r,e)),v=l(w(n,r,t));return i!==o&&a!==v||(0===i&&h(e,n,t)||(0===o&&h(e,r,t)||(0===a&&h(n,e,r)||!(0!==v||!h(n,t,r)))))}function h(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}function l(e){return 0<e?1:e<0?-1:0}function Z(e,t){return w(e.prev,e,e.next)<0?0<=w(e,t,e.next)&&0<=w(e,e.prev,t):w(e,t,e.prev)<0||w(e,e.next,t)<0}function S(e,t){var n=new a(e.i,e.x,e.y),r=new a(t.i,t.x,t.y),i=e.next,o=t.prev;return(e.next=t).prev=e,(n.next=i).prev=n,(r.next=n).prev=r,(o.next=r).prev=o,r}function v(e,t,n,r){n=new a(e,t,n);return r?(n.next=r.next,(n.prev=r).next.prev=n,r.next=n):(n.prev=n).next=n,n}function f(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function a(e,t,n){this.i=e,this.x=t,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function z(e,t,n,r){for(var i=0,o=t,a=n-r;o<n;o+=r)i+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return i}function r(e,t){var n=e.length-1,r=[e[0]];return function e(t,n,r,i,o){for(var a,v,h,l,u,x,f,s=i,c=n+1;c<r;c++){var p=(v=t[c],h=t[n],l=t[r],p=f=x=u=void 0,u=h[0],x=h[1],f=l[0]-u,p=l[1]-x,0===f&&0===p||(1<(h=((v[0]-u)*f+(v[1]-x)*p)/(f*f+p*p))?(u=l[0],x=l[1]):0<h&&(u+=f*h,x+=p*h)),(f=v[0]-u)*f+(p=v[1]-x)*p);s<p&&(a=c,s=p)}i<s&&(1<a-n&&e(t,n,a,i,o),o.push(t[a]),1<r-a&&e(t,a,r,i,o))}(e,0,n,t,r),r.push(e[n]),r}function A(e,t,n){if(e.length<=2)return e;t=void 0!==t?t*t:1;return e=r(e=n?e:function(e,t){for(var n,r,i,o,a=e[0],v=[a],h=1,l=e.length;h<l;h++)n=e[h],i=a,o=void 0,o=(r=n)[0]-i[0],i=r[1]-i[1],t<o*o+i*i&&(v.push(n),a=n);return a!==n&&v.push(n),v}(e,t),t)}function R(e,t){var n=t[0],r=t[1],t=Math.sqrt(n*n+r*r);return e[0]=n/t,e[1]=r/t,e}function s(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e}function F(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e}n.deviation=function(e,t,n,r){var i=t&&t.length,o=i?t[0]*n:e.length,a=Math.abs(z(e,0,o,n));if(i)for(var v=0,h=t.length;v<h;v++){var l=t[v]*n,u=v<h-1?t[v+1]*n:e.length;a-=Math.abs(z(e,l,u,n))}for(var x=0,v=0;v<r.length;v+=3){var f=r[v]*n,s=r[v+1]*n,c=r[v+2]*n;x+=Math.abs((e[f]-e[c])*(e[1+s]-e[1+f])-(e[f]-e[s])*(e[1+c]-e[1+f]))}return 0===a&&0===x?0:Math.abs((x-a)/a)},n.flatten=function(e){for(var t=e[0][0].length,n={vertices:[],holes:[],dimensions:t},r=0,i=0;i<e.length;i++){for(var o=0;o<e[i].length;o++)for(var a=0;a<t;a++)n.vertices.push(e[i][o][a]);0<i&&(r+=e[i-1].length,n.holes.push(r))}return n},d.default=t;var c=[];function ee(e,t,n,r){var i,o,a=(o=n,(i=t)[0]*o[0]+i[1]*o[1]+i[2]*o[2]),v=Math.acos(a)*r;return s(c,n,t,-a),r=(o=i=c)[0],n=o[1],a=o[2],o=Math.sqrt(r*r+n*n+a*a),i[0]=r/o,i[1]=n/o,i[2]=a/o,a=e,o=t,t=Math.cos(v),a[0]=o[0]*t,a[1]=o[1]*t,a[2]=o[2]*t,s(e,e,c,Math.sin(v)),e}function q(e,t,n){if(n-t<3)return 0;for(var r=0,i=2*(n-1),o=2*t;o<2*n;){var a=e[i],v=e[i+1],h=e[o],l=e[o+1],i=o;o+=2,r+=a*l-h*v}return r}var B=[],U=[],L=[];function O(e,t,n,r,i,o,a,v){var h=null!=a,l=i,u=null;h&&(u=new Uint32Array(r-n));for(var x=n;x<r;x++){var f=x===r-1?n:x+1,s=x===n?r-1:x-1,c=e[2*s],p=e[2*s+1],g=e[2*x],d=e[2*x+1],s=e[2*f],f=e[2*f+1];B[0]=g-c,B[1]=d-p,U[0]=s-g,U[1]=f-d,R(B,B),R(U,U),h&&(u[x]=l),v||x!==n?v||x!==r-1?(c=U,p=B,(s=L)[0]=c[0]+p[0],s[1]=c[1]+p[1],f=L[1],L[1]=-L[0],L[0]=f,R(L,L),s=U,p=(c=L)[0]*s[0]+c[1]*s[1],f=Math.sqrt(1-p*p),c=o*Math.min(10,1/f),h&&a<1/f&&o*p<0?(s=g+L[0]*o,p=d+L[1]*o,f=Math.acos(f)/2,f=Math.tan(f)*Math.abs(o),t[2*l]=s+L[1]*f,t[2*l+1]=p-L[0]*f,t[2*++l]=s-L[1]*f,t[2*l+1]=p+L[0]*f):(t[2*l]=g+L[0]*c,t[2*l+1]=d+L[1]*c)):(L[0]=B[1],L[1]=-B[0],R(L,L),t[2*l]=g+L[0]*o,t[2*l+1]=d+L[1]*o):(L[0]=U[1],L[1]=-U[0],R(L,L),t[2*l]=g+L[0]*o,t[2*l+1]=d+L[1]*o),l++}return u}function P(e,t,n,r,i){var o=null!=r?[]:new Float32Array(e.length);if(O(e,o,0,t&&t.length?t[0]:e.length/2,0,n,r,i),t)for(var a=0;a<t.length;a++){var v=t[a];O(e,o,v,t[a+1]||e.length/2,null!=r?o.length/2:v,n,r,i)}return o}function V(e,t,n,r){for(var i=0;i<Math.floor((r-n)/2);i++)for(var o=0;o<t;o++){var a=(i+n)*t+o,v=(r-i-1)*t+o,h=e[a];e[a]=e[v],e[v]=h}return e}function W(e){e.depth=e.depth||1,e.bevelSize=e.bevelSize||0,e.bevelSegments=null==e.bevelSegments?2:e.bevelSegments,e.smoothSide=e.smoothSide||!1,e.smoothBevel=e.smoothBevel||!1,e.simplify=e.simplify||0,"number"==typeof e.depth&&(e.bevelSize=Math.min(0<e.bevelSegments?e.bevelSize:0,e.depth/2)),0<e.bevelSize||(e.bevelSegments=0),e.bevelSegments=Math.round(e.bevelSegments);var t,n,r,i,o=e.boundingRect;e.translate=e.translate||[0,0],e.scale=e.scale||[1,1],e.fitRect&&(t=null==e.fitRect.x?o.x||0:e.fitRect.x,n=null==e.fitRect.y?o.y||0:e.fitRect.y,r=e.fitRect.width,i=e.fitRect.height,null==r?null!=i?r=i/o.height*o.width:(r=o.width,i=o.height):null==i&&(i=r/o.width*o.height),e.scale=[r/o.width,i/o.height],e.translate=[(t-o.x)*e.scale[0],(n-o.y)*e.scale[1]])}function j(e,t){function n(e,t,n,r){e[0]=t,e[1]=n,e[2]=r}for(var r,i,o,a,v,h,l,u=[],x=[],f=[],s=[],c=[],p=[],g=e.length,d=new Float32Array(t.length),y=0;y<g;){var m=3*e[y++],b=3*e[y++],M=3*e[y++];n(u,t[m],t[1+m],t[2+m]),n(x,t[b],t[1+b],t[2+b]),n(f,t[M],t[1+M],t[2+M]),F(s,u,x),F(c,x,f),r=p,o=c,l=h=v=a=void 0,a=(i=s)[0],v=i[1],h=i[2],l=o[0],i=o[1],o=o[2],r[0]=v*o-h*i,r[1]=h*l-a*o,r[2]=a*i-v*l;for(var w=0;w<3;w++)d[m+w]=d[m+w]+p[w],d[b+w]=d[b+w]+p[w],d[M+w]=d[M+w]+p[w]}for(var Z,S,z,A,R,q=0;q<d.length;)n(p,d[q],d[q+1],d[q+2]),R=A=z=void 0,z=(S=Z=p)[0],A=S[1],R=S[2],S=Math.sqrt(z*z+A*A+R*R),Z[0]=z/S,Z[1]=A/S,Z[2]=R/S,d[q++]=p[0],d[q++]=p[1],d[q++]=p[2];return d}var te=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function H(e,t,n,r,i,o){var a=t.vertices,v=t.topVertices,h=t.depth,t=t.rect,l=r-n,u=o.smoothSide?1:2,x=l*u,f=o.smoothBevel?1:2,s=Math.min(h/2,o.bevelSize),c=o.bevelSegments,p=i.vertex,g=Math.max(t.width,t.height,h);if(0<s)for(var d=[0,0,1],y=[],m=[0,0,-1],b=[],M=0,w=new Float32Array(l),Z=0;Z<2;Z++)for(var S=0===Z?h-s:s,z=0;z<=c*f;z++){for(var A=0,R=void 0,q=void 0,F=0;F<l;F++){for(var B=0;B<u;B++){var U=2*((F+B)%l+n);y[0]=a[U]-v[U],y[1]=a[1+U]-v[1+U],y[2]=0;var L=Math.sqrt(y[0]*y[0]+y[1]*y[1]);y[0]/=L,y[1]/=L;var O=(Math.floor(z/f)+z%f)/c;0===Z?ee(b,d,y,O):ee(b,y,m,O);var P=0===Z?O:1-O,V=s*Math.sin(P*Math.PI/2),W=L*Math.cos(P*Math.PI/2),O=s*L/Math.sqrt(V*V+W*W),P=b[0]*O+v[U],L=b[1]*O+v[1+U],V=b[2]*O+S;e.position[3*i.vertex]=P,e.position[3*i.vertex+1]=L,e.position[3*i.vertex+2]=V,(0<F||0<B)&&(A+=Math.sqrt((R-P)*(R-P)+(q-L)*(q-L))),(0<z||0<Z)&&(W=3*(i.vertex-x),U=e.position[W],O=e.position[1+W],W=e.position[2+W],w[F]+=Math.sqrt((U-P)*(U-P)+(O-L)*(O-L)+(W-V)*(W-V))),e.uv[2*i.vertex]=A/g,e.uv[2*i.vertex+1]=w[F]/g,R=P,q=L,i.vertex++}if(1<f&&z%f||1==f&&1<=z)for(var j=0;j<6;j++){var H=(te[j][0]+F*u)%x,k=te[j][1]+M;e.indices[i.index++]=(k-1)*x+H+p}}M++}else for(var I=0;I<2;I++)for(var _=0===I?h-s:s,D=0,E=void 0,C=void 0,G=0;G<l;G++)for(var J=0;J<u;J++){var K=2*((G+J)%l+n),N=a[K],K=a[1+K];e.position[3*i.vertex]=N,e.position[3*i.vertex+1]=K,e.position[3*i.vertex+2]=_,(0<G||0<J)&&(D+=Math.sqrt((E-N)*(E-N)+(C-K)*(C-K))),e.uv[2*i.vertex]=D/g,e.uv[2*i.vertex+1]=_/g,E=N,C=K,i.vertex++}for(var Q=0<s?c*f+1:1,T=0;T<l;T++)for(var X=0;X<6;X++){var Y=(te[X][0]+T*u)%x,$=te[X][1]+Q;e.indices[i.index++]=($-1)*x+Y+p}}function k(e,t){for(var n=0,r=0,i=0;i<e.length;i++){var o=e[i],a=o.indices,v=o.vertices,h=o.holes,o=o.depth,l=v.length/2,u=0<Math.min(o/2,t.bevelSize)?t.bevelSegments:0;n+=a.length*(t.excludeBottom?1:2),r+=l*(t.excludeBottom?1:2);for(var x=2+2*u,f=0,s=0,c=0;c<(h?h.length:0)+1;c++){n+=6*((s=0===c?h&&h.length?h[0]:l:(f=h[c-1],h[c]||l))-f)*(x-1);var p=(s-f)*(t.smoothSide?1:2);r+=p*x+(t.smoothBevel?0:u*p*2)}}for(var g={position:new Float32Array(3*r),indices:new(65535<r?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*r)},d={vertex:0,index:0},y=0;y<e.length;y++)!function(e,t,n,r){var i=e.indices,o=e.vertices,a=e.topVertices,v=e.rect,h=e.depth;if(!(o.length<=4)){for(var l=n.vertex,u=i.length,x=0;x<u;x++)t.indices[n.index++]=l+i[x];for(var f=Math.max(v.width,v.height),s=0;s<(r.excludeBottom?1:2);s++)for(var c=0;c<a.length;c+=2){var p=a[c],g=a[c+1];t.position[3*n.vertex]=p,t.position[3*n.vertex+1]=g,t.position[3*n.vertex+2]=(1-s)*h,t.uv[2*n.vertex]=(p-v.x)/f,t.uv[2*n.vertex+1]=(g-v.y)/f,n.vertex++}if(!r.excludeBottom)for(var d=o.length/2,y=0;y<u;y+=3)for(var m=0;m<3;m++)t.indices[n.index++]=l+d+i[y+2-m]}}(e[y],g,d,t);for(var m=0;m<e.length;m++){var b,M=e[m],w=M.holes,Z=M.vertices.length/2,S=w&&w.length?w[0]:Z;if(H(g,e[m],0,S,d,t),w)for(var z=0;z<w.length;z++)b=w[z],S=w[z+1]||Z,H(g,e[m],b,S,d,t)}for(var A=0;A<g.uv.length;A++){var R=g.uv[A];0<R&&Math.round(R)===R?g.uv[A]=1:g.uv[A]=R%1}return g.normal=j(g.indices,g.position),g.boundingRect=e[0]&&e[0].rect,g}function I(e,t){t=Object.assign({},t);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<e.length;i++)D(e[i][0],n,r);t.boundingRect=t.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},W(t);for(var o=[],a=t.translate||[0,0],v=t.scale||[1,1],h=t.boundingRect,l={x:h.x*v[0]+a[0],y:h.y*v[1]+a[1],width:h.width*v[0],height:h.height*v[1]},u=Math.min(h.width,h.height)/1e5,x=0;x<e.length;x++){var f=function(e,t){for(var n=[],r=0;r<e.length;r++){for(var i=e[r],o=[],a=i.length,v=i[a-1][0],h=i[a-1][1],l=0,u=0;u<a;u++){var x=i[u][0],f=i[u][1],s=x-v,c=f-h;t<(l+=Math.sqrt(s*s+c*c))&&(o.push(i[u]),l=0),v=x,h=f}3<=o.length&&n.push(o)}return 0<n.length?n:null}(e[x],u);if(f){var s=t.simplify/Math.max(v[0],v[1]);if(f=0<s?function(e,t){for(var n=[],r=0;r<e.length;r++){var i=e[r];3<=(i=A(i,t,!0)).length&&n.push(i)}return 0<n.length?n:null}(f,s):f){for(var c=d.flatten(f),p=c.vertices,s=c.holes,f=c.dimensions,g=0;g<p.length;)p[g]=p[g++]*v[0]+a[0],p[g]=p[g++]*v[1]+a[1];if(!function(e,t){var n=e.length/2,r=0,i=t&&t.length?t[0]:n;0<q(e,r,i)&&V(e,2,r,i);for(var o=1;o<(t?t.length:0)+1;o++)q(e,r=t[o-1],i=t[o]||n)<0&&V(e,2,r,i)}(p,s),2!==f)throw new Error("Only 2D polygon points are supported");c=0<t.bevelSize?P(p,s,t.bevelSize,null,!0):p,f=d(c,s,f=void 0===(f=f)?2:f);o.push({indices:f,vertices:p,topVertices:c,holes:s,rect:l,depth:"function"==typeof t.depth?t.depth(x):t.depth})}}}return k(o,t)}function _(e,t){t=Object.assign({},t);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<e.length;i++)D(e[i],n,r);t.boundingRect=t.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},W(t);var o=t.scale||[1,1];null==t.lineWidth&&(t.lineWidth=1),null==t.miterLimit&&(t.miterLimit=2);for(var a=[],v=0;v<e.length;v++){var h=e[v],l=t.simplify/Math.max(o[0],o[1]);0<l&&(h=A(h,l,!0)),a.push(function(e,t,n){for(var r=n.lineWidth,i=e.length,o=new Float32Array(2*i),a=n.translate||[0,0],v=n.scale||[1,1],h=0,l=0;h<i;h++)o[l++]=e[h][0]*v[0]+a[0],o[l++]=e[h][1]*v[1]+a[1];q(o,0,i)<0&&V(o,2,0,i);var u=[],x=[],f=n.miterLimit,s=O(o,x,0,i,0,-r/2,f,!1);V(o,2,0,i);for(var c=O(o,u,0,i,0,-r/2,f,!1),r=(u.length+x.length)/2,p=new Float32Array(2*r),g=0,d=x.length/2,y=0;y<x.length;y++)p[g++]=x[y];for(var m=0;m<u.length;m++)p[g++]=u[m];for(var b=new(65535<r?Uint32Array:Uint16Array)(3*(2*(i-1)+(r-2*i))),M=0,w=0;w<i-1;w++){var Z=w+1;b[M++]=d-1-s[w],b[M++]=d-1-s[w]-1,b[M++]=c[w]+1+d,b[M++]=d-1-s[w],b[M++]=c[w]+1+d,b[M++]=c[w]+d,c[Z]-c[w]==2?(b[M++]=c[w]+2+d,b[M++]=c[w]+1+d,b[M++]=d-s[Z]-1):s[Z]-s[w]==2&&(b[M++]=c[Z]+d,b[M++]=d-1-(s[w]+1),b[M++]=d-1-(s[w]+2))}return f=0<n.bevelSize?P(p,[],n.bevelSize,null,!0):p,r=n.boundingRect,{vertices:p,indices:b,topVertices:f,rect:{x:r.x*v[0]+a[0],y:r.y*v[1]+a[1],width:r.width*v[0],height:r.height*v[1]},depth:"function"==typeof n.depth?n.depth(t):n.depth,holes:[]}}(h,v,t))}return k(a,t)}function D(e,t,n){for(var r=0;r<e.length;r++)t[0]=Math.min(e[r][0],t[0]),t[1]=Math.min(e[r][1],t[1]),n[0]=Math.max(e[r][0],n[0]),n[1]=Math.max(e[r][1],n[1])}function E(e){for(var t=new Float32Array(e),n=[],r=0,i=t.length;r<i;r+=2){var o=t[r],a=t[r+1];n.push([o,a])}return n}function C(e,t){void 0===t&&(t=!1);for(var n,r,i,o,a=e.length,v=[],h=[],l=[],u=0,x=0,f=0,s=0,c=0;c<a;c++){var p=t?(p=e[c],r=i=n=o=i=r=n=void 0,n=p.data,r=p.height,i=p.width,o=p.bottomHeight,p=_(n,{lineWidth:i,depth:r}),n=p.position,i=p.normal,r=p.uv,p=p.indices,G(n,o),{position:n,normal:i,uv:r,indices:p}):(d=e[c],b=m=y=b=g=m=y=void 0,y=d.data,m=d.height,g=d.bottomHeight,b=I(y,{depth:m}),d=b.position,y=b.normal,m=b.uv,b=b.indices,G(d,g),{position:d,normal:y,uv:m,indices:b}),g=e[c].bottomHeight||0,d=p.position,y=p.normal,m=p.uv,b=p.indices;h.push(p);b=b.length/3;l[c]=[u+1,u+b],u+=b;d=d.length/3,y=y.length/3,m=m.length/2;v[c]={position:{middleZ:g+(e[c].height||0)/2,count:d,start:x,end:x+3*d},normal:{count:y,start:f,end:f+3*y},uv:{count:m,start:s,end:s+2*m},hide:!1},x+=3*d,f+=3*y,s+=2*m}var M=function(e){for(var t={},n={},r=0;r<e.length;++r){var i,o=e[r];for(i in o)void 0===t[i]&&(t[i]=[],n[i]=0),t[i].push(o[i]),n[i]+=o[i].length}var a,v={},h=0,l=[];for(a in t)if("indices"===a)for(var u=t[a],x=0,f=u.length;x<f;x++){for(var s=u[x],c=0,p=s.length;c<p;c++)l.push(s[c]+h);h+=t.position[x].length/3}else{var g=function(e,t){for(var n=new Float32Array(t),r=0,i=0;i<e.length;++i)n.set(e[i],r),r+=e[i].length;return n}(t[a],n[a]);if(!g)return null;v[a]=g}return v.indices=new Uint32Array(l),v}(h),w=M.position,Z=M.normal,S=M.uv,M=M.indices;return{position:w.buffer,normal:Z.buffer,uv:S.buffer,indices:M.buffer,faceMap:l,geometriesAttributes:v}}function G(e,t){if(void 0!==t&&"number"==typeof t&&0!==t)for(var n=0,r=e.length;n<r;n+=3)e[n+2]+=t}e.initialize=function(){},e.onmessage=function(e,t){var n=e.data,e=n.type,r=n.datas;if("Polygon"===e){!function(e){for(var t=e.length,n=0;n<t;n++)for(var r=e[n].data,i=0,o=r.length;i<o;i++)for(var a=r[i],v=0,h=a.length;v<h;v++)e[n].data[i][v]=E(a[v])}(r);n=C(r);t(null,n,[n.position,n.normal,n.uv,n.indices])}else if("LineString"===e){for(var i=0,o=r.length;i<o;i++)for(var a=0,v=r[i].data.length;a<v;a++)r[i].data[a]=E(r[i].data[a]);e=C(r,!0);t(null,e,[e.position,e.normal,e.uv,e.indices])}},Object.defineProperty(e,"__esModule",{value:!0})}'),t.BaseObject=p,t.ExtrudeUtil=ye,t.GeoJSONUtil=ne,t.GeoUtil=Be,t.IdentifyUtil=qe,t.LineMaterial=h,t.LineUtil=ce,t.MergeGeometryUtil=M,t.MergedMixin=Ee,t.ThreeLayer=Yn,t.ThreeRenderer=$n,t.geometryExtrude=Wt,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.three v0.17.2")}));
