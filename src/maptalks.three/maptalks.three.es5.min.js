/*!
 * maptalks.three v0.17.2
 * LICENSE : MIT
 * (c) 2016-2021 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks"),require("three")):"function"==typeof define&&define.amd?define(["exports","maptalks","three"],e):e((t=t||self).maptalks=t.maptalks||{},t.maptalks,t.THREE)}(this,(function(t,e,n){"use strict";function r(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,i(t,e)}function i(t,e){return(i=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function o(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}var a=parseInt(n.REVISION.replace("dev",""));function s(t,e,n){return a>109?t.setAttribute(e,n):t.addAttribute(e,n),t}function c(){return!n.VertexColors||n.VertexColors}console.log("maptalks.three log: current three.js version is %c"+a,"color:red;font-size: 16px;font-weight: bold;");var u=function(t){function e(){var e;(e=t.call(this)||this).isLineSegmentsGeometry=!0,e.type="LineSegmentsGeometry";return e.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),s(o(e),"position",new n.Float32BufferAttribute([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),s(o(e),"uv",new n.Float32BufferAttribute([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2)),e}r(e,t);var i=e.prototype;return i.applyMatrix=function(t){var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;return void 0!==e&&(t.applyToBufferAttribute(e),t.applyToBufferAttribute(n),e.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},i.setPositions=function(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var r=new n.InstancedInterleavedBuffer(e,6,1);return s(this,"instanceStart",new n.InterleavedBufferAttribute(r,3,0)),s(this,"instanceEnd",new n.InterleavedBufferAttribute(r,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this},i.setColors=function(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var r=new n.InstancedInterleavedBuffer(e,6,1);return s(this,"instanceColorStart",new n.InterleavedBufferAttribute(r,3,0)),s(this,"instanceColorEnd",new n.InterleavedBufferAttribute(r,3,3)),this},i.fromWireframeGeometry=function(t){return this.setPositions(t.attributes.position.array),this},i.fromEdgesGeometry=function(t){return this.setPositions(t.attributes.position.array),this},i.fromMesh=function(t){return this.fromWireframeGeometry(new n.WireframeGeometry(t.geometry)),this},i.fromLineSegements=function(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this},i.computeBoundingBox=function(){var t=new n.Box3;null===this.boundingBox&&(this.boundingBox=new n.Box3);var e=this.attributes.instanceStart,r=this.attributes.instanceEnd;void 0!==e&&void 0!==r&&(this.boundingBox.setFromBufferAttribute(e),t.setFromBufferAttribute(r),this.boundingBox.union(t))},i.computeBoundingSphere=function(){var t=new n.Vector3;null===this.boundingSphere&&(this.boundingSphere=new n.Sphere),null===this.boundingBox&&this.computeBoundingBox();var e=this.attributes.instanceStart,r=this.attributes.instanceEnd;if(void 0!==e&&void 0!==r){var i=this.boundingSphere.center;this.boundingBox.getCenter(i);for(var o=0,a=0,s=e.count;a<s;a++)t.fromBufferAttribute(e,a),o=Math.max(o,i.distanceToSquared(t)),t.fromBufferAttribute(r,a),o=Math.max(o,i.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(o),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}},i.toJSON=function(){},i.copy=function(t){return this},e}(n.InstancedBufferGeometry),l={},h={};l.line={linewidth:{value:1},resolution:{value:new n.Vector2(1,1)},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},h.line={uniforms:n.UniformsUtils.merge([n.UniformsLib.common,n.UniformsLib.fog,l.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying vec2 vUv;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}\n\t\t"};var f=function(t){function e(e){var r;return(r=t.call(this,{uniforms:n.UniformsUtils.clone(h.line.uniforms),vertexShader:h.line.vertexShader,fragmentShader:h.line.fragmentShader})||this).dashed=!0,r.isLineMaterial=!0,r.type="LineMaterial",Object.defineProperties(o(r),{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}}}),r.setValues(e),r}return r(e,t),e}(n.ShaderMaterial),d=function(t){function e(e,n){var r;return(r=t.call(this,e,n)||this).isLineSegments2=!0,r.type="LineSegments2",r.geometry=void 0!==e?e:new u,r.material=void 0!==n?n:new f({color:16777215*Math.random()}),r}return r(e,t),e.prototype.computeLineDistances=function(){for(var t=new n.Vector3,e=new n.Vector3,r=this.geometry,i=r.attributes.instanceStart,o=r.attributes.instanceEnd,a=new Float32Array(2*i.data.count),c=0,u=0,l=i.data.count;c<l;c++,u+=2)t.fromBufferAttribute(i,c),e.fromBufferAttribute(o,c),a[u]=0===u?0:a[u-1],a[u+1]=a[u]+t.distanceTo(e);var h=new n.InstancedInterleavedBuffer(a,2,1);return s(r,"instanceDistanceStart",new n.InterleavedBufferAttribute(h,1,0)),s(r,"instanceDistanceEnd",new n.InterleavedBufferAttribute(h,1,1)),this},e}(n.Mesh),v=function(t){function e(){var e;return(e=t.call(this)||this).isLineGeometry=!0,e.type="LineGeometry",e}return r(e,t),e.prototype.fromLine=function(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this},e}(u),g=function(t){function e(e,n){var r;return(r=t.call(this,e,n)||this).isLine2=!0,r.type="Line2",r.geometry=void 0!==e?e:new v,r.material=void 0!==n?n:new f({color:16777215*Math.random()}),r}return r(e,t),e.prototype.copy=function(t){return this},e}(d),p={interactive:!0,altitude:0,minZoom:0,maxZoom:30,asynchronous:!1};var x,y=function(t){function i(n){var r;return(r=t.call(this)||this).isAdd=!1,r._mouseover=!1,r._visible=!0,r._zoomVisible=!0,r.picked=!1,r.isBaseObject=!0,void 0===n&&(n=e.Util.GUID()),r.id=n,r}r(i,t);var o=i.prototype;return o.addTo=function(t){return t&&"ThreeLayer"===t.type?t.addMesh([this]):console.error("layer only support maptalks.ThreeLayer"),this},o.remove=function(){var t=this.getLayer();return t&&t.removeMesh([this]),this},o.getObject3d=function(){return this.object3d},o.getId=function(){return this.id},o.setId=function(t){var e=this.getId();return this.id=t,this._fire("idchange",{old:e,new:t,target:this}),this},o.getType=function(){return this.type},o.getOptions=function(){return this.options},o.getProperties=function(){return(this.options||{}).properties},o.setProperties=function(t){var e=Object.assign({},this.getProperties());return this.options.properties=t,this._fire("propertieschange",{old:e,new:t,target:this}),this},o.getLayer=function(){return this.options.layer},o.getMap=function(){var t=this.getLayer();if(t)return t.getMap()},o.getCenter=function(){var t=this.getOptions(),n=t.coordinate,r=t.lineString,i=t.polygon;if(n)return n instanceof e.Coordinate?n:new e.Coordinate(n);var o=i||r;return o&&o.getCenter?o.getCenter():void 0},o.getAltitude=function(){return this.getOptions().altitude},o.setAltitude=function(t){if(e.Util.isNumber(t)){var n=this.getLayer().distanceToVector3(t,t).x;if(this.getObject3d().position.z=n,this.options.altitude=t,this.pickObject3d&&(this.pickObject3d.position.z=n),this._baseObjects&&Array.isArray(this._baseObjects))for(var r=0,i=this._baseObjects.length;r<i;r++)this._baseObjects[r]&&(this._baseObjects[r].getObject3d().position.z=n)}return this},o.show=function(){return this._zoomVisible&&(this.getObject3d().visible=!0,this._fire("show")),this._visible=!0,this},o.hide=function(){return this.getObject3d().visible=!1,this._fire("hide"),this._visible=!1,this},o.isVisible=function(){return!!this.getObject3d().visible},o.getSymbol=function(){return this.getObject3d().material},o.setSymbol=function(t){if(t&&t instanceof n.Material){t.needsUpdate=!0,t.vertexColors=this.getObject3d().material.vertexColors;var e=this.getObject3d().material.clone();this.getObject3d().material=t,this._fire("symbolchange",{old:e,new:t,target:this})}return this},o.setInfoWindow=function(t){return this.removeInfoWindow(),this.infoWindow=new e.ui.InfoWindow(t),this.infoWindow.addTo(this),this},o.getInfoWindow=function(){return this.infoWindow},o.openInfoWindow=function(t){return(t=t||this.getCenter())instanceof e.Coordinate||(t=new e.Coordinate(t)),t&&this.infoWindow&&this.infoWindow.show(t),this},o.closeInfoWindow=function(){return this.infoWindow&&this.infoWindow.hide(),this},o.removeInfoWindow=function(){return this.infoWindow&&(this.infoWindow.remove(),delete this.infoWindow),this},o.setToolTip=function(t,n){return this.removeToolTip(),this.toolTip=new e.ui.ToolTip(t,n),this.toolTip.addTo(this),this},o.getToolTip=function(){return this.toolTip},o.openToolTip=function(t){return(t=t||this.getCenter())instanceof e.Coordinate||(t=new e.Coordinate(t)),t&&this.toolTip&&this.toolTip.show(t),this},o.closeToolTip=function(){return this.toolTip&&this.toolTip.hide(),this},o.removeToolTip=function(){return this.toolTip&&(this.toolTip.remove(),delete this.toolTip),this},o.animateShow=function(t,n){var r=this;void 0===t&&(t={}),this._showPlayer&&this._showPlayer.cancel(),e.Util.isFunction(t)&&(n=t={});var i=t.duration||1e3,o=t.easing||"out",a=this._showPlayer=e.animation.Animation.animate({scale:1},{duration:i,easing:o},(function(t){var e=t.styles.scale;e>0&&(r.getObject3d().scale.z=e),n&&n(t,e)}));return a.play(),a},o.getMinZoom=function(){return this.getOptions().minZoom},o.getMaxZoom=function(){return this.getOptions().maxZoom},o.isAsynchronous=function(){return this.getOptions().asynchronous},o.fire=function(t,e){return this._fire(t,e),this._vt&&this._vt.onSelectMesh&&this._vt.onSelectMesh(t,e),this},o.config=function(){return this},o.setPickObject3d=function(t){return this.pickObject3d=t,this.pickObject3d.__parent=this,this},o._initOptions=function(t){return this.options=e.Util.extend({},p,t),this},o._createMesh=function(t,e){return this.object3d=new n.Mesh(t,e),this.object3d.__parent=this,this},o._createGroup=function(){return this.object3d=new n.Group,this.object3d.__parent=this,this},o._createLine=function(t,e){return this.object3d=new n.Line(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this,this},o._createLine2=function(t,e){return this.object3d=new g(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this,this},o._createPoints=function(t,e){return this.object3d=new n.Points(t,e),this.object3d.__parent=this,this},o._createLineSegments=function(t,e){return this.object3d=new n.LineSegments(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this,this},i}(e.Eventable((function(){})));function m(t){var e=b(t),r=e.position,i=e.normal,o=e.uv,a=e.indices,c=new n.BufferGeometry,u=new Float32Array(r.length);return u.fill(1,0,r.length),s(c,"color",new n.BufferAttribute(u,3)),s(c,"normal",new n.BufferAttribute(i,3)),s(c,"position",new n.BufferAttribute(r,3)),o&&o.length&&s(c,"uv",new n.BufferAttribute(o,2)),c.setIndex(new n.BufferAttribute(a,1)),c}function b(t){for(var e={},n={},r=0;r<t.length;++r){var i=t[r];for(var o in i)void 0===e[o]&&(e[o]=[],n[o]=0),e[o].push(i[o]),n[o]+=i[o].length}var a={},s=0,c=new Uint32Array(n.indices);for(var u in e)if("indices"===u)for(var l=e[u],h=0,f=0,d=l.length;f<d;f++){for(var v=l[f],g=0,p=v.length;g<p;g++)c[h]=v[g]+s,h++;s+=e.position[f].length/3}else{var x=_(e[u],n[u]);if(!x)return null;a[u]=x}return a.indices=c,a}function _(t,e){for(var n=new Float32Array(e),r=0,i=0;i<t.length;++i)n.set(t[i],r),r+=t[i].length;return n}function w(t){var e=t.position,r=t.normal,i=t.uv,o=t.indices,a=new n.BufferGeometry;return s(a,"normal",new n.BufferAttribute(new Float32Array(r),3)),s(a,"position",new n.BufferAttribute(new Float32Array(e),3)),s(a,"uv",new n.BufferAttribute(new Float32Array(i),2)),a.setIndex(new n.BufferAttribute(new Uint32Array(o),1)),a}function M(t){var e=new n.BufferGeometry;return s(e,"normal",t.getAttribute("normal")),s(e,"position",t.getAttribute("position").clone()),e.setIndex(t.getIndex()),e}function O(){if(!x){var t=1e-6;x=new n.BoxBufferGeometry(t,t,t)}return x}var S=Object.freeze({__proto__:null,mergeBufferGeometries:m,mergeBufferGeometriesAttribute:b,generateBufferGeometry:w,generatePickBufferGeometry:M,getDefaultBufferGeometry:O}),j={},A=new n.BoxBufferGeometry(1,1,1);A.translate(0,0,.5);var C=new n.Color("#fff"),T=new n.Color("#fff");function L(t){var e=t.height,r=t.radialSegments,i=t.radius,o=function(t){if(void 0===t&&(t=6),!j[t]){var e=new n.CylinderBufferGeometry(1,1,1,t,1);e.rotateX(Math.PI/2),e.translate(0,0,.5),e.rotateZ(Math.PI/6),j[t]=e}return j[t]}(r).clone();return o.scale(i,i,e),o}function B(t,e,r,i,o){void 0===i&&(i="y"),void 0===o&&(o=0);var a=0;"y"===i?a=1:"z"===i&&(a=2);var c=t.attributes.position.array,u=c.length;T.setStyle(e),C.setStyle(r);for(var l=new Float32Array(u),h=0;h<u;h+=3){c[h+a]>o?(l[h]=C.r,l[h+1]=C.g,l[h+2]=C.b):(l[h]=T.r,l[h+1]=T.g,l[h+2]=T.b)}return s(t,"color",new n.BufferAttribute(l,3,!0)),l}function z(t){for(var e=[],r=t.length,i=0,o=0;o<r;o++){var a=t[o].attributes.color;a&&(i+=a.array.length)}for(var c=new Float32Array(i),u=0,l=0,h=t.length;l<h;l++){var f=t[l].attributes,d=f.color,v=f.normal,g=f.position,p=f.uv,x=t[l].index;d&&(c.set(d.array,u),u+=d.array.length),e.push({normal:v.array,uv:p.array,position:g.array,indices:x.array})}var y=m(e);c.length&&s(y,"color",new n.BufferAttribute(c,3,!0));for(var b=0,_=t.length;b<_;b++)t[b].dispose();return y}function P(){return A}var k={radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61"},V=function(t){function n(n,r,i,o){var a;r=e.Util.extend({},k,r,{layer:o,coordinate:n}),(a=t.call(this)||this)._initOptions(r);var s=r,u=s.height,l=s.radius,h=s.topColor,f=s.bottomColor,d=s.altitude;r.height=o.distanceToVector3(u,u).x,r.radius=o.distanceToVector3(l,l).x,r._radius=a.options.radius,r._height=a.options.height;var v=L(r);h&&(B(v,f,h,"z",r.height/2),i.vertexColors=c()),a._createMesh(v,i);var g=o.distanceToVector3(d,d).x,p=o.coordinateToVector3(n,g);return a.getObject3d().position.copy(p),a.type="Bar",a}return r(n,t),n}(y);function I(t,e,n){return void 0===n&&(n={}),void 0===n[t]&&(n[t]=e.distanceToVector3(t,t).x),n[t]}function E(t){void 0===t&&(t=[]);for(var n=0,r=0,i=t.length,o=0;o<i;o++){var a=t[o],s=a.coordinate,c=a.lnglat,u=a.lnglats,l=a.xy,h=a.xys,f=s||c||u||l||h||t[o],d=void 0,v=void 0;Array.isArray(f)?(d=f[0],v=f[1]):f instanceof e.Coordinate&&(d=f.x,v=f.y),n+=d,r+=v}return new e.Coordinate(n/i,r/i)}function U(t,e,r,i){if(void 0===e||"number"!=typeof e||0===e)return 0;var o,a=0;if(o=t instanceof n.BufferGeometry?t.attributes.position.array:Array.isArray(t)?t:t.position){i?(void 0===i[e]&&(i[e]=r.distanceToVector3(e,e).x),a=i[e]):a=r.distanceToVector3(e,e).x;var s=o.length;if(o[0]instanceof n.Vector3)for(var c=0;c<s;c++)o[c].z+=a;else for(var u=0;u<s;u+=3)o[u+2]+=a}return a}function R(t){for(var e=t.length,n=0,r=0;r<e;r++){n+=t[r].position.count}return new Float32Array(3*n)}var Z=F,G=F;function F(t,e,n){n=n||2;var r,i,o,a,s,c,u,l=e&&e.length,h=l?e[0]*n:t.length,f=D(t,0,h,n,!0),d=[];if(!f||f.next===f.prev)return d;if(l&&(f=function(t,e,n,r){var i,o,a,s=[];for(i=0,o=e.length;i<o;i++)(a=D(t,e[i]*r,i<o-1?e[i+1]*r:t.length,r,!1))===a.next&&(a.steiner=!0),s.push(tt(a));for(s.sort(X),i=0;i<s.length;i++)Q(s[i],n),n=H(n,n.next);return n}(t,e,f,n)),t.length>80*n){r=o=t[0],i=a=t[1];for(var v=n;v<h;v+=n)(s=t[v])<r&&(r=s),(c=t[v+1])<i&&(i=c),s>o&&(o=s),c>a&&(a=c);u=0!==(u=Math.max(o-r,a-i))?1/u:0}return W(f,d,n,r,i,u),d}function D(t,e,n,r,i){var o,a;if(i===dt(t,e,n,r)>0)for(o=e;o<n;o+=r)a=lt(o,t[o],t[o+1],a);else for(o=n-r;o>=e;o-=r)a=lt(o,t[o],t[o+1],a);return a&&it(a,a.next)&&(ht(a),a=a.next),a}function H(t,e){if(!t)return t;e||(e=t);var n,r=t;do{if(n=!1,r.steiner||!it(r,r.next)&&0!==rt(r.prev,r,r.next))r=r.next;else{if(ht(r),(r=e=r.prev)===r.next)break;n=!0}}while(n||r!==e);return e}function W(t,e,n,r,i,o,a){if(t){!a&&o&&function(t,e,n,r){var i=t;do{null===i.z&&(i.z=$(i.x,i.y,e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,function(t){var e,n,r,i,o,a,s,c,u=1;do{for(n=t,t=null,o=null,a=0;n;){for(a++,r=n,s=0,e=0;e<u&&(s++,r=r.nextZ);e++);for(c=u;s>0||c>0&&r;)0!==s&&(0===c||!r||n.z<=r.z)?(i=n,n=n.nextZ,s--):(i=r,r=r.nextZ,c--),o?o.nextZ=i:t=i,i.prevZ=o,o=i;n=r}o.nextZ=null,u*=2}while(a>1)}(i)}(t,r,i,o);for(var s,c,u=t;t.prev!==t.next;)if(s=t.prev,c=t.next,o?N(t,r,i,o):q(t))e.push(s.i/n),e.push(t.i/n),e.push(c.i/n),ht(t),t=c.next,u=c.next;else if((t=c)===u){a?1===a?W(t=K(H(t),e,n),e,n,r,i,o,2):2===a&&J(t,e,n,r,i,o):W(H(t),e,n,r,i,o,1);break}}}function q(t){var e=t.prev,n=t,r=t.next;if(rt(e,n,r)>=0)return!1;for(var i=t.next.next;i!==t.prev;){if(et(e.x,e.y,n.x,n.y,r.x,r.y,i.x,i.y)&&rt(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function N(t,e,n,r){var i=t.prev,o=t,a=t.next;if(rt(i,o,a)>=0)return!1;for(var s=i.x<o.x?i.x<a.x?i.x:a.x:o.x<a.x?o.x:a.x,c=i.y<o.y?i.y<a.y?i.y:a.y:o.y<a.y?o.y:a.y,u=i.x>o.x?i.x>a.x?i.x:a.x:o.x>a.x?o.x:a.x,l=i.y>o.y?i.y>a.y?i.y:a.y:o.y>a.y?o.y:a.y,h=$(s,c,e,n,r),f=$(u,l,e,n,r),d=t.prevZ,v=t.nextZ;d&&d.z>=h&&v&&v.z<=f;){if(d!==t.prev&&d!==t.next&&et(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&rt(d.prev,d,d.next)>=0)return!1;if(d=d.prevZ,v!==t.prev&&v!==t.next&&et(i.x,i.y,o.x,o.y,a.x,a.y,v.x,v.y)&&rt(v.prev,v,v.next)>=0)return!1;v=v.nextZ}for(;d&&d.z>=h;){if(d!==t.prev&&d!==t.next&&et(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&rt(d.prev,d,d.next)>=0)return!1;d=d.prevZ}for(;v&&v.z<=f;){if(v!==t.prev&&v!==t.next&&et(i.x,i.y,o.x,o.y,a.x,a.y,v.x,v.y)&&rt(v.prev,v,v.next)>=0)return!1;v=v.nextZ}return!0}function K(t,e,n){var r=t;do{var i=r.prev,o=r.next.next;!it(i,o)&&ot(i,r,r.next,o)&&ct(i,o)&&ct(o,i)&&(e.push(i.i/n),e.push(r.i/n),e.push(o.i/n),ht(r),ht(r.next),r=t=o),r=r.next}while(r!==t);return H(r)}function J(t,e,n,r,i,o){var a=t;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&nt(a,s)){var c=ut(a,s);return a=H(a,a.next),c=H(c,c.next),W(a,e,n,r,i,o),void W(c,e,n,r,i,o)}s=s.next}a=a.next}while(a!==t)}function X(t,e){return t.x-e.x}function Q(t,e){if(e=function(t,e){var n,r=e,i=t.x,o=t.y,a=-1/0;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var s=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=i&&s>a){if(a=s,s===i){if(o===r.y)return r;if(o===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==e);if(!n)return null;if(i===a)return n;var c,u=n,l=n.x,h=n.y,f=1/0;r=n;do{i>=r.x&&r.x>=l&&i!==r.x&&et(o<h?i:a,o,l,h,o<h?a:i,o,r.x,r.y)&&(c=Math.abs(o-r.y)/(i-r.x),ct(r,t)&&(c<f||c===f&&(r.x>n.x||r.x===n.x&&Y(n,r)))&&(n=r,f=c)),r=r.next}while(r!==u);return n}(t,e)){var n=ut(e,t);H(e,e.next),H(n,n.next)}}function Y(t,e){return rt(t.prev,t,e.prev)<0&&rt(e.next,t,t.next)<0}function $(t,e,n,r,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*i)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*i)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function tt(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function et(t,e,n,r,i,o,a,s){return(i-a)*(e-s)-(t-a)*(o-s)>=0&&(t-a)*(r-s)-(n-a)*(e-s)>=0&&(n-a)*(o-s)-(i-a)*(r-s)>=0}function nt(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&ot(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(ct(t,e)&&ct(e,t)&&function(t,e){var n=t,r=!1,i=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(rt(t.prev,t,e.prev)||rt(t,e.prev,e))||it(t,e)&&rt(t.prev,t,t.next)>0&&rt(e.prev,e,e.next)>0)}function rt(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function it(t,e){return t.x===e.x&&t.y===e.y}function ot(t,e,n,r){var i=st(rt(t,e,n)),o=st(rt(t,e,r)),a=st(rt(n,r,t)),s=st(rt(n,r,e));return i!==o&&a!==s||(!(0!==i||!at(t,n,e))||(!(0!==o||!at(t,r,e))||(!(0!==a||!at(n,t,r))||!(0!==s||!at(n,e,r)))))}function at(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function st(t){return t>0?1:t<0?-1:0}function ct(t,e){return rt(t.prev,t,t.next)<0?rt(t,e,t.next)>=0&&rt(t,t.prev,e)>=0:rt(t,e,t.prev)<0||rt(t,t.next,e)<0}function ut(t,e){var n=new ft(t.i,t.x,t.y),r=new ft(e.i,e.x,e.y),i=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=i,i.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function lt(t,e,n,r){var i=new ft(t,e,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function ht(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function ft(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function dt(t,e,n,r){for(var i=0,o=e,a=n-r;o<n;o+=r)i+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return i}function vt(t,e,n){var r=e[0],i=e[1],o=n[0]-r,a=n[1]-i;if(0!==o||0!==a){var s=((t[0]-r)*o+(t[1]-i)*a)/(o*o+a*a);s>1?(r=n[0],i=n[1]):s>0&&(r+=o*s,i+=a*s)}return(o=t[0]-r)*o+(a=t[1]-i)*a}function gt(t,e,n,r,i){for(var o,a=r,s=e+1;s<n;s++){var c=vt(t[s],t[e],t[n]);c>a&&(o=s,a=c)}a>r&&(o-e>1&&gt(t,e,o,r,i),i.push(t[o]),n-o>1&&gt(t,o,n,r,i))}function pt(t,e){var n=t.length-1,r=[t[0]];return gt(t,0,n,e,r),r.push(t[n]),r}function xt(t,e,n){if(t.length<=2)return t;var r=void 0!==e?e*e:1;return t=pt(t=n?t:function(t,e){for(var n,r,i,o,a,s=t[0],c=[s],u=1,l=t.length;u<l;u++)n=t[u],i=s,o=void 0,a=void 0,o=(r=n)[0]-i[0],a=r[1]-i[1],o*o+a*a>e&&(c.push(n),s=n);return s!==n&&c.push(n),c}(t,r),r)}function yt(t,e){return t[0]*e[0]+t[1]*e[1]}function mt(t,e){const n=e[0],r=e[1],i=Math.sqrt(n*n+r*r);return t[0]=n/i,t[1]=r/i,t}function bt(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t}function _t(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t}function wt(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function Mt(t,e){const n=e[0],r=e[1],i=e[2],o=Math.sqrt(n*n+r*r+i*i);return t[0]=n/o,t[1]=r/o,t[2]=i/o,t}function Ot(t,e,n){var r=e[0],i=e[1],o=e[2],a=n[0],s=n[1],c=n[2];return t[0]=i*c-o*s,t[1]=o*a-r*c,t[2]=r*s-i*a,t}F.deviation=function(t,e,n,r){var i=e&&e.length,o=i?e[0]*n:t.length,a=Math.abs(dt(t,0,o,n));if(i)for(var s=0,c=e.length;s<c;s++){var u=e[s]*n,l=s<c-1?e[s+1]*n:t.length;a-=Math.abs(dt(t,u,l,n))}var h=0;for(s=0;s<r.length;s+=3){var f=r[s]*n,d=r[s+1]*n,v=r[s+2]*n;h+=Math.abs((t[f]-t[v])*(t[d+1]-t[f+1])-(t[f]-t[d])*(t[v+1]-t[f+1]))}return 0===a&&0===h?0:Math.abs((h-a)/a)},F.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},r=0,i=0;i<t.length;i++){for(var o=0;o<t[i].length;o++)for(var a=0;a<e;a++)n.vertices.push(t[i][o][a]);i>0&&(r+=t[i-1].length,n.holes.push(r))}return n},Z.default=G;const St=[];function jt(t,e,n,r){const i=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}(e,n),o=Math.acos(i)*r;return bt(St,n,e,-i),function(t,e){const n=e[0],r=e[1],i=e[2],o=Math.sqrt(n*n+r*r+i*i);t[0]=n/o,t[1]=r/o,t[2]=i/o}(St,St),function(t,e,n){t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n}(t,e,Math.cos(o)),bt(t,t,St,Math.sin(o)),t}function At(t,e,n){if(n-e<3)return 0;let r=0;for(let i=2*(n-1),o=2*e;o<2*n;){const e=t[i],n=t[i+1],a=t[o],s=t[o+1];i=o,o+=2,r+=e*s-a*n}return r}function Ct(t,e,n=2){return Z(t,e,n)}const Tt=[],Lt=[],Bt=[];function zt(t,e,n,r,i,o,a,s){const c=null!=a;let u=i,l=null;c&&(l=new Uint32Array(r-n));for(let i=n;i<r;i++){const h=i===r-1?n:i+1,f=i===n?r-1:i-1,d=t[2*f],v=t[2*f+1],g=t[2*i],p=t[2*i+1],x=t[2*h],y=t[2*h+1];if(Tt[0]=g-d,Tt[1]=p-v,Lt[0]=x-g,Lt[1]=y-p,mt(Tt,Tt),mt(Lt,Lt),c&&(l[i]=u),s||i!==n)if(s||i!==r-1){_t(Bt,Lt,Tt);const t=Bt[1];Bt[1]=-Bt[0],Bt[0]=t,mt(Bt,Bt);const n=yt(Bt,Lt),r=Math.sqrt(1-n*n),i=o*Math.min(10,1/r),s=o*n<0;if(c&&1/r>a&&s){const t=g+Bt[0]*o,n=p+Bt[1]*o,i=Math.acos(r)/2,a=Math.tan(i)*Math.abs(o);e[2*u]=t+Bt[1]*a,e[2*u+1]=n-Bt[0]*a,u++,e[2*u]=t-Bt[1]*a,e[2*u+1]=n+Bt[0]*a,u++}else e[2*u]=g+Bt[0]*i,e[2*u+1]=p+Bt[1]*i,u++}else Bt[0]=Tt[1],Bt[1]=-Tt[0],mt(Bt,Bt),e[2*u]=g+Bt[0]*o,e[2*u+1]=p+Bt[1]*o,u++;else Bt[0]=Lt[1],Bt[1]=-Lt[0],mt(Bt,Bt),e[2*u]=g+Bt[0]*o,e[2*u+1]=p+Bt[1]*o,u++}return l}function Pt(t,e,n,r,i){const o=null!=r?[]:new Float32Array(t.length);if(zt(t,o,0,e&&e.length?e[0]:t.length/2,0,n,r,i),e)for(let a=0;a<e.length;a++){const s=e[a];zt(t,o,s,e[a+1]||t.length/2,null!=r?o.length/2:s,n,r,i)}return o}function kt(t,e,n,r){for(let i=0;i<Math.floor((r-n)/2);i++)for(let o=0;o<e;o++){const a=(i+n)*e+o,s=(r-i-1)*e+o,c=t[a];t[a]=t[s],t[s]=c}return t}function Vt(t,e){let n=t.length/2,r=0,i=e&&e.length?e[0]:n;At(t,r,i)>0&&kt(t,2,r,i);for(let o=1;o<(e?e.length:0)+1;o++)r=e[o-1],i=e[o]||n,At(t,r,i)<0&&kt(t,2,r,i)}function It(t){t.depth=t.depth||1,t.bevelSize=t.bevelSize||0,t.bevelSegments=null==t.bevelSegments?2:t.bevelSegments,t.smoothSide=t.smoothSide||!1,t.smoothBevel=t.smoothBevel||!1,t.simplify=t.simplify||0,"number"==typeof t.depth&&(t.bevelSize=Math.min(t.bevelSegments>0?t.bevelSize:0,t.depth/2)),t.bevelSize>0||(t.bevelSegments=0),t.bevelSegments=Math.round(t.bevelSegments);const e=t.boundingRect;if(t.translate=t.translate||[0,0],t.scale=t.scale||[1,1],t.fitRect){let n=null==t.fitRect.x?e.x||0:t.fitRect.x,r=null==t.fitRect.y?e.y||0:t.fitRect.y,i=t.fitRect.width,o=t.fitRect.height;null==i?null!=o?i=o/e.height*e.width:(i=e.width,o=e.height):null==o&&(o=i/e.width*e.height),t.scale=[i/e.width,o/e.height],t.translate=[(n-e.x)*t.scale[0],(r-e.y)*t.scale[1]]}}const Et=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function Ut(t,{vertices:e,topVertices:n,depth:r,rect:i},o,a,s,c){const u=a-o,l=c.smoothSide?1:2,h=u*l,f=c.smoothBevel?1:2,d=Math.min(r/2,c.bevelSize),v=c.bevelSegments,g=s.vertex,p=Math.max(i.width,i.height,r);if(d>0){const i=[0,0,1],a=[],c=[0,0,-1],x=[];let y=0,m=new Float32Array(u);for(let b=0;b<2;b++){const _=0===b?r-d:d;for(let r=0;r<=v*f;r++){let w,M,O=0;for(let S=0;S<u;S++){for(let g=0;g<l;g++){let l=2*((S+g)%u+o);a[0]=e[l]-n[l],a[1]=e[l+1]-n[l+1],a[2]=0;const y=Math.sqrt(a[0]*a[0]+a[1]*a[1]);a[0]/=y,a[1]/=y;const j=(Math.floor(r/f)+r%f)/v;0===b?jt(x,i,a,j):jt(x,a,c,j);const A=0===b?j:1-j,C=d*Math.sin(A*Math.PI/2),T=y*Math.cos(A*Math.PI/2),L=d*y/Math.sqrt(C*C+T*T),B=x[0]*L+n[l],z=x[1]*L+n[l+1],P=x[2]*L+_;if(t.position[3*s.vertex]=B,t.position[3*s.vertex+1]=z,t.position[3*s.vertex+2]=P,(S>0||g>0)&&(O+=Math.sqrt((w-B)*(w-B)+(M-z)*(M-z))),r>0||b>0){let e=3*(s.vertex-h),n=t.position[e],r=t.position[e+1],i=t.position[e+2];m[S]+=Math.sqrt((n-B)*(n-B)+(r-z)*(r-z)+(i-P)*(i-P))}t.uv[2*s.vertex]=O/p,t.uv[2*s.vertex+1]=m[S]/p,w=B,M=z,s.vertex++}if(f>1&&r%f||1===f&&r>=1)for(let e=0;e<6;e++){const n=(Et[e][0]+S*l)%h,r=Et[e][1]+y;t.indices[s.index++]=(r-1)*h+n+g}}y++}}}else for(let n=0;n<2;n++){const i=0===n?r-d:d;let a,c,h=0;for(let n=0;n<u;n++)for(let r=0;r<l;r++){const l=2*((n+r)%u+o),f=e[l],d=e[l+1];t.position[3*s.vertex]=f,t.position[3*s.vertex+1]=d,t.position[3*s.vertex+2]=i,(n>0||r>0)&&(h+=Math.sqrt((a-f)*(a-f)+(c-d)*(c-d))),t.uv[2*s.vertex]=h/p,t.uv[2*s.vertex+1]=i/p,a=f,c=d,s.vertex++}}const x=d>0?v*f+1:1;for(let e=0;e<u;e++)for(let n=0;n<6;n++){const r=(Et[n][0]+e*l)%h,i=Et[n][1]+x;t.indices[s.index++]=(i-1)*h+r+g}}function Rt({indices:t,vertices:e,topVertices:n,rect:r,depth:i},o,a,s){if(e.length<=4)return;const c=a.vertex,u=t.length;for(let e=0;e<u;e++)o.indices[a.index++]=c+t[e];const l=Math.max(r.width,r.height);for(let t=0;t<(s.excludeBottom?1:2);t++)for(let e=0;e<n.length;e+=2){const s=n[e],c=n[e+1];o.position[3*a.vertex]=s,o.position[3*a.vertex+1]=c,o.position[3*a.vertex+2]=(1-t)*i,o.uv[2*a.vertex]=(s-r.x)/l,o.uv[2*a.vertex+1]=(c-r.y)/l,a.vertex++}if(!s.excludeBottom){const n=e.length/2;for(let e=0;e<u;e+=3)for(let r=0;r<3;r++)o.indices[a.index++]=c+n+t[e+2-r]}}function Zt(t,e){let n=0,r=0;for(let i=0;i<t.length;i++){const{indices:o,vertices:a,holes:s,depth:c}=t[i],u=a.length/2,l=Math.min(c/2,e.bevelSize)>0?e.bevelSegments:0;n+=o.length*(e.excludeBottom?1:2),r+=u*(e.excludeBottom?1:2);const h=2+2*l;let f=0,d=0;for(let t=0;t<(s?s.length:0)+1;t++){0===t?d=s&&s.length?s[0]:u:(f=s[t-1],d=s[t]||u),n+=6*(d-f)*(h-1);const i=(d-f)*(e.smoothSide?1:2);r+=i*h+(e.smoothBevel?0:l*i*2)}}const i={position:new Float32Array(3*r),indices:new(r>65535?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*r)},o={vertex:0,index:0};for(let n=0;n<t.length;n++)Rt(t[n],i,o,e);for(let n=0;n<t.length;n++){const{holes:r,vertices:a}=t[n],s=a.length/2;let c=0,u=r&&r.length?r[0]:s;if(Ut(i,t[n],c,u,o,e),r)for(let a=0;a<r.length;a++)c=r[a],u=r[a+1]||s,Ut(i,t[n],c,u,o,e)}for(let t=0;t<i.uv.length;t++){const e=i.uv[t];e>0&&Math.round(e)===e?i.uv[t]=1:i.uv[t]=e%1}return i.normal=function(t,e){function n(t,e,n,r){t[0]=e,t[1]=n,t[2]=r}const r=[],i=[],o=[],a=[],s=[],c=[],u=t.length,l=new Float32Array(e.length);for(let h=0;h<u;){const u=3*t[h++],f=3*t[h++],d=3*t[h++];n(r,e[u],e[u+1],e[u+2]),n(i,e[f],e[f+1],e[f+2]),n(o,e[d],e[d+1],e[d+2]),wt(a,r,i),wt(s,i,o),Ot(c,a,s);for(let t=0;t<3;t++)l[u+t]=l[u+t]+c[t],l[f+t]=l[f+t]+c[t],l[d+t]=l[d+t]+c[t]}for(var h=0;h<l.length;)n(c,l[h],l[h+1],l[h+2]),Mt(c,c),l[h++]=c[0],l[h++]=c[1],l[h++]=c[2];return l}(i.indices,i.position),i.boundingRect=t[0]&&t[0].rect,i}function Gt(t,e,n){const r=n.lineWidth,i=t.length,o=new Float32Array(2*i),a=n.translate||[0,0],s=n.scale||[1,1];for(let e=0,n=0;e<i;e++)o[n++]=t[e][0]*s[0]+a[0],o[n++]=t[e][1]*s[1]+a[1];At(o,0,i)<0&&kt(o,2,0,i);const c=[],u=[],l=n.miterLimit,h=zt(o,u,0,i,0,-r/2,l,!1);kt(o,2,0,i);const f=zt(o,c,0,i,0,-r/2,l,!1),d=(c.length+u.length)/2,v=new Float32Array(2*d);let g=0;const p=u.length/2;for(let t=0;t<u.length;t++)v[g++]=u[t];for(let t=0;t<c.length;t++)v[g++]=c[t];const x=new(d>65535?Uint32Array:Uint16Array)(3*(2*(i-1)+(d-2*i)));let y=0;for(let t=0;t<i-1;t++){const e=t+1;x[y++]=p-1-h[t],x[y++]=p-1-h[t]-1,x[y++]=f[t]+1+p,x[y++]=p-1-h[t],x[y++]=f[t]+1+p,x[y++]=f[t]+p,f[e]-f[t]==2?(x[y++]=f[t]+2+p,x[y++]=f[t]+1+p,x[y++]=p-h[e]-1):h[e]-h[t]==2&&(x[y++]=f[e]+p,x[y++]=p-1-(h[t]+1),x[y++]=p-1-(h[t]+2))}const m=n.bevelSize>0?Pt(v,[],n.bevelSize,null,!0):v,b=n.boundingRect;return{vertices:v,indices:x,topVertices:m,rect:{x:b.x*s[0]+a[0],y:b.y*s[1]+a[1],width:b.width*s[0],height:b.height*s[1]},depth:"function"==typeof n.depth?n.depth(e):n.depth,holes:[]}}function Ft(t,e){const n=[];for(let r=0;r<t.length;r++){const i=t[r],o=[],a=i.length;let s=i[a-1][0],c=i[a-1][1],u=0;for(let t=0;t<a;t++){let n=i[t][0],r=i[t][1];const a=n-s,l=r-c;u+=Math.sqrt(a*a+l*l),u>e&&(o.push(i[t]),u=0),s=n,c=r}o.length>=3&&n.push(o)}return n.length>0?n:null}function Dt(t,e){const n=[];for(let r=0;r<t.length;r++){let i=t[r];i=xt(i,e,!0),i.length>=3&&n.push(i)}return n.length>0?n:null}function Ht(t,e){e=Object.assign({},e);const n=[1/0,1/0],r=[-1/0,-1/0];for(let e=0;e<t.length;e++)qt(t[e][0],n,r);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},It(e);const i=[],o=e.translate||[0,0],a=e.scale||[1,1],s=e.boundingRect,c={x:s.x*a[0]+o[0],y:s.y*a[1]+o[1],width:s.width*a[0],height:s.height*a[1]},u=Math.min(s.width,s.height)/1e5;for(let n=0;n<t.length;n++){let r=Ft(t[n],u);if(!r)continue;const s=e.simplify/Math.max(a[0],a[1]);if(s>0&&(r=Dt(r,s)),!r)continue;const{vertices:l,holes:h,dimensions:f}=Z.flatten(r);for(let t=0;t<l.length;)l[t]=l[t++]*a[0]+o[0],l[t]=l[t++]*a[1]+o[1];if(Vt(l,h),2!==f)throw new Error("Only 2D polygon points are supported");const d=e.bevelSize>0?Pt(l,h,e.bevelSize,null,!0):l,v=Ct(d,h,f);i.push({indices:v,vertices:l,topVertices:d,holes:h,rect:c,depth:"function"==typeof e.depth?e.depth(n):e.depth})}return Zt(i,e)}function Wt(t,e){e=Object.assign({},e);const n=[1/0,1/0],r=[-1/0,-1/0];for(let e=0;e<t.length;e++)qt(t[e],n,r);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},It(e);const i=e.scale||[1,1];null==e.lineWidth&&(e.lineWidth=1),null==e.miterLimit&&(e.miterLimit=2);const o=[];for(let n=0;n<t.length;n++){let r=t[n];const a=e.simplify/Math.max(i[0],i[1]);a>0&&(r=xt(r,a,!0)),o.push(Gt(r,n,e))}return Zt(o,e)}function qt(t,e,n){for(let r=0;r<t.length;r++)e[0]=Math.min(t[r][0],e[0]),e[1]=Math.min(t[r][1],e[1]),n[0]=Math.max(t[r][0],n[0]),n[1]=Math.max(t[r][1],n[1])}var Nt=Object.freeze({__proto__:null,triangulate:Ct,flatten:function(t){return Z.flatten(t)},offsetPolygon:Pt,extrudePolygon:Ht,extrudePolyline:Wt,extrudeGeoJSON:function(t,e){e=Object.assign({},e);const n=[],r=[],i=[],o=[],a=[1/0,1/0],s=[-1/0,-1/0];for(let e=0;e<t.features.length;e++){const c=t.features[e].geometry;if(c&&c.coordinates)switch(c.type){case"LineString":n.push(c.coordinates),i.push(e),qt(c.coordinates,a,s);break;case"MultiLineString":for(let t=0;t<c.coordinates.length;t++)n.push(c.coordinates[t]),i.push(e),qt(c.coordinates[t],a,s);break;case"Polygon":r.push(c.coordinates),o.push(e),qt(c.coordinates[0],a,s);break;case"MultiPolygon":for(let t=0;t<c.coordinates.length;t++)r.push(c.coordinates[t]),o.push(e),qt(c.coordinates[t][0],a,s)}}e.boundingRect=e.boundingRect||{x:a[0],y:a[1],width:s[0]-a[0],height:s[1]-a[1]};const c=e.depth;return{polyline:Wt(n,Object.assign(e,{depth:function(e){return"function"==typeof c?c(t.features[i[e]]):c}})),polygon:Ht(r,Object.assign(e,{depth:function(e){return"function"==typeof c?c(t.features[o[e]]):c}}))}}}),Kt=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"];function Jt(t){return t.geometry?t.geometry.type:null}function Xt(t){var e=Jt(t);if(e)for(var n=0,r=Kt.length;n<r;n++)if(Kt[n]===e)return!0;return!1}function Qt(t){var e=Jt(t);return!(!e||e!==Kt[4]&&e!==Kt[5])}function Yt(t){var e=Jt(t);return!(!e||e!==Kt[2]&&e!==Kt[3])}function $t(t){var e=Jt(t);return!(!e||e!==Kt[0]&&e!==Kt[1])}function te(t){var e=Jt(t);return!!(e&&e.indexOf("Multi")>-1)}function ee(t){return t.geometry?t.geometry.coordinates:[]}function ne(t,n){var r=Jt(t);if(!r||!t.geometry)return null;var i=t.geometry.coordinates;if(!i)return null;var o=0,a=0,s=0;switch(r){case"Point":o=i[0],a=i[1],s++;break;case"MultiPoint":case"LineString":for(var c=0,u=i.length;c<u;c++)o+=i[c][0],a+=i[c][1],s++;break;case"MultiLineString":case"Polygon":for(var l=0,h=i.length;l<h;l++)for(var f=0,d=i[l].length;f<d;f++)o+=i[l][f][0],a+=i[l][f][1],s++;break;case"MultiPolygon":for(var v=0,g=i.length;v<g;v++)for(var p=0,x=i[v].length;p<x;p++)for(var y=0,m=i[v][p].length;y<m;y++)o+=i[v][p][y][0],a+=i[v][p][y][1],s++}var b=o/s,_=a/s;return n?(n.x=b,n.y=_,n):new e.Coordinate(b,_)}function re(t){var e=Jt(t);if(!e||!t.geometry)return null;var n=t.geometry,r=t.properties||{},i=n.coordinates;if(!i)return null;var o,a=[];switch(e){case"MultiPoint":o="Point";break;case"MultiLineString":o="LineString";break;case"MultiPolygon":o="Polygon"}if(o)for(var s=0,c=i.length;s<c;s++)a.push({type:"Feature",geometry:{type:o,coordinates:i[s]},properties:r});else a.push(t);return a}var ie=Object.freeze({__proto__:null,isGeoJSON:Xt,isGeoJSONPolygon:Qt,isGeoJSONLine:Yt,isGeoJSONPoint:$t,isGeoJSONMulti:te,getGeoJSONCoordinates:ee,getGeoJSONCenter:ne,spliteGeoJSONMulti:re});function oe(t,r,i){var o=[];if(Array.isArray(t)&&t[0]instanceof n.Vector3)for(var a=0,s=t.length;a<s;a++){var c=t[a];o.push(c)}else{Array.isArray(t)&&(t=new e.LineString(t));var u,l;Xt(t)?(u=ee(t),i||(l=ne(t))):t instanceof e.LineString&&(u=t.getCoordinates(),i||(l=t.getCenter()));for(var h=r.coordinateToVector3(i||l),f=0,d=u.length;f<d;f++){var v=u[f],g=r.coordinateToVector3(v,0).sub(h);o.push(g)}}for(var p=new Float32Array(3*o.length),x=new Float32Array(2*o.length),y=0,m=o.length;y<m;y++){var b=3*y,_=o[y];p[b]=_.x,p[b+1]=_.y,p[b+2]=_.z;var w=2*y;x[w]=_.x,x[w+1]=_.y}return{positions:p,positionsV:o,positions2d:x}}function ae(t,e,n,r){for(var i=[],o=[],a=[],s=0,c=t.length;s<c;s++)for(var u=t[s],l=0,h=u.length;l<h;l++){var f=u[l];if(a.length>0)f.join(",").toString()!==a[a.length-1].join(",").toString()&&a.push(f);else a.push(f)}for(var d=0,v=a.length;d<v;d++){var g=a[d],p=void 0,x=g.join(",").toString();p=n&&n[x]?n[x]:e.coordinateToVector3(g,0).sub(r),o.push(p),i.push(p.x,p.y,p.z)}return{positions:i,positionsV:o,lnglats:a}}function se(t,e,n,r,i){void 0===e&&(e=1),void 0===n&&(n=1);for(var o=oe(t,r,i).positionsV,a=[],s=0,c=o.length;s<c;s++){var u=o[s];a.push([u.x,u.y])}var l=Wt([a],{lineWidth:e,depth:n}),h=l.indices;return{position:l.position,normal:l.normal,indices:h,uv:l.uv}}function ce(t){var n,r=[];return t instanceof e.MultiLineString?(r=t.getGeometries(),n=t.getCenter()):t instanceof e.LineString?(r.push(t),n=t.getCenter()):Xt(t)&&(n=ne(t),te(t)?r=re(t):r.push(t)),{lineStrings:r,center:n}}function ue(t,e){for(var n=0,r=e.length;n<r;n++){var i=e[n];n>0&&n<r-1&&t.push(i.x,i.y,i.z),t.push(i.x,i.y,i.z)}}var le=Object.freeze({__proto__:null,getLinePosition:oe,getExtrudeLineGeometry:function(t,e,r,i,o){void 0===e&&(e=1),void 0===r&&(r=1);var a=se(t,e,r,i,o),c=a.indices,u=a.position,l=a.normal,h=a.uv,f=new n.BufferGeometry;return s(f,"position",new n.BufferAttribute(u,3)),s(f,"normal",new n.BufferAttribute(l,3)),s(f,"uv",new n.BufferAttribute(h,2)),f.setIndex(new n.BufferAttribute(c,1)),f},getChunkLinesPosition:ae,getExtrudeLineParams:se,LineStringSplit:ce,setLineSegmentPosition:ue});var he={altitude:0,bottomHeight:0,colors:null},fe=function(t){function i(r,i,o,a){var u;i=e.Util.extend({},he,i,{layer:a,lineString:r}),(u=t.call(this)||this)._initOptions(i);for(var l=ce(r),h=l.lineStrings,f=l.center,d=[],v=0,g=h.length;v<g;v++){ue(d,oe(h[v],a,f).positionsV)}var p=new n.BufferGeometry;s(p,"position",new n.Float32BufferAttribute(d,3)),U(p,i.bottomHeight,a);var x=function(t){var e=[];return t&&t.length&&t.forEach((function(t){t=t instanceof n.Color?t:new n.Color(t),e.push(t.r,t.g,t.b)})),e}(i.colors);x&&x.length&&(s(p,"color",new n.Float32BufferAttribute(x,3)),o.vertexColors=c()),u._createLineSegments(p,o);var y=i.altitude,m=a.distanceToVector3(y,y).x,b=a.coordinateToVector3(f,m);return u.getObject3d().position.copy(b),u.type="Line",u}return r(i,t),i}(y),de=new n.Color("#fff"),ve=new n.Color("#fff");function ge(t,e,r,i){var o=pe(t,e,r,i),a=o.position,c=o.normal,u=o.uv,l=o.indices,h=new Float32Array(a.length);h.fill(1,0,a.length);var f=new n.BufferGeometry;return s(f,"color",new n.BufferAttribute(h,3)),s(f,"normal",new n.BufferAttribute(c,3)),s(f,"position",new n.BufferAttribute(a,3)),s(f,"uv",new n.BufferAttribute(u,2)),f.setIndex(new n.Uint32BufferAttribute(l,1)),f}function pe(t,e,n,r,i,o){var a=ye(t,n,r,i,!1);if(!a)return null;o?(null==o[e]&&(o[e]=n.distanceToVector3(e,e).x),e=o[e]):e=n.distanceToVector3(e,e).x;var s=Ht(a,{depth:e});return{position:s.position,normal:s.normal,uv:s.uv,indices:s.indices}}function xe(t,e,r,i){void 0===i&&(i=0);var o,a=t.attributes.position.array,c=a.length;if(ve.setStyle(e),de.setStyle(r),Array.isArray(i)){for(var u=0,l=0,h=i.length;l<h;l++){u+=3*i[l].position.count}o=new Float32Array(u)}else o=new Float32Array(a.length);if(Array.isArray(i))for(var f=0,d=i.length;f<d;f++)for(var v=i[f].position,g=v.middleZ,p=v.start,x=v.end,y=p;y<x;y+=3){a[y+2]>g?(o[y]=de.r,o[y+1]=de.g,o[y+2]=de.b):(o[y]=ve.r,o[y+1]=ve.g,o[y+2]=ve.b)}else for(var m=0;m<c;m+=3){a[m+2]>i?(o[m]=de.r,o[m+1]=de.g,o[m+2]=de.b):(o[m]=ve.r,o[m+1]=ve.g,o[m+2]=ve.b)}return s(t,"color",new n.BufferAttribute(o,3,!0)),o}function ye(t,n,r,i,o){if(void 0===o&&(o=!1),!t)return null;var a=[];if(t instanceof e.MultiPolygon)a=t.getGeometries().map((function(e){return me(e,n,r||t.getCenter(),i,o)}));else if(t instanceof e.Polygon){var s=me(t,n,r||t.getCenter(),i,o);a.push(s)}else if(Qt(t))if(te(t))for(var c=re(t),u=0,l=c.length;u<l;u++)a.push(me(c[u],n,r||ne(t),i,o));else{var h=me(t,n,r||ne(t),i,o);a.push(h)}return a}function me(t,n,r,i,o){var a,s,c;if(void 0===o&&(o=!1),Qt(t)){var u=ee(t);a=u[0],s=u.slice(1,u.length),r=r||ne(t)}else t instanceof e.Polygon&&(a=t.getShell(),s=t.getHoles(),r=r||t.getCenter());i=i||n.coordinateToVector3(r),c=o?new Float32Array(2*a.length):[];for(var l=0,h=a.length;l<h;l++){var f=a[l],d=n.coordinateToVector3(f).sub(i);if(o){var v=2*l;c[v]=d.x,c[v+1]=d.y}else c.push([d.x,d.y])}var g=[o?c.buffer:c];if(s&&s.length>0)for(var p=0,x=s.length;p<x;p++){for(var y=o?new Float32Array(2*s[p].length):[],m=0,b=s[p].length;m<b;m++){var _=s[p][m],w=n.coordinateToVector3(_).sub(i);if(o){var M=2*m;y[M]=w.x,y[M+1]=w.y}else y.push([w.x,w.y])}g.push(o?y.buffer:y)}return g}var be=Object.freeze({__proto__:null,getExtrudeGeometry:ge,getExtrudeGeometryParams:pe,initVertexColors:xe,getPolygonPositions:ye,getSinglePolygonPositions:me}),_e={bottomHeight:0,width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61"},we=function(t){function n(n,r,i,o){var a;r=e.Util.extend({},_e,r,{layer:o,lineString:n}),(a=t.call(this)||this)._initOptions(r);for(var s=r,u=s.height,l=s.width,h=s.bottomColor,f=s.topColor,d=s.bottomHeight,v=s.altitude,g=o.distanceToVector3(u,u).x,p=o.distanceToVector3(l,l).x,x=ce(n),y=x.lineStrings,b=x.center,_=[],w=0,M={},O=0,S=y.length;O<S;O++){var j=se(y[O],p,g,o,b);w=U(j,d,o,M),_.push(j)}var A=m(_);f&&(xe(A,h,f,w+g/2),i.vertexColors=c()),a._createMesh(A,i);var C=o.distanceToVector3(v,v).x,T=o.coordinateToVector3(b,C);return a.getObject3d().position.copy(T),a.type="ExtrudeLine",a}return r(n,t),n}(y),Me={altitude:0,height:1,bottomHeight:0,topColor:null,bottomColor:"#2d2f61"},Oe=function(t){function n(n,r,i,o){var a;r=e.Util.extend({},Me,r,{layer:o,polygon:n}),(a=t.call(this)||this)._initOptions(r);var s=r,u=s.height,l=s.topColor,h=s.bottomColor,f=s.altitude,d=s.bottomHeight,v=ge(n,u,o),g=Qt(n)?ne(n):n.getCenter(),p=U(v,d,o);l&&(xe(v,h,l,p+o.distanceToVector3(u,u).x/2),i.vertexColors=c());a._createMesh(v,i);var x=o.distanceToVector3(f,f).x,y=o.coordinateToVector3(g,x);return a.getObject3d().position.copy(y),a.type="ExtrudePolygon",a}return r(n,t),n}(y),Se={altitude:0,coordinate:null},je=function(t){function n(n,r,i){var o;void 0===r&&(r={}),r.coordinate||(console.warn("coordinate is null,it is important to locate the model"),r.coordinate=i.getMap().getCenter()),r=e.Util.extend({},Se,r,{layer:i,model:n}),(o=t.call(this)||this)._initOptions(r),o._createGroup(),o.getObject3d().add(n);var a=r,s=a.altitude,c=a.coordinate,u=i.distanceToVector3(s,s).x,l=i.coordinateToVector3(c,u);return o.getObject3d().position.copy(l),o.type="Model",o}return r(n,t),n}(y),Ae=Math.PI/180;function Ce(t){return t.getCoordinates().map((function(t){return t.toArray()}))}function Te(t){return t*Ae}function Le(t,e){if(!t||!e)return 0;Array.isArray(t)||(t=t.toArray()),Array.isArray(e)||(e=e.toArray());var n=Te(t[1]),r=Te(e[1]),i=n-r,o=Te(t[0])-Te(e[0]);return n=2*Math.asin(Math.sqrt(Math.pow(Math.sin(i/2),2)+Math.cos(n)*Math.cos(r)*Math.pow(Math.sin(o/2),2))),n*=6378137,Math.round(1e5*n)/1e5}function Be(t,e){var n=t.len,r=t.c1,i=t.c2,o=i[0]-r[0],a=i[1]-r[1],s=e/n;return[r[0]+s*o,r[1]+s*a]}function ze(t,e){void 0===e&&(e=10),e=Math.max(e,1),Array.isArray(t)||(t=Ce(t));for(var n=t.length,r=[],i=0,o=0;o<n-1;o++){var a=Le(t[o],t[o+1]),s=Math.floor(a);r.push({c1:t[o],len:s,c2:t[o+1]}),i+=s}if(i<=e)return r.map((function(t){return[t.c1,t.c2]}));if(1===r.length&&r[0].len<=e)return[[r[0].c1,r[0].c2]];for(var c,u=r.length,l=0,h=0,f=[],d=[r[0].c1];l<u;){var v=r[l],g=v.len,p=v.c2;if((h+=g)<e&&(d.push(p),l===u-1&&f.push(d),l++),h===e&&(d.push(p),h=0,f.push(d),d=[p],l++),h>e){var x=g-h+e;c=Be(r[l],x),d.push(c),f.push(d),h=0,r[l].c1=c,r[l].len=g-x,(d=[]).push(c)}}return f}var Pe=Object.freeze({__proto__:null,distance:Le,lineLength:function(t){var e=t;Array.isArray(t)||(e=Ce(t));for(var n=0,r=0,i=e.length;r<i-1;r++)n+=Le(e[r],e[r+1]);return n},lineSlice:ze}),ke=1e3;function Ve(t,e,n,r){var i=e.length;t.attributes.normal.count=i,t.attributes.position.count=i;for(var o=t.attributes.position.array,a=t.attributes.normal.array,s=0;s<i;s++)o[s]=e[s],a[s]=n[s];t.index.count=r.length;for(var c=0,u=r.length;c<u;c++)t.index.array[c]=r[c]}var Ie={trail:5,chunkLength:50,width:2,height:1,speed:1,altitude:0,interactive:!1},Ee=function(t){function i(r,i,o,a){var c;i=e.Util.extend({},Ie,i,{layer:a,lineString:r}),(c=t.call(this)||this)._initOptions(i);var u,l,h=i,f=h.width,d=h.height,v=h.altitude,g=h.speed,p=h.chunkLength,x=h.trail;Xt(r)?(u=ne(r),l=ee(r)):(u=r.getCenter(),l=r);for(var y=ze(l,p),m=a.coordinateToVector3(u),b={},_=0,w=y.length;_<w;_++)for(var M=y[_],O=0,S=M.length;O<S;O++){var j=M[O],A=j.join(",").toString();b[A]||(b[A]=a.coordinateToVector3(j).sub(m))}var C=ae(y.slice(0,1),a,b,m).positionsV,T=new n.BufferGeometry,L=new Float32Array(3e3),B=new Float32Array(3e3),z=new Uint16Array(ke);s(T,"position",new n.BufferAttribute(L,3)),s(T,"normal",new n.BufferAttribute(B,3)),T.setIndex(new n.BufferAttribute(z,1));var P=a.distanceToVector3(f,f).x,k=a.distanceToVector3(d,d).x,V=se(C,P,k,a);Ve(T,V.position,V.normal,V.indices),c._createMesh(T,o);var I=a.distanceToVector3(v,v).x,E=a.coordinateToVector3(u,I);return c.getObject3d().position.copy(E),c._params={index:0,chunkLines:y,geometries:[],layer:a,trail:Math.max(1,x),lineWidth:P,depth:k,speed:Math.min(1,g),idx:0,loaded:!1,positionMap:b,centerPt:m},c._init(c._params),c.type="ExtrudeLineTrail",c}r(i,t);var o=i.prototype;return o._init=function(t){for(var e=t.layer,n=t.trail,r=t.lineWidth,i=t.depth,o=t.chunkLines,a=t.positionMap,s=t.centerPt,c=o.length,u=[],l=0;l<c;l++){var h=ae(o.slice(l,l+n),e,a,s).positionsV;u.push(se(h,r,i,e))}this._params.geometries=u,this._params.loaded=!0},o._animation=function(){var t=this._params,e=t.index,n=t.geometries,r=t.speed,i=t.idx,o=t.chunkLines,a=t.trail,s=t.lineWidth,c=t.depth,u=t.loaded,l=t.layer,h=t.positionMap,f=t.centerPt;if(u){var d=Math.round(e);if(d>i){this._params.idx++;var v=n[d];if(!v)v=se(ae(o.slice(d,d+a),l,h,f).positionsV,s,c,l),n[d]=v;var g=this.getObject3d();Ve(g.geometry,v.position,v.normal,v.indices),g.geometry.attributes.position.needsUpdate=!0,g.geometry.attributes.normal.needsUpdate=!0,g.geometry.index.needsUpdate=!0}e>=o.length-1&&(this._params.index=-1,this._params.idx=-1),this._params.index+=r}},i}(y),Ue=["click","mousemove","mousedown","mouseup","dblclick","contextmenu"].join(" ").toString(),Re=new n.MeshBasicMaterial;Re.vertexColors=c();var Ze,Ge,Fe=function(t){return function(t){function e(){return t.apply(this,arguments)||this}r(e,t);var i=e.prototype;return i._initBaseObjectsEvent=function(t){if(t&&Array.isArray(t)&&t.length)for(var e=0,n=t.length;e<n;e++){var r=t[e];this._proxyEvent(r)}return this},i._proxyEvent=function(t){var e=this;t.on("add",(function(t){e._showGeometry(t.target,!0)})),t.on("remove",(function(t){e._showGeometry(t.target,!1)})),t.on("mouseout",(function(t){e._mouseover=!1,e.fire("mouseout",Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null}))})),t.on(Ue,(function(t){e.fire(t.type,Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null}))}))},i._getHideGeometryIndex=function(t){for(var e=[],n=0,r=0,i=this._geometriesAttributes.length;r<i;r++)!0===this._geometriesAttributes[r].hide&&(e.push(r),n+=this._geometriesAttributes[r][t].count);return{indexs:e,count:n}},i._updateAttribute=function(t,e){for(var r=this._getHideGeometryIndex(e).indexs,i=this._geometryCache.attributes[e].array,o=i.length,a=0;a<o;a++)t.array[a]=i[a];var s=NaN;this.getObject3d()instanceof n.LineSegments&&(s=0);for(var c=0;c<r.length;c++)for(var u=r[c],l=this._geometriesAttributes[u][e],h=l.start,f=l.end,d=h;d<f;d++)t.array[d]=s;return this},i._showGeometry=function(t,e){var n;if(t&&(n=t.getOptions().index),null!=n){var r=this._geometriesAttributes[n];if(r.hide===e)return this;r.hide=e;var i=this.getObject3d().geometry;this._updateAttribute(i.attributes.position,"position"),i.attributes.position.needsUpdate=!0,this.isHide=e}return this},i.getSelectMesh=function(){var t=this._getIndex();if(null!=t)return{data:this._datas[t],baseObject:this._baseObjects[t]}},i._getIndex=function(t){return null==t&&(t=this.faceIndex||this.index),t},i._init=function(){var t=this,e=this.getLayer().getPick();this.on("add",(function(){e.add(t.pickObject3d)})),this.on("remove",(function(){e.remove(t.pickObject3d)}))},i._setPickObject3d=function(){for(var t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),r=this._geometriesAttributes,i=r.length,o=R(r),a=0,c=0;c<i;c++){var u=e.getColor(),l=u.getHex();this._colorMap[l]=c;var h=r[c].position.count;this._datas[c].colorIndex=l;for(var f=0;f<h;f++)o[a]=u.r,o[a+1]=u.g,o[a+2]=u.b,a+=3}s(t,"color",new n.BufferAttribute(o,3,!0));var d=e.getColor().getHex(),v=new n.Mesh(t,Re);v.position.copy(this.getObject3d().position),v._colorIndex=d,this.setPickObject3d(v)},e}(t)};function De(){return e.worker||console.error("maptalks.worker is not defined,You can't use ThreeVectorTileLayer"),Ge||(Ge=new Ze("__maptalks.three__")),Ge}e.worker&&(Ze=function(t){function e(){return t.apply(this,arguments)||this}r(e,t);var n=e.prototype;return n.test=function(t,e){this.send(t,null,e)},n.pushQueue=function(t){void 0===t&&(t={});var e,n=t,r=n.type,i=n.data,o=n.callback,a=n.layer,s=n.key,c=n.center,u=n.lineStrings;"Polygon"===r?e=function(t,e,n){void 0===t&&(t=[]);for(var r=n.coordinateToVector3(e),i=t.length,o=[],a=[],s={},c=0;c<i;c++){for(var u=t[c],l=ye(u,n,e,r,!0),h=0,f=l.length;h<f;h++)for(var d=l[h],v=0,g=d.length;v<g;v++)a.push(d[v]);var p=Qt(u)?u.properties:u.getProperties()||{},x=p.height||1,y=p.bottomHeight||0;void 0!==y&&"number"==typeof y&&0!==y&&(void 0===s[y]&&(s[y]=n.distanceToVector3(y,y).x),y=s[y]),void 0===s[x]&&(s[x]=n.distanceToVector3(x,x).x),x=s[x],o.push({data:l,height:x,bottomHeight:y})}return{datas:o,transfer:a}}(i,c,a):"LineString"===r&&(e=function(t,e,n,r){for(var i=[],o=[],a={},s=t.length,c=0;c<s;c++){var u=t[c],l=Yt(r[c])?r[c].properties:r[c].getProperties()||{},h=l.width||1,f=l.height||1,d=l.bottomHeight||0;void 0!==d&&"number"==typeof d&&0!==d&&(void 0===a[d]&&(a[d]=n.distanceToVector3(d,d).x),d=a[d]),void 0===a[f]&&(a[f]=n.distanceToVector3(f,f).x),void 0===a[h]&&(a[h]=n.distanceToVector3(h,h).x);for(var v=[],g=0,p=u.length;g<p;g++){var x=oe(u[g],n,e).positions2d;o.push(x),v.push(x)}i.push({data:v,height:a[f],width:a[h],bottomHeight:d})}return{datas:i,transfer:o}}(i,c,a,u)),this.send({type:r,datas:e.datas},e.transfe,(function(t,e){t&&console.error(t),e.key=s,o(e)}))},e}(e.worker.Actor));var He={altitude:0,height:1,bottomHeight:0,topColor:null,bottomColor:"#2d2f61"},We=new e.Coordinate(0,0),qe=function(t){function n(n,r,i,a){var s;Array.isArray(n)||(n=[n]);var u=n.length;0===u&&console.error("polygons is empty");for(var l=1/0,h=1/0,f=-1/0,d=-1/0,v=0;v<u;v++){var g=n[v],p=g.getCenter?g.getCenter():ne(g,We),x=void 0,y=void 0;Array.isArray(p)?(x=p[0],y=p[1]):p instanceof e.Coordinate&&(x=p.x,y=p.y),l=Math.min(l,x),h=Math.min(h,y),f=Math.max(f,x),d=Math.max(d,y)}var b,_=new e.Coordinate((l+f)/2,(h+d)/2),S=r=e.Util.extend({},He,r,{layer:a,polygons:n,coordinate:_}),j=S.topColor,A=S.bottomColor,C=S.altitude,T=S.asynchronous,L=[],B=[],z=[];if(T){var P=De();b=O(),P.pushQueue({type:"Polygon",layer:a,key:r.key,center:_,data:n,callback:function(t){var e=t.faceMap,n=t.geometriesAttributes;s._faceMap=e,s._geometriesAttributes=n;var r=w(t);s._geometryCache=M(r),j&&(xe(r,A,j,n),i.vertexColors=c());var a=s.getObject3d();(a.geometry=r,a.material.needsUpdate=!0,s._setPickObject3d(),s._init(),s.isAdd)&&s.getLayer().getPick().add(s.pickObject3d);s._fire("workerload",{target:o(s)})}})}else{for(var k=a.coordinateToVector3(_),V=[],I=0,E=0,R=0,Z=0,G={},F=0;F<u;F++){var D=n[F],H=Qt(D)?D.properties:D.getProperties()||{},W=H.height||1,q=H.bottomHeight||0,N=pe(D,W,a,_,k,G);V.push(N);var K=U(N,q,a,G),J=N.position,X=N.normal,Q=N.uv,Y=N.indices.length/3;B[F]=[I+1,I+Y],I+=Y;var $=J.length/3,tt=X.length/3,et=Q.length/2;z[F]={position:{middleZ:K+G[W]/2,count:$,start:E,end:E+3*$},normal:{count:tt,start:R,end:R+3*tt},uv:{count:et,start:Z,end:Z+2*et},hide:!1},E+=3*$,R+=3*tt,Z+=2*et}b=m(V),j&&(xe(b,A,j,z),i.vertexColors=c())}(s=t.call(this)||this)._initOptions(r),s._createMesh(b,i);var nt=a.distanceToVector3(C,C).x,rt=a.coordinateToVector3(_,nt);return s.getObject3d().position.copy(rt),s._faceMap=B,s._baseObjects=L,s._datas=n,s._geometriesAttributes=z,s.faceIndex=null,s._geometryCache=b.clone(),s.isHide=!1,s._colorMap={},s._initBaseObjectsEvent(L),T||(s._setPickObject3d(),s._init()),s.type="ExtrudePolygons",s}r(n,t);var i=n.prototype;return i.getSelectMesh=function(){var t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){var e=this._datas[t],n=Object.assign({},this.options,Qt(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new Oe(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}},i.identify=function(t){return this.picked},n}(Fe(y));function Ne(t,e,n){var r=t.project(n),i=e.width/2,o=e.height/2;return{x:Math.round(r.x*i+i),y:Math.round(-r.y*o+o)}}var Ke=Object.freeze({__proto__:null,vectors2Pixel:function(t,e,r,i,o){return void 0===i&&(i=0),t[0]instanceof n.Vector3||(t=function(t,e,r){void 0===e&&(e=0);for(var i=[],o={},a=0,s=t.length;a<s;a+=3){var c=t[a],u=t[a+1],l=t[a+2];e>0&&(l+=I(e,r,o)),i.push(new n.Vector3(c,u,l))}return i}(t,i,o)),t.map((function(t){return Ne(t,e,r)}))},vector2Pixel:Ne}),Je={altitude:0,height:0,color:null},Xe=new n.Vector3,Qe=function(t){function i(r,i,o,a){var c;i=e.Util.extend({},Je,i,{layer:a,coordinate:r}),c=t.call(this)||this;var u=i,l=u.height,h=u.altitude,f=u.color,d=u.size,v=[],g=[];f&&(f=f instanceof n.Color?f:new n.Color(f),g.push(f.r,f.g,f.b));var p=a.distanceToVector3(l,l).x,x=a.coordinateToVector3(r,p);v.push(0,0,x.z);var y=new n.BufferGeometry;s(y,"position",new n.Float32BufferAttribute(v,3,!0)),g.length&&s(y,"color",new n.Float32BufferAttribute(g,3,!0)),void 0!==d&&s(y,"size",new n.Float32BufferAttribute([d],1,!0)),i.positions=x,c._initOptions(i),c._createPoints(y,o);var m=a.distanceToVector3(h,h).x,b=new n.Vector3(x.x,x.y,m);return c.getObject3d().position.copy(b),c.type="Point",c}return r(i,t),i.prototype.identify=function(t){var e=this.getLayer(),n=this.getMap().getSize(),r=this.getLayer().getCamera(),i=this.getOptions().positions,o=this.getOptions().altitude,a=this.getObject3d().material.size;void 0===a&&(a=this.options.size||1);var s=this.getMap().coordToContainerPoint(t),c=e.distanceToVector3(o,o).x;Xe.x=i.x,Xe.y=i.y,Xe.z=i.z+c;var u=Ne(Xe,n,r);return Math.sqrt(Math.pow(s.x-u.x,2)+Math.pow(s.y-u.y,2))<=a/2},i}(y);function Ye(t,e){var n=t.minx,r=t.miny,i=t.maxx,o=t.maxy,a=e[0],s=e[1];return n<=a&&a<=i&&r<=s&&s<=o}var $e=function(){function t(t,e,n,r){this.minlng=t,this.minlat=e,this.maxlng=n,this.maxlat=r,this.minx=1/0,this.miny=1/0,this.maxx=-1/0,this.maxy=-1/0,this.coordinates=[],this.positions=[],this.indexs=[],this.key=null}var n=t.prototype;return n.updateBBoxPixel=function(t){var n=1/0,r=1/0,i=-1/0,o=-1/0,a=this.minlng,s=this.minlat,c=this.maxlng,u=this.maxlat;return[[a,s],[a,u],[c,s],[c,u]].map((function(t){return new e.Coordinate(t)})).map((function(e){return t.coordToContainerPoint(e)})).forEach((function(t){n=Math.min(n,t.x),r=Math.min(r,t.y),i=Math.max(i,t.x),o=Math.max(o,t.y)})),this.minx=n,this.miny=r,this.maxx=i,this.maxy=o,this},n.containsCoordinate=function(t){var n,r;Array.isArray(t)?(n=t[0],r=t[1]):t instanceof e.Coordinate&&(n=t.x,r=t.y);var i=this.minlng,o=this.minlat,a=this.maxlng,s=this.maxlat;return i<=n&&n<=a&&o<=r&&r<=s},n.isRecCross=function(t,e){var n=t.x,r=t.y,i={minx:n-e/2,miny:r-e/2,maxx:n+e/2,maxy:r+e/2},o=i.minx,a=i.miny,s=i.maxx,c=i.maxy;return!!(Ye(this,[o,a])||Ye(this,[o,c])||Ye(this,[s,a])||Ye(this,[s,c])||Ye(i,[this.minx,this.miny])||Ye(i,[this.minx,this.maxy])||Ye(i,[this.maxx,this.miny])||Ye(i,[this.maxx,this.maxy]))},t.initGrids=function(e,n,r,i){for(var o=[],a=(r-e)/30,s=(i-n)/30,c=e,u=n,l=0;l<30;l++){c=e+l*a;for(var h=0;h<30;h++){var f=new t(c,u=n+h*s,c+a,u+s);f.key=h+"-"+l,o.push(f)}}return{grids:o,averageX:a,averageY:s,ROWS:30,COLS:30}},t}(),tn={altitude:0},en=new n.Vector3;function nn(t,e){var n=Math.pow(10,e);return Math.round(t*n)/n}var rn=function(t){function i(r,i,o,a){var c;Array.isArray(r)||(r=[r]),i=e.Util.extend({},tn,i,{layer:a,points:r});for(var u=1/0,l=1/0,h=-1/0,f=-1/0,d=0,v=r.length;d<v;d++){var g=r[d].coordinate,p=void 0,x=void 0;Array.isArray(g)?(p=g[0],x=g[1]):g instanceof e.Coordinate&&(p=g.x,x=g.y),r[d].coords=[p,x],u=Math.min(u,p),l=Math.min(l,x),h=Math.max(h,p),f=Math.max(f,x)}for(var y=a.coordinateToVector3([(u+h)/2,(l+f)/2]),m=$e.initGrids(u,l,h,f),b=m.grids,_=m.averageX,w=m.averageY,M=m.ROWS,O=(m.COLS,b.length,new Float32Array(3*r.length)),S=[],j=new Float32Array(3*r.length),A=new Float32Array(r.length),C=[],T=[],L={},B=0,z=!1,P=!1,k=new n.Vector3(0,0,0),V=0,E=r.length;V<E;V++){var U=r[V],R=U.coordinate,Z=U.height,G=U.color,F=U.size,D=U.coords,H=3*V;G&&(z=!0,G=G instanceof n.Color?G:new n.Color(G),j[H]=G.r,j[H+1]=G.g,j[H+2]=G.b),F&&(P=!0,A[V]=F,B=Math.max(B,F));var W=I(Z,a,L),q=a.coordinateToVector3(R,W);k.x=q.x,k.y=q.y,k.z=q.z,k.sub(y),O[H]=k.x,O[H+1]=k.y,O[H+2]=k.z,S.push(q),T[V]={position:{count:1,start:3*V,end:3*V+3},hide:!1};var N=nn((D[1]-l)/w,4),K=nn((D[0]-u)/_,4);N-=1,K-=1,N=Math.max(0,N),K=Math.max(0,K),N=Math.ceil(N);var J=(K=Math.ceil(K))*M+N;b[J]&&(b[J].positions.push(q),b[J].indexs.push(V))}var X=new n.BufferGeometry;s(X,"position",new n.BufferAttribute(O,3,!0)),z&&s(X,"color",new n.BufferAttribute(j,3,!0)),P&&s(X,"size",new n.BufferAttribute(A,1,!0)),i.positions=S,(c=t.call(this)||this)._initOptions(i),c._createPoints(X,o);var Q=i.altitude,Y=a.distanceToVector3(Q,Q).x,$=y.clone();return $.z=Y,c.getObject3d().position.copy($),c._baseObjects=C,c._datas=r,c.faceIndex=null,c._geometriesAttributes=T,c._geometryCache=X.clone(),c.isHide=!1,c._initBaseObjectsEvent(C),c._grids=b,c._bindMapEvents(),c.type="Points",c.maxSize=B,c}r(i,t);var o=i.prototype;return o._bindMapEvents=function(){var t=this,e=this.getMap(),n="zoomstart zooming zoomend movestart moving moveend pitch rotate";this.on("add",(function(){t._updateGrids(),e.on(n,t._updateGrids,t)})),this.on("remove",(function(){e.off(n,t._updateGrids,t)}))},o._updateGrids=function(){var t=this.getMap();this._grids.forEach((function(e){e.indexs.length&&e.updateBBoxPixel(t)}))},o.getSelectMesh=function(){var t=this.faceIndex;if(null!=t){if(!this._baseObjects[t]){var e=this._datas[t],n=e.coordinate,r=e.height,i=e.color,o=e.size;this._baseObjects[t]=new Qe(n,{height:r,index:t,color:i,size:o},this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}},o.identify=function(t){var e=this,n=this.getLayer(),r=this.getMap().getSize(),i=this.getLayer().getCamera(),o=this.getOptions().altitude,a=this.getMap(),s=n.distanceToVector3(o,o).x,c=this.getObject3d().material.size,u=void 0===c,l=a.coordToContainerPoint(t),h=[];if(this._grids.forEach((function(t){t.indexs.length&&t.isRecCross(l,u?e.maxSize:c)&&h.push(t)})),h.length<1)return!1;for(var f=0,d=h.length;f<d;f++)for(var v=h[f].positions.length-1;v>=0;v--){u&&(c=this._datas[h[f].indexs[v]].size||1);var g=h[f].positions[v];en.x=g.x,en.y=g.y,en.z=g.z+s;var p=Ne(en,r,i);if(Math.sqrt(Math.pow(l.x-p.x,2)+Math.pow(l.y-p.y,2))<=c/2)return this.faceIndex=h[f].indexs[v],!0}return!1},i}(Fe(y)),on={coordinate:"",radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61"},an=function(t){function n(n,r,i,o){var a;Array.isArray(n)||(n=[n]);for(var s=n.length,u=E(n),l=o.coordinateToVector3(u),h=[],f=[],d=[],v=[],g=0,p=0,x=0,y=0,m={},b=0;b<s;b++){var _=e.Util.extend({index:b},on,n[b]),w=_.radius,M=_.radialSegments,O=_.altitude,S=_.topColor,j=_.bottomColor,A=_.height,C=_.coordinate,T=I(w,o,m),P=I(A,o,m),k=I(O,o,m),U=L({radius:T,height:P,radialSegments:M});S&&(B(U,j,S,"z",P/2),i.vertexColors=c());for(var R=o.coordinateToVector3(C).sub(l),Z=U.attributes.position.array,G=0,F=Z.length;G<F;G+=3)Z[G+2]+=k,Z[G]+=R.x,Z[G+1]+=R.y,Z[G+2]+=R.z;h.push(U);var D=new V(C,_,i,o);f.push(D);var H=U.index.count/3;v[b]=[g+1,g+H],g+=H;var W=U.attributes.position.count,q=U.attributes.normal.count,N=U.attributes.uv.count;d[b]={position:{count:W,start:p,end:p+3*W},normal:{count:q,start:x,end:x+3*q},uv:{count:N,start:y,end:y+2*N},hide:!1},p+=3*W,x+=3*q,y+=2*N}a=t.call(this)||this,r=e.Util.extend({},{altitude:0,layer:o,points:n},r),a._initOptions(r);var K=z(h);a._createMesh(K,i);var J=r.altitude,X=o.distanceToVector3(J,J).x,Q=l.clone();return Q.z=X,a.getObject3d().position.copy(Q),a._faceMap=v,a._baseObjects=f,a._datas=n,a._geometriesAttributes=d,a.faceIndex=null,a._geometryCache=K.clone(),a.isHide=!1,a._colorMap={},a._initBaseObjectsEvent(f),a._setPickObject3d(),a._init(),a.type="Bars",a}return r(n,t),n.prototype.identify=function(){return this.picked},n}(Fe(y)),sn={width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61"},cn=function(t){function n(n,r,i,a){var s;Array.isArray(n)||(n=[n]);for(var u=[],l=[],h=n.length,f=0;f<h;f++){var d=ce(n[f]);u.push(d.center),l.push(d.lineStrings)}var v,g=E(u),p=r=e.Util.extend({},sn,r,{layer:a,lineStrings:n,coordinate:g}),x=p.altitude,y=p.topColor,_=p.bottomColor,S=p.asynchronous,j=[],A=[];if(S){var C=De();v=O(),C.pushQueue({type:"LineString",layer:a,key:r.key,center:g,data:l,lineStrings:n,callback:function(t){var e=t.faceMap,n=t.geometriesAttributes;s._faceMap=e,s._geometriesAttributes=n;var r=w(t);(s._geometryCache=M(r),y&&(xe(r,_,y,n),i.vertexColors=c()),s.getObject3d().geometry=r,s.getObject3d().material.needsUpdate=!0,s._setPickObject3d(),s._init(),s.isAdd)&&s.getLayer().getPick().add(s.pickObject3d);s._fire("workerload",{target:o(s)})}})}else{for(var T=[],L=0,B=[],z=0,P=0,k={},V=0;V<h;V++){for(var R=n[V],Z=e.Util.extend({},sn,Xt(R)?R.properties:R.getProperties(),{index:V}),G=Z.height,F=Z.width,D=Z.bottomHeight,H=I(F,a,k),W=I(G,a,k),q=l[V],N=[],K=0,J=0,X=q.length;J<X;J++){var Q=se(q[J],H,W,a,g);K=U(Q,D,a,k),N.push(Q)}var Y=b(N);T.push(Y);var $=Y.position,tt=Y.normal,et=Y.indices.length/3;B[V]=[L+1,L+et],L+=et;var nt=$.length/3,rt=tt.length/3;A[V]={position:{middleZ:K+W/2,count:nt,start:z,end:z+3*nt},normal:{count:rt,start:P,end:P+3*rt},hide:!1},z+=3*nt,P+=3*rt}v=m(T),y&&(xe(v,_,y,A),i.vertexColors=c())}(s=t.call(this)||this)._initOptions(r),s._createMesh(v,i);var it=a.distanceToVector3(x,x).x,ot=a.coordinateToVector3(g,it);return s.getObject3d().position.copy(ot),s._faceMap=[],s._baseObjects=j,s._datas=n,s._geometriesAttributes=A,s.faceIndex=null,s._geometryCache=v.clone(),s.isHide=!1,s._colorMap={},s._initBaseObjectsEvent(j),S||(s._setPickObject3d(),s._init()),s.type="ExtrudeLines",s}r(n,t);var i=n.prototype;return i.getSelectMesh=function(){var t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){var e=this._datas[t],n=Object.assign({},this.options,Yt(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new we(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}},i.identify=function(t){return this.picked},n}(Fe(y)),un={altitude:0,colors:null},ln=function(t){function i(r,i,o,a){var c;Array.isArray(r)||(r=[r]);for(var u=[],l=[],h=r.length,f=0;f<h;f++){var d=ce(r[f]);u.push(d.center),l.push(d.lineStrings)}var v=E(u);i=e.Util.extend({},un,i,{layer:a,lineStrings:r,coordinate:v});for(var g=[],p={},x=0,y=[],m=[],b=0,_=[],w=0;w<h;w++){for(var M=l[w],O=0,S=0,j=M.length;S<j;S++){var A=Yt(M[S])?M[S].properties:M[S].getProperties()||{},C=oe(M[S],a,v).positionsV;U(C,A.bottomHeight,a,p),O+=2*C.length-2,ue(_,C)}var T=O;y[w]=[x,x+T],x+=T,m[w]={position:{count:O,start:b,end:b+3*O},hide:!1},b+=3*O}var L=new n.BufferGeometry;s(L,"position",new n.Float32BufferAttribute(_,3)),(c=t.call(this)||this)._initOptions(i),c._createLineSegments(L,o);var B=i.altitude,z=a.distanceToVector3(B,B).x,P=a.coordinateToVector3(v,z);return c.getObject3d().position.copy(P),c._faceMap=y,c._baseObjects=g,c._datas=r,c._geometriesAttributes=m,c.faceIndex=null,c.index=null,c._geometryCache=L.clone(),c.isHide=!1,c._colorMap={},c._initBaseObjectsEvent(g),c._setPickObject3d(),c._init(),c.type="Lines",c}r(i,t);var o=i.prototype;return o.getSelectMesh=function(){var t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){var n=this._datas[t],r=e.Util.extend({},this.getOptions(),{index:t},Yt(n)?n.properties:n.getProperties());this._baseObjects[t]=new fe(n,r,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}},o._setPickObject3d=function(){for(var t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),r=this._geometriesAttributes,i=r.length,o=R(r),a=0,u=0;u<i;u++){var l=e.getColor(),h=l.getHex();this._colorMap[h]=u;var f=r[u].position.count;this._datas[u].colorIndex=h;for(var d=0;d<f;d++)o[a]=l.r,o[a+1]=l.g,o[a+2]=l.b,a+=3}s(t,"color",new n.BufferAttribute(o,3,!0));var v=this.getObject3d().material.clone();v.color.set("#fff"),v.vertexColors=c();var g=e.getColor().getHex(),p=new n.LineSegments(t,v);p.position.copy(this.getObject3d().position),p._colorIndex=g,this.setPickObject3d(p)},o.identify=function(t){return this.picked},i}(Fe(y)),hn=[],fn=[];function dn(){return{waitingQueue:hn,currentQueue:fn}}function vn(t,e){for(var n=0,r=t.length;n<r;n++){var i=t[n];if(i){var o=i.key,a=i.callback;if(e===o)return t.splice(n,1),a}}return null}var gn=document.createElement("canvas"),pn=256;function xn(t,e){void 0===e&&(e=!1);var n=gn.getContext("2d");if(n.clearRect(0,0,pn,pn),n.save(),e){n.fillStyle="red",n.strokeStyle="rgba(255,0,0,0.4)",n.lineWidth=.2;var r=t||"tile";n.font="18px sans-serif",n.rect(0,0,pn,pn),n.stroke(),n.fillText(r,15,128)}return gn.toDataURL()}function yn(t,e){var n;return void 0===t&&(t=1),void 0===e&&(e=1),"undefined"==typeof document||(n=document.createElement("canvas"),t&&(n.width=t),e&&(n.height=e)),n}gn.width=gn.height=pn;var mn=function(t){function n(n,r){var i;return void 0===r&&(r={}),(i=t.call(this,e.Util.GUID(),e.Util.extend({urlTemplate:n},r))||this)._opts=null,i._layer=null,i.material=null,i.getMaterial=null,i._baseObjectKeys={},i._loadTiles={},i._add=null,i._layerLaodTime=(new Date).getTime(),i}r(n,t);var i=n.prototype;return i.isAsynchronous=function(){return this._opts.worker},i.getBaseObjects=function(){var t=this._loadTiles,e=[];for(var n in t){var r=this._baseObjectKeys[n];if(r&&Array.isArray(r)&&r.length)for(var i=0,o=r.length;i<o;i++)e.push(r[i])}return e},i.onSelectMesh=function(t,e){},i.formatBaseObjects=function(t,e){return[]},i.loopMessage=function(t){},i.getTileData=function(t){var n=t.key,r=t.url,i=t.callback,o=t.img;e.Ajax.getJSON(r,{},(function(t,e){t?(console.error(t),i(n,null,o)):i(n,e,o)}))},i._getCurentTileKeys=function(){for(var t=this.getTiles().tileGrids||[],e=[],n={},r=0,i=t.length;r<i;r++)for(var o=t[r].tiles||[],a=0,s=o.length;a<s;a++){var c=o[a].id;e.push(c),n[c]=!0}return{keys:e,keysMap:n}},i._isLoad=function(){var t=this._getCurentTileKeys().keys,e=Object.keys(this._renderer.tilesInView);return t.length===e.length},i._layerOnLoad=function(){var t=(new Date).getTime();if(!(t-this._layerLaodTime<20)){this._layerLaodTime=t;var e=this._renderer.tilesInView,n=this._loadTiles,r=this._layer,i=this._baseObjectKeys,o=Object.keys(e).length,a=Object.keys(n).length,s=[];if(o&&a)for(var c in n)e[c]||i[c]&&(i[c]||[]).forEach((function(t){s.push(t)}));if(s.length&&r.removeMesh(s,!1),o&&a)for(var u in e)if(!n[u])if(i[u]){var l=i[u];r.addMesh(l)}else{var h=this._getXYZOfIndex(u),f=h.x,d=h.y,v=h.z;this.getTileUrl(f,d,v)}this._loadTiles=Object.assign({},e),this._diffCache()}},i._init=function(){},i._workerLoad=function(t){var e=t.target._img;e.currentCount++,e.currentCount===e.needCount&&(e.src=xn(e._key,this._opts.debug))},i._generateBaseObjects=function(t,e,n){var r=this;if(e&&n){if(!this._getCurentTileKeys().keysMap[t])return void(n.src=xn(t,this._opts.debug));var i=this.formatBaseObjects(t,e);if(i.length){n.needCount=i.length,n.currentCount=0;for(var o=0,a=i.length;o<a;o++){var s=i[o];s._img=n,s._vt=this,this.isVisible()||s.hide(),this._cachetile(t,s),s.isAsynchronous()||n.currentCount++}this._layer.addMesh(i,!1),n.needCount===n.currentCount&&(n.src=xn(t,this._opts.debug)),this.isAsynchronous()?i.filter((function(t){return t.isAsynchronous()})).forEach((function(t){t.on("workerload",r._workerLoad,r)})):n.src=xn(t,this._opts.debug)}else n.src=xn(t,this._opts.debug);this._loadTiles[t]=!0}else n&&(n.src=xn(t,this._opts.debug))},i._diffCache=function(){var t=this;Object.keys(this._baseObjectKeys).length>this._renderer.tileCache.max&&function(){var e=t._renderer.tileCache.data,n=t._renderer.tilesInView,r=[];for(var i in t._baseObjectKeys)e[i]||n[i]||((t._baseObjectKeys[i]||[]).forEach((function(t){t.isAdd&&r.push(t)})),t._diposeBaseObject(i),delete t._baseObjectKeys[i]);r.length&&t._layer.removeMesh(r,!1)}()},i._diposeBaseObject=function(t){var e=this._baseObjectKeys[t];e&&e.length&&e.forEach((function(t){t.getObject3d().geometry.dispose(),t._geometryCache&&t._geometryCache.dispose();var e=t._baseObjects;e&&e.length&&e.forEach((function(t){t.getObject3d().geometry.dispose(),t=null})),t._datas=null,t._geometriesAttributes=null,t._faceMap=null,t._colorMap=null,t.pickObject3d&&t.pickObject3d.geometry.dispose(),t=null}))},i._cachetile=function(t,e){this._baseObjectKeys[t]||(this._baseObjectKeys[t]=[]),this._baseObjectKeys[t].push(e)},i._getXYZOfIndex=function(t){var e=t.indexOf("_")>-1?"_":"-",n=t.split(e).slice(1,4),r=n[0],i=n[1],o=n[2];return{x:parseInt(i),y:parseInt(r),z:parseInt(o)}},i._getTileExtent=function(t,e,n){var r=this.getMap()._getResolution(n);return this._getTileConfig().getTilePrjExtent(t,e,r)},i._getTileLngLatExtent=function(t,n,r){var i=this._getTileExtent(t,n,r),o=i.getMax(),a=i.getMin(),s=this.getMap().getProjection();return a=s.unproject(a),o=s.unproject(o),new e.Extent(a,o)},n}(e.TileLayer),bn={worker:!1},_n=function(t){function i(n,r,i,o){var a;return void 0===r&&(r={}),(a=t.call(this,e.Util.GUID(),e.Util.extend({urlTemplate:n},bn,r))||this)._opts=r,a._layer=o,a.getMaterial=i,a._baseObjectKeys={},a._loadTiles={},a._add=null,a._layerLaodTime=(new Date).getTime(),a._init(),a}r(i,t);var o=i.prototype;return o.formatBaseObjects=function(t,r){var i=this._opts,o=[],a=this.isAsynchronous();for(var s in r){var c=r[s]||{},u=void 0;if(Array.isArray(c)?u=c:"FeatureCollection"===c.type&&(u=c.features),u&&u.length){for(var l=[],h=[],f=[],d=0,v=u.length;d<v;d++){var g=u[d];if(Qt(g))l.push(g);else if(Yt(g))for(var p=re(g),x=0,y=p.length;x<y;x++)h.push(p[x]);else if($t(g))for(var m=re(g),b=0,_=m.length;b<_;b++)f.push(e.Util.extend({},m[b].properties,m[b],{coordinate:ee(m[b])}))}if(l.length){var w=this._getMaterial(s,l,t,c);if(w){var M=this._layer.toExtrudePolygons(l,e.Util.extend({},{topColor:"#fff",layerName:s,asynchronous:a,key:t},i),w);o.push(M)}}if(h.length){var O=this._getMaterial(s,h,t,c);if(O&&(O instanceof n.LineBasicMaterial||O instanceof n.LineDashedMaterial)){var S=this._layer.toLines(h,e.Util.extend({},{layerName:s},i),O);o.push(S)}}if(f.length){var j=this._getMaterial(s,f,t,c);if(j&&j instanceof n.PointsMaterial){var A=this._layer.toPoints(f,e.Util.extend({},{layerName:s},i),j);o.push(A)}}}}return o},o.loopMessage=function(t){dn().currentQueue.length>0&&this.getTileData(t)},o._init=function(){var t=this;this.on("layerload",this._layerOnLoad),this.on("add",(function(){if(!1===t._add){var e=t.getBaseObjects();t._layer.addMesh(e)}t._add=!0,t.intervalId=setInterval((function(){t._isLoad()&&!t._layer.getMap().isInteracting()&&t.fire("layerload")}),1e3)})),this.on("remove",(function(){t._add=!1;var e=t.getBaseObjects();t._layer.removeMesh(e),clearInterval(t.intervalId)})),this.on("show",(function(){var e=t.getBaseObjects();for(var n in e.forEach((function(t){t.show()})),t._baseObjectKeys){(t._baseObjectKeys[n]||[]).forEach((function(t){t.show()}))}})),this.on("hide",(function(){var e=t.getBaseObjects();for(var n in e.forEach((function(t){t.hide()})),t._baseObjectKeys){(t._baseObjectKeys[n]||[]).forEach((function(t){t.hide()}))}})),this.on("renderercreate",(function(e){e.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e.width,n.height=e.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t.id),n},e.renderer.deleteTile=function(t){if(t&&t.image){t.image.onload=null,t.image.onerror=null;var e,n,r=t.info||{};e=r.id,(n=vn(hn,e))&&n(e)}},e.renderer.loadTileImage=function(e,n,r){e._key=r,function(t,e,n,r,i){var o={key:t,url:e,callback:n,img:r,vt:i};fn.length<10?(fn.push(o),i.loopMessage(o)):hn.push(o)}(r,n,(function(e,n,r){t._generateBaseObjects(e,n,r),function(t,e){if(vn(fn,t),hn.length){fn.push(hn[0]),hn.splice(0,1);var n=fn[fn.length-1];e.loopMessage(n)}}(e,t)}),e,t)}}))},o._getMaterial=function(t,n,r,i){return this.getMaterial&&e.Util.isFunction(this.getMaterial)?this.getMaterial(t,n,r,i):null},i}(mn);function wn(t,e,r,i){var o=function(t,e,n,r){for(var i=t/n,o=e/r,a=-t/2,s=e/2,c=-e/2,u=(n+1)*(r+1),l=new Float32Array(3*u),h=new Float32Array(2*u),f=new Float32Array(3*u),d=new Uint32Array(10*u),v=0,g=0,p=0,x=0;x<=r;x++)for(var y=0;y<=n;y++){var m=a+i*y,b=s-o*x;l[v]=m,l[v+1]=b,l[v+2]=0,f[v]=0,f[v+1]=0,f[v+2]=1;var _=(m-a)/t,w=(b-c)/e;if(h[g]=_,h[g+1]=w,v+=3,g+=2,y<n&&x<r){var M=x*(n+1)+y,O=M+1,S=(n+1)*(x+1)+y,j=S+1;d[p]=M,d[p+1]=S,d[p+2]=O,d[p+3]=S,d[p+4]=j,d[p+5]=O,p+=6}}for(var A=new Uint32Array(p),C=0,T=A.length;C<T;C++)A[C]=d[C];return{position:l,uv:h,normal:f,indexs:A}}(t,e,r,i),a=o.position,c=o.uv,u=o.normal,l=o.indexs,h=new n.BufferGeometry;return s(h,"position",new n.BufferAttribute(a,3)),s(h,"normal",new n.BufferAttribute(u,3)),s(h,"uv",new n.BufferAttribute(c,2)),h.setIndex(new n.BufferAttribute(l,1)),h}var Mn=new n.TextureLoader,On=document.createElement("canvas");function Sn(t){return t?("string"==typeof t?(e=new Image).src=t:t instanceof HTMLCanvasElement?(e=new Image).src=t.toDataURL():t instanceof Image&&((e=new Image).src=t.src,e.crossOrigin=t.crossOrigin),e&&!e.crossOrigin&&(e.crossOrigin="Anonymous"),e):null;var e}var jn={interactive:!1,altitude:0,image:null,imageWidth:256,imageHeight:256,texture:null},An=function(t){function n(n,r,i,o){var a,s=r=e.Util.extend({},jn,r,{layer:o,extent:n}),c=s.texture,u=s.image,l=s.altitude,h=s.imageHeight,f=s.imageWidth;u||console.error("not find image"),n instanceof e.Extent||(n=new e.Extent(n));var d=n,v=d.xmin,g=d.ymin,p=d.xmax,x=d.ymax,y=1/0,m=1/0,b=-1/0,_=-1/0;[[v,g],[v,x],[p,x],[p,g]].forEach((function(t){var e=o.coordinateToVector3(t),n=e.x,r=e.y;y=Math.min(n,y),m=Math.min(r,m),b=Math.max(n,b),_=Math.max(r,_)}));var w=Math.abs(b-y),M=Math.abs(_-m),O=Sn(u),S=Sn(c),j=wn(w,M,f-1,h-1);(a=t.call(this)||this)._initOptions(r),a._createMesh(j,i);var A=o.distanceToVector3(l,l).x,C=o.coordinateToVector3(n.getCenter(),A);return a.getObject3d().position.copy(C),i.transparent=!0,O&&(i.opacity=0,O.onload=function(){for(var t=function(t,e,n){void 0===e&&(e=256),void 0===n&&(n=256),On.width=e,On.height=n;var r=On.getContext("2d");return r.drawImage(t,0,0,e,n),r.getImageData(0,0,e,n).data}(O,f,h),e=0,n={},r=0,a=t.length;r<a;r+=4){var s=I(.1*(256*t[r]*256+256*t[r+1]+t[r+2])-1e4,o,n);j.attributes.position.array[3*e+2]=s,e++}j.attributes.position.needsUpdate=!0,S?Mn.load(S.src,(function(t){i.map=t,i.opacity=1,i.needsUpdate=!0})):i.opacity=1},O.onerror=function(){console.error("not load "+O.src)}),a.type="Terrain",a}return r(n,t),n}(y),Cn={scale:1,tileDivisor:4},Tn=function(t){function n(n,r,i,o){var a;return void 0===r&&(r={}),(a=t.call(this,e.Util.GUID(),e.Util.extend({urlTemplate:n},Cn,r))||this)._opts=r,a._layer=o,a.material=i,a._baseObjectKeys={},a._loadTiles={},a._add=null,a._imgQueue={},a._layerLaodTime=(new Date).getTime(),a._init(),a}r(n,t);var i=n.prototype;return i.isAsynchronous=function(){return!1},i.formatBaseObjects=function(t,e){var n=this.options,r=[],i=n.scale,o=n.tileDivisor,a=this._getXYZOfIndex(t),s=a.x,c=a.y,u=a.z,l=this.getMap().getZoom(),h=this.getTileUrl(s,c,u),f=this.options.tileSize,d=f[0],v=f[1],g=this._getTileLngLatExtent(s,c,u),p=this.material.clone();if(u+1>=Math.round(l)){var x=new An(g,{image:e,imageWidth:d/o,imageHeight:v/o,texture:h},p,this._layer);x.getObject3d().scale.set(i,i,1),r.push(x)}return r},i.loopMessage=function(t){this.getTileData(t)},i._init=function(){var t=this;this.on("layerload",this._layerOnLoad),this.on("add",(function(){if(!1===t._add){var e=t.getBaseObjects();t._layer.addMesh(e)}t._add=!0,t.intervalId=setInterval((function(){t._isLoad()&&!t._layer.getMap().isInteracting()&&t.fire("layerload")}),1e3)})),this.on("remove",(function(){t._add=!1;var e=t.getBaseObjects();t._layer.removeMesh(e),clearInterval(t.intervalId)})),this.on("show",(function(){var e=t.getBaseObjects();for(var n in e.forEach((function(t){t.show()})),t._baseObjectKeys){(t._baseObjectKeys[n]||[]).forEach((function(t){t.show()}))}})),this.on("hide",(function(){var e=t.getBaseObjects();for(var n in e.forEach((function(t){t.hide()})),t._baseObjectKeys){(t._baseObjectKeys[n]||[]).forEach((function(t){t.hide()}))}})),this.on("renderercreate",(function(e){e.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e.width,n.height=e.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t.id),n},e.renderer.deleteTile=function(e){if(e&&e.image){e.image.onload=null,e.image.onerror=null;var n=e.info||{},r=t._imgQueue[n.id];r&&(r.src="",r.onload=null,r.onerror=null,delete t._imgQueue[n.id])}},e.renderer.loadTileImage=function(e,n,r){e._key=r;var i=new Image;t._imgQueue[r]=i;var o={key:r,url:n,rgbImage:i,callback:function(e,n,r){t._generateBaseObjects(e,n,r)},img:e,vt:t};t.loopMessage(o)}}))},n}(mn);
/*!
   * Code from baidu mapv
   * License: BSD-3
   * https://github.com/huiyan-fe/mapv
   *
   */
function Ln(t){t=t||{},this.gradient=t.gradient||{.25:"rgba(0, 0, 255, 1)",.55:"rgba(0, 255, 0, 1)",.85:"rgba(255, 255, 0, 1)",1:"rgba(255, 0, 0, 1)"},this.maxSize=t.maxSize||35,this.minSize=t.minSize||0,this.max=t.max||100,this.min=t.min||0,this.initPalette()}function Bn(t,e,n){var r=zn(n),i=function(t){return t.min||0}(n),o=r-i,a=n.range||null,s=0,c=1024;a&&2===a.length&&(s=(a[0]-i)/o*1024),a&&2===a.length&&(c=(a[1]-i)/o*1024);for(var u,l=n.maxOpacity||.8,h=n.minOpacity||0,f=3,d=t.length;f<d;f+=4)u=4*t[f],t[f]/256>l&&(t[f]=256*l),t[f]/256<h&&(t[f]=256*h),u&&u>=s&&u<=c?(t[f-3]=e[u],t[f-2]=e[u+1],t[f-1]=e[u+2]):t[f]=0}function zn(t){return t.max||100}function Pn(t,e,n){var r=zn(n),i=
/*!
   * Code from baidu mapv
   * License: BSD-3
   * https://github.com/huiyan-fe/mapv
   *
   */
function(t){var e=t/2,n=t+e,r=1e4,i=yn(2*n,2*n),o=i.getContext("2d");return o.shadowBlur=e,o.shadowColor="black",o.shadowOffsetX=o.shadowOffsetY=r,o.beginPath(),o.arc(n-r,n-r,t,0,2*Math.PI,!0),o.closePath(),o.fill(),i}(n._size||n.size||13),o=i.width/2,a=i.height/2,s=e,c={};for(var u in s.forEach((function(t){var e=void 0===t.count?1:t.count,n=Math.min(1,e/r).toFixed(2);c[n]=c[n]||[],c[n].push(t)})),c)if(!isNaN(u)){var l=c[u];t.beginPath(),n.withoutAlpha||(t.globalAlpha=u),l.forEach((function(e){var n=e.coordinate,s=void 0===e.count?1:e.count;t.globalAlpha=s/r,t.drawImage(i,n[0]-o,n[1]-a)}))}}Ln.prototype.setMax=function(t){this.max=t||100},Ln.prototype.setMin=function(t){this.min=t||0},Ln.prototype.setMaxSize=function(t){this.maxSize=t||35},Ln.prototype.setMinSize=function(t){this.minSize=t||0},Ln.prototype.initPalette=function(){var t=this.gradient,e=yn(256,1),n=this.paletteCtx=e.getContext("2d"),r=n.createLinearGradient(0,0,256,1);for(var i in t)r.addColorStop(parseFloat(i),t[i]);n.fillStyle=r,n.fillRect(0,0,256,1)},Ln.prototype.getColor=function(t){var e=this.getImageData(t);return"rgba("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]/256+")"},Ln.prototype.getImageData=function(t){var e=this.paletteCtx.getImageData(0,0,256,1).data;if(void 0===t)return e;var n=this.max,r=this.min;t>n&&(t=n),t<r&&(t=r);var i=4*Math.floor((t-r)/(n-r)*255);return[e[i],e[i+1],e[i+2],e[i+3]]},Ln.prototype.getSize=function(t){var e=this.max,n=this.min,r=this.maxSize,i=this.minSize;return t>e&&(t=e),t<n&&(t=n),e>n?i+(t-n)/(e-n)*(r-i):r},Ln.prototype.getLegend=function(t){var e=this.gradient,n=t.width||20,r=t.height||180,i=yn(n,r),o=i.getContext("2d"),a=o.createLinearGradient(0,r,0,0);for(var s in e)a.addColorStop(parseFloat(s),e[s]);return o.fillStyle=a,o.fillRect(0,0,n,r),i};var kn={draw:function(t,e,n){if(!(t.canvas.width<=0||t.canvas.height<=0)){var r=n.strength||.3;t.strokeStyle="rgba(0,0,0,"+r+")";var i=yn(t.canvas.width,t.canvas.height),o=i.getContext("2d");o.scale(devicePixelRatio,devicePixelRatio),n=n||{},t.save();var a=new Ln({gradient:n.gradient});if(Pn(o,e,n),!n.absolute){var s=o.getImageData(0,0,t.canvas.width,t.canvas.height);Bn(s.data,a.getImageData(),n),t.putImageData(s,0,0),t.restore()}a=null,i=null}},drawGray:Pn,colorize:Bn},Vn={altitude:0,interactive:!1,min:0,max:100,size:13,gradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},gridScale:.5},In=2048,En=function(t){function i(r,i,o,a){var u;Array.isArray(r)||(r=[r]);for(var l=1/0,h=1/0,f=-1/0,d=-1/0,v=[],g=0,p=r.length;g<p;g++){var x=r[g],y=x.coordinate,m=x.lnglat,b=x.xy,_=y||m||b;if(_){var w=a.coordinateToVector3(_);v.push(w);var M=w.x,O=w.y;l=Math.min(l,M),h=Math.min(h,O),f=Math.max(f,M),d=Math.max(d,O)}else console.warn("not find coordinate")}var S=i=e.Util.extend({},Vn,i,{layer:a,points:r}),j=S.gridScale,A=S.altitude,C=Math.abs(f-l),T=Math.abs(d-h),L=Math.max(C*j,T*j);L>In&&(console.warn("gridScale: "+j+" it's too big. I hope it's a smaller value,canvas max size is "+"2048* "+In),j=In/(L/j));for(var B=Math.ceil(C*j),z=Math.ceil(T*j),P=B/C,k=z/T,V=[],I=0,E=v.length;I<E;I++){var U=v[I];U.x-=l,U.y-=h,U.x*=P,U.y*=k,U.y=z-U.y,V.push({coordinate:[U.x,U.y],count:r[I].count})}var R=yn(B,z),Z=R.getContext("2d");kn.drawGray(Z,V,i);for(var G=Z.getImageData(0,0,Z.canvas.width,Z.canvas.height),F=-1/0,D=new Float32Array(G.data.length/4),H=new Float32Array(G.data.length/4),W=3,q=G.data.length,N=0;W<q;W+=4){var K=G.data[W];F=Math.max(F,K),H[N]=K,K<=0&&(D[N]=1),N++}var J=new Ln({gradient:i.gradient});kn.colorize(G.data,J.getImageData(),i),R=null,Z=null;for(var X=wn(C,T,B-1,z-1),Q=X.getIndex().array,Y=X.attributes.position.array,$=new Float32Array(Y.length),tt=new Uint32Array(6*Y.length),et=new n.Color,nt=0,rt=0,it=Y.length,ot=0,at=Q.length,st=0,ct=G.data.length,ut=0;rt<Math.max(it,at,ct);rt+=3){if(rt<it){var lt=H[ut];lt>0&&(Y[rt+2]=lt/F)}if(ot<at){var ht=Q[ot],ft=Q[ot+1],dt=Q[ot+2];D[ht]&&D[ft]&&D[dt]||(tt[nt]=ht,tt[nt+1]=ft,tt[nt+2]=dt,nt+=3)}if(st<ct){var vt="rgb("+G.data[st]+","+G.data[st+1]+","+G.data[st+2]+")";et.setStyle(vt),$[ot]=et.r,$[ot+1]=et.g,$[ot+2]=et.b}ot+=3,st+=4,ut++}for(var gt=new Uint32Array(nt),pt=0;pt<nt;pt++)gt[pt]=tt[pt];X.setIndex(new n.BufferAttribute(gt,1)),s(X,"color",new n.BufferAttribute($,3,!0)),o.vertexColors=c(),(u=t.call(this)||this)._initOptions(i),u._createMesh(X,o);var xt=a.distanceToVector3(A,A).x;return u.getObject3d().position.copy(new n.Vector3((l+f)/2,(h+d)/2,xt)),u.type="HeatMap",u}return r(i,t),i}(y),Un=new n.Color,Rn=1,Zn=function(){function t(t){this.object3ds=[],this.layer=t,this.camera=t.getCamera(),this.renderer=t.getThreeRenderer(),this.pickingTexture=new n.WebGLRenderTarget(1,1),this.pickingScene=new n.Scene}var e=t.prototype;return e.getColor=function(){return Un.setHex(Rn),Rn++,Un},e.add=function(t){if(t){var e=t._colorIndex;e&&(this.object3ds[e]=t,this.pickingScene.add(t))}return this},e.remove=function(t){if(t){var e=t._colorIndex;e&&(this.object3ds[e]=null,this.pickingScene.remove(t))}return this},e.isEmpty=function(){if(0===this.pickingScene.children.length)return!0;for(var t=0,e=this.pickingScene.children.length;t<e;t++){var n=this.pickingScene.children[t];if(n){var r=n.__parent;if(r&&!0===r.getOptions().interactive)return!1}}return!0},e.pick=function(t){if(t&&!this.isEmpty()){for(var e=this.camera,n=this.renderer,r=this.pickingTexture,i=this.pickingScene,o=this.object3ds,a=this.layer,s=this.pickingScene.children.length,c=0;c<s;c++){var u=this.pickingScene.children[c];u&&u.__parent&&(u.__parent.picked=!1)}var l=a._getRenderer().canvas,h=l.width,f=l.height,d=r.width,v=r.height;h===d&&f===v||r.setSize(h,f),n.setRenderTarget(r),n.clear(),n.render(i,e);var g=new Uint8Array(4),p=t.x,x=t.y,y=window.devicePixelRatio,m=p*y,b=r.height-x*y;n.readRenderTargetPixels(r,Math.round(m),Math.round(b),1,1,g);var _=g[0]<<16|g[1]<<8|g[2],w=o[_];if(w)w.__parent&&(o[_].__parent.picked=!0);else for(var M=0;M<s;M++){var O=this.pickingScene.children[M];if(O&&O.__parent){var S=O.__parent;if(S._colorMap&&null!=S._colorMap[_]){S.picked=!0,S.index=S._colorMap[_];break}}}n.setRenderTarget(null)}},t}(),Gn={bottomHeight:0,altitude:0},Fn=function(t){function i(n,r,i,o){var a;r=e.Util.extend({},Gn,r,{layer:o,lineString:n}),(a=t.call(this)||this)._initOptions(r);for(var s=ce(n),c=s.lineStrings,u=s.center,l=[],h={},f=0,d=c.length;f<d;f++){var g=oe(c[f],o,u).positionsV;U(g,r.bottomHeight,o,h),ue(l,g)}var p=new v;p.setPositions(l),a._setMaterialRes(o,i),a._createLine2(p,i);var x=r.altitude,y=o.distanceToVector3(x,x).x,m=o.coordinateToVector3(u,y);return a.getObject3d().position.copy(m),a._setPickObject3d(l,i.linewidth),a._init(),a.type="FatLine",a}r(i,t);var o=i.prototype;return o._init=function(){var t=this,e=this.getLayer().getPick();this.on("add",(function(){e.add(t.pickObject3d)})),this.on("remove",(function(){e.remove(t.pickObject3d)}))},o._setMaterialRes=function(t,e){var n=t.getMap().getSize(),r=n.width,i=n.height;e.resolution.set(r,i)},o._setPickObject3d=function(t,e){var n=new v;n.setPositions(t);for(var r=this.getLayer().getPick().getColor(),i=[],o=0,a=t.length/3;o<a;o++)i.push(r.r,r.g,r.b);n.setColors(i);var s=new f({color:"#fff",linewidth:e,vertexColors:c()});this._setMaterialRes(this.getLayer(),s);var u=r.getHex(),l=new g(n,s);l.position.copy(this.getObject3d().position),l._colorIndex=u,this.setPickObject3d(l)},o.identify=function(t){return this.picked},o.setSymbol=function(t){if(t&&t instanceof n.Material){t.needsUpdate=!0;var e=this.getMap().getSize(),r=e.width,i=e.height;t.resolution.set(r,i),this.getObject3d().material=t}return this},i}(y),Dn={altitude:0,colors:null},Hn=function(t){function i(n,r,i,o){var a;Array.isArray(n)||(n=[n]);for(var s=[],c=[],u=n.length,l=0;l<u;l++){var h=ce(n[l]);s.push(h.center),c.push(h.lineStrings)}var f=E(s);r=e.Util.extend({},Dn,r,{layer:o,lineStrings:n,coordinate:f});for(var d=[],g={},p=0,x=[],y=[],m=0,b=[],_=0;_<u;_++){for(var w=c[_],M=0,O=0,S=w.length;O<S;O++){var j=Yt(w[O])?w[O].properties:w[O].getProperties()||{},A=oe(w[O],o,f).positionsV;U(A,j.bottomHeight,o,g),M+=2*A.length-2,ue(b,A)}var C=M;x[_]=[p,p+C],p+=C,y[_]={position:{count:M,start:m,end:m+3*M},instanceStart:{count:M,start:m,end:m+3*M},instanceEnd:{count:M,start:m,end:m+3*M},hide:!1},m+=3*M}(a=t.call(this)||this)._initOptions(r);var T=new v;T.setPositions(b),a._setMaterialRes(o,i),a._createLine2(T,i);var L=r.altitude,B=o.distanceToVector3(L,L).x,z=o.coordinateToVector3(f,B);return a.getObject3d().position.copy(z),a._faceMap=x,a._baseObjects=d,a._datas=n,a._geometriesAttributes=y,a.faceIndex=null,a.index=null,a._geometryCache=new v,a._geometryCache.setPositions(b),a._colorMap={},a.isHide=!1,a._initBaseObjectsEvent(d),a._setPickObject3d(b,i.linewidth),a._init(),a.type="FatLines",a}r(i,t);var o=i.prototype;return o._setMaterialRes=function(t,e){var n=t.getMap().getSize(),r=n.width,i=n.height;e.resolution.set(r,i)},o._setPickObject3d=function(t,e){var n=this._geometryCache||new v;n.setPositions(t);for(var r=this.getLayer().getPick(),i=this._geometriesAttributes,o=R(i),a=0,s=0,u=i.length;s<u;s++){var l=r.getColor(),h=l.getHex();this._colorMap[h]=s;var d=i[s].position.count;this._datas[s].colorIndex=h;for(var p=0;p<d;p++)o[a]=l.r,o[a+1]=l.g,o[a+2]=l.b,a+=3}n.setColors(o);var x=new f({color:"#fff",linewidth:e,vertexColors:c()});this._setMaterialRes(this.getLayer(),x);var y=r.getColor().getHex(),m=new g(n,x);m.position.copy(this.getObject3d().position),m._colorIndex=y,this.setPickObject3d(m)},o.identify=function(t){return this.picked},o.setSymbol=function(t){if(t&&t instanceof n.Material){t.needsUpdate=!0;var e=this.getMap().getSize(),r=e.width,i=e.height;t.resolution.set(r,i),this.getObject3d().material=t}return this},o.getSelectMesh=function(){var t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){var n=this._datas[t],r=e.Util.extend({},this.getOptions(),{index:t},Yt(n)?n.properties:n.getProperties());this._baseObjects[t]=new Fn(n,r,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}},o._updateAttribute=function(t,e){for(var n=this._getHideGeometryIndex(e).indexs,r=this._geometryCache.attributes[e].array,i=r.length,o=0;o<i;o++)t.array[o]=r[o];for(var a=0;a<n.length;a++)for(var s=n[a],c=this._geometriesAttributes[s][e],u=c.start,l=c.end,h=u;h<l;h++)t.array[h]=-1e5;return this},o._showGeometry=function(t,e){var n;if(t&&(n=t.getOptions().index),null!=n){var r=this._geometriesAttributes[n];if(r.hide===e)return this;r.hide=e;var i=this.getObject3d().geometry;this._updateAttribute(i.attributes.instanceStart,"instanceStart"),this._updateAttribute(i.attributes.instanceEnd,"instanceEnd"),i.attributes.instanceStart.data.needsUpdate=!0,i.attributes.instanceEnd.data.needsUpdate=!0,this.isHide=e}return this},i}(Fe(y)),Wn={radius:10,height:100,altitude:0,topColor:"",bottomColor:"#2d2f61"},qn=function(t){function n(n,r,i,o){var a;r=e.Util.extend({},Wn,r,{layer:o,coordinate:n}),(a=t.call(this)||this)._initOptions(r);var s=r,u=s.height,l=s.radius,h=s.topColor,f=s.bottomColor,d=s.altitude,v=o.distanceToVector3(u,u).x,g=o.distanceToVector3(l,l).x,p=P().clone();p.scale(2*g,2*g,v),h&&(B(p,f,h,"z",v/2),i.vertexColors=c()),a._createMesh(p,i);var x=o.distanceToVector3(d,d).x,y=o.coordinateToVector3(n,x);return a.getObject3d().position.copy(y),a.type="Box",a}return r(n,t),n}(y),Nn={radius:10,height:100,altitude:0,topColor:null,bottomColor:"#2d2f61"},Kn=function(t){function n(n,r,i,o){var a;Array.isArray(n)||(n=[n]);for(var s=n.length,u=E(n),l=o.coordinateToVector3(u),h=[],f=[],d=[],v=[],g=0,p=0,x=0,y=0,m={},b=0;b<s;b++){var _=e.Util.extend({index:b},Nn,n[b]),w=_.radius,M=_.altitude,O=_.topColor,S=_.bottomColor,j=_.height,A=_.coordinate,C=I(w,o,m),T=I(j,o,m),L=I(M,o,m),k=P().clone();k.scale(2*C,2*C,T),O&&(B(k,S,O,"z",T/2),i.vertexColors=c());for(var V=o.coordinateToVector3(A).sub(l),U=k.attributes.position.array,R=0,Z=U.length;R<Z;R+=3)U[R+2]+=L,U[R]+=V.x,U[R+1]+=V.y,U[R+2]+=V.z;h.push(k);var G=new qn(A,_,i,o);f.push(G);var F=k.index.count/3;v[b]=[g+1,g+F],g+=F;var D=k.attributes.position.count,H=k.attributes.normal.count,W=k.attributes.uv.count;d[b]={position:{count:D,start:p,end:p+3*D},normal:{count:H,start:x,end:x+3*H},uv:{count:W,start:y,end:y+2*W},hide:!1},p+=3*D,x+=3*H,y+=2*W}a=t.call(this)||this,r=e.Util.extend({},{altitude:0,layer:o,points:n},r),a._initOptions(r);var q=z(h);a._createMesh(q,i);var N=r.altitude,K=o.distanceToVector3(N,N).x,J=l.clone();return J.z=K,a.getObject3d().position.copy(J),a._faceMap=v,a._baseObjects=f,a._datas=n,a._geometriesAttributes=d,a.faceIndex=null,a._geometryCache=q.clone(),a.isHide=!1,a._colorMap={},a._initBaseObjectsEvent(f),a._setPickObject3d(),a._init(),a.type="Boxs",a}return r(n,t),n.prototype.identify=function(t){return this.picked},n}(Fe(y));var Jn=Math.PI/180,Xn=[[4e3,220],[2e3,100],[1e3,30],[500,15],[100,5],[50,2],[10,1],[5,.7],[2,.1],[1,.05],[.5,.02]],Qn=["mousemove","click","mousedown","mouseup","dblclick","contextmenu","touchstart","touchmove","touchend"],Yn=new e.Coordinate(0,0),$n=new e.Point(0,0),tr=function(t){function i(e,n){var r;return(r=t.call(this,e,n)||this)._animationBaseObjectMap={},r._needsUpdate=!0,r._mousemoveTimeOut=0,r._baseObjects=[],r._delayMeshes=[],r.type="ThreeLayer",r}r(i,t);var o=i.prototype;return o.isRendering=function(){var t=this.getMap();return!!t&&(t.isInteracting()||t.isAnimating())},o.prepareToDraw=function(){},o.draw=function(){this.renderScene()},o.drawOnInteracting=function(){this.renderScene()},o.coordinateToVector3=function(t,r){void 0===r&&(r=0);var i=this.getMap();if(!i)return null;var o=Array.isArray(t);o&&(Yn.x=t[0],Yn.y=t[1]),o||t instanceof e.Coordinate||(t=new e.Coordinate(t));var a=nr(i),s=rr(i,o?Yn:t,a,$n);return new n.Vector3(s.x,s.y,r)},o.distanceToVector3=function(t,r,i){if(0===t&&0===r||!e.Util.isNumber(t)||!e.Util.isNumber(r))return new n.Vector3(0,0,0);var o=this.getMap(),a=nr(o),s=i||o.getCenter();s instanceof e.Coordinate||(s=new e.Coordinate(s));var c=o.locate(s,t,r),u=rr(o,s,a),l=rr(o,c,a),h=Math.abs(l.x-u.x)*e.Util.sign(t),f=Math.abs(l.y-u.y)*e.Util.sign(r);return new n.Vector3(h,f,0)},o.toShape=function(t){var r=this;if(!t)return null;if(t instanceof e.MultiPolygon)return t.getGeometries().map((function(t){return r.toShape(t)}));var i=t.getCenter(),o=this.coordinateToVector3(i),a=t.getShell().map((function(t){var e=r.coordinateToVector3(t).sub(o);return new n.Vector2(e.x,e.y)})),s=new n.Shape(a),c=t.getHoles();return c&&c.length>0&&(s.holes=c.map((function(t){var e=t.map((function(t){var e=r.coordinateToVector3(t).sub(o);return new n.Vector2(e.x,e.y)}));return new n.Shape(e)}))),s},o.toExtrudeMesh=function(t,r,i,o){var a=this;if(!t)return null;if(t instanceof e.MultiPolygon)return t.getGeometries().map((function(t){return a.toExtrudeMesh(t,r,i,o)}));var s=t.getCoordinates();s.forEach((function(t){for(var e=t.length-1;e>=1;e--)t[e].equals(t[e-1])&&t.splice(e,1)})),t.setCoordinates(s);var c=this.toShape(t),u=this.coordinateToVector3(t.getCenter());o=e.Util.isNumber(o)?o:r,o=this.distanceToVector3(o,o).x;var l=this.distanceToVector3(r,r).x,h={bevelEnabled:!1,bevelSize:1};h[parseInt(n.REVISION)>=93?"depth":"amount"]=o;var f=new n.ExtrudeGeometry(c,h),d=f;n.BufferGeometry.prototype.fromGeometry&&(d=new n.BufferGeometry).fromGeometry(f);var v=new n.Mesh(d,i);return v.position.set(u.x,u.y,l-o),v},o.toExtrudePolygon=function(t,e,n){return new Oe(t,e,n,this)},o.toBar=function(t,e,n){return new V(t,e,n,this)},o.toLine=function(t,e,n){return new fe(t,e,n,this)},o.toExtrudeLine=function(t,e,n){return new we(t,e,n,this)},o.toModel=function(t,e){return new je(t,e,this)},o.toExtrudeLineTrail=function(t,e,n){return new Ee(t,e,n,this)},o.toExtrudePolygons=function(t,e,n){return new qe(t,e,n,this)},o.toPoint=function(t,e,n){return new Qe(t,e,n,this)},o.toPoints=function(t,e,n){return new rn(t,e,n,this)},o.toBars=function(t,e,n){return new an(t,e,n,this)},o.toExtrudeLines=function(t,e,n){return new cn(t,e,n,this)},o.toLines=function(t,e,n){return new ln(t,e,n,this)},o.toThreeVectorTileLayer=function(t,e,n){return new _n(t,e,n,this)},o.toTerrain=function(t,e,n){return new An(t,e,n,this)},o.toTerrainVectorTileLayer=function(t,e,n){return new Tn(t,e,n,this)},o.toHeatMap=function(t,e,n){return new En(t,e,n,this)},o.toFatLine=function(t,e,n){return new Fn(t,e,n,this)},o.toFatLines=function(t,e,n){return new Hn(t,e,n,this)},o.toBox=function(t,e,n){return new qn(t,e,n,this)},o.toBoxs=function(t,e,n){return new Kn(t,e,n,this)},o.getBaseObjects=function(){return this.getMeshes().filter((function(t){return t instanceof y}))},o.getMeshes=function(){var t=this.getScene();if(!t)return[];for(var e=[],r=0,i=t.children.length;r<i;r++){var o=t.children[r];o instanceof n.Object3D&&!(o instanceof n.Camera)&&e.push(o.__parent||o)}return e},o.clear=function(){return this.clearMesh()},o.clearMesh=function(){var t=this.getScene();if(!t)return this;for(var e=t.children.length-1;e>=0;e--){var r=t.children[e];if(r instanceof n.Object3D&&!(r instanceof n.Camera)){t.remove(r);var i=r.__parent;i&&i instanceof y&&(i.isAdd=!1,i._fire("remove",{target:i}),delete this._animationBaseObjectMap[r.uuid])}}return this},o.lookAt=function(t){var e=this._getRenderer();return e&&e.context.lookAt(t),this},o.getCamera=function(){var t=this._getRenderer();return t?t.camera:null},o.getScene=function(){var t=this._getRenderer();return t?t.scene:null},o.renderScene=function(){var t=this._getRenderer();return t&&(t.clearCanvas(),t.renderScene()),this},o.loop=function(t){void 0===t&&(t=!1);var e=this._delayMeshes;if(e.length){var n=this.getMap();if(n&&!n.isAnimating()&&!n.isInteracting()){var r=this.options.loopRenderCount||50,i=e.slice(0,r);i&&this.addMesh(i,t),e.splice(0,r)}}},o.renderPickScene=function(){var t=this._getRenderer();if(t){var e=t.pick;e&&e.pick(this._containerPoint)}return this},o.getThreeRenderer=function(){var t=this._getRenderer();return t?t.context:null},o.getPick=function(){var t=this._getRenderer();return t?t.pick:null},o.delayAddMesh=function(t){if(!t)return this;Array.isArray(t)||(t=[t]);for(var e=0,n=t.length;e<n;e++)this._delayMeshes.push(t[e]);return this},o.addMesh=function(t,r){var i=this;if(void 0===r&&(r=!0),!t)return this;Array.isArray(t)||(t=[t]);var o=this.getScene();return t.forEach((function(t){t instanceof y?(o.add(t.getObject3d()),t.isAdd||(t.isAdd=!0,t._fire("add",{target:t})),t._animation&&e.Util.isFunction(t._animation)&&(i._animationBaseObjectMap[t.getObject3d().uuid]=t)):t instanceof n.Object3D&&o.add(t)})),this._zoomend(),r&&this.renderScene(),this},o.removeMesh=function(t,r){var i=this;if(void 0===r&&(r=!0),!t)return this;Array.isArray(t)||(t=[t]);var o=this.getScene();return t.forEach((function(t){if(t instanceof y){o.remove(t.getObject3d()),t.isAdd&&(t.isAdd=!1,t._fire("remove",{target:t})),t._animation&&e.Util.isFunction(t._animation)&&delete i._animationBaseObjectMap[t.getObject3d().uuid];var r=i._delayMeshes;if(r.length)for(var a=0,s=r.length;a<s;a++)if(r[a]===t){r.splice(a,1);break}}else t instanceof n.Object3D&&o.remove(t)})),r&&this.renderScene(),this},o._initRaycaster=function(){return this._raycaster||(this._raycaster=new n.Raycaster,this._mouse=new n.Vector2),this},o.identify=function(t,r){var i=this;if(!t)return console.error("coordinate is null,it should be Coordinate"),[];if(Array.isArray(t)&&(t=new e.Coordinate(t)),!(t instanceof e.Coordinate))return console.error("coordinate type is error,it should be Coordinate"),[];var o=this.getMap().coordToContainerPoint(t);this._containerPoint=o;var s=o.x,c=o.y;this._initRaycaster();var u=this._raycaster,l=this._mouse,h=this.getCamera(),f=this.getScene(),d=this.getMap().getSize();if(!f)return[];var v=d.width,g=d.height;l.x=s/v*2-1,l.y=-c/g*2+1,u.setFromCamera(l,h),function(t,e){a>113?t.params.Line.threshold=e:t.linePrecision=e}(u,this._getLinePrecision(this.getMap().getResolution()));var p=[],x=[];f.children.forEach((function(t){var r=t.__parent;if(r&&r.getOptions){var i=r;i.getOptions().interactive&&i.isVisible()&&(i.identify&&e.Util.isFunction(i.identify)?x.push(i):p.push(t))}else(t instanceof n.Mesh||t instanceof n.Group)&&p.push(t)}));var y=[],m=u.intersectObjects(p,!0);m&&Array.isArray(m)&&m.length&&(y=m.map((function(t){var e=t.object,n=(e=i._recursionMesh(e)||{}).__parent||e;return n.faceIndex=t.faceIndex,n.index=t.index,n}))),this.renderPickScene(),x.length&&x.forEach((function(e){e.identify(t)&&y.push(e)}));for(var b=y.length,_=0;_<b;_++)if(y[_])for(var w=_+1;w<b;w++)y[_]===y[w]&&y.splice(w,1);var M=(r=e.Util.extend({},r)).count;return e.Util.isNumber(M)&&M>0?y.slice(0,M):y},o._recursionMesh=function(t){for(;t&&t.parent!==this.getScene();)t=t.parent;return t},o._getLinePrecision=function(t){void 0===t&&(t=10);for(var e=0,n=Xn.length;e<n;e++){var r=Xn[e],i=r[0],o=r[1];if(t>i)return o}return.01},o._identifyBaseObjectEvents=function(t){if(!this.options.geometryEvents)return this;var n=this.map||this.getMap();if(n.isInteracting()||!n.options.geometryEvents)return this;var r=t.type,i=t.coordinate,o=e.Util.now();if(this._mousemoveTimeOut&&"mousemove"===r&&o-this._mousemoveTimeOut<64)return this;this._mousemoveTimeOut=o,n.resetCursor("default");var a=this.options.identifyCountOnEvent,s=Math.max(0,e.Util.isNumber(a)?a:0);0===s&&(s=1/0);var c=this.identify(i,{count:s}),u=this.getScene();if(0===c.length&&u)for(var l=0,h=u.children.length;l<h;l++){var f=(u.children[l]||{}).__parent;f&&f.fire("empty",Object.assign({},t,{target:f}))}if("mousemove"===r){c.length&&n.setCursor("pointer");var d=[];this._baseObjects&&this._baseObjects.forEach((function(t){var e=!0;c.forEach((function(n){t===n&&(e=!1)})),e&&d.push(t)})),d.forEach((function(e){e&&e instanceof y&&(e.getSelectMesh?e.isHide||(e._mouseover=!1,e.fire("mouseout",Object.assign({},t,{target:e,type:"mouseout",selectMesh:null})),e.closeToolTip()):(e._mouseover=!1,e.fire("mouseout",Object.assign({},t,{target:e,type:"mouseout"})),e.closeToolTip()))})),c.forEach((function(e){if(e instanceof y){e._mouseover||(e.fire("mouseover",Object.assign({},t,{target:e,type:"mouseover",selectMesh:e.getSelectMesh?e.getSelectMesh():null})),e._mouseover=!0),e.fire(r,Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null}));var n=e.getToolTip();n&&!n._owner&&n.addTo(e),e.openToolTip(i)}})),this._baseObjects=c}else c.forEach((function(e){if(e instanceof y&&(e.fire(r,Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null})),"click"===r)){var n=e.getInfoWindow();n&&!n._owner&&n.addTo(e),e.openInfoWindow(i)}}));return this},o._zoomend=function(){var t=this.getScene();if(t){var n=this.getMap().getZoom();t.children.forEach((function(t){var r=t.__parent;if(r&&r.getOptions){var i=r;i.zoomChange&&e.Util.isFunction(i.zoomChange)&&i.zoomChange(n);var o=i.getMinZoom(),a=i.getMaxZoom();n<o||n>a?(i.isVisible()&&(i.getObject3d().visible=!1),i._zoomVisible=!1):o<=n&&n<=a&&(i._visible&&(i.getObject3d().visible=!0),i._zoomVisible=!0)}}))}},o.onAdd=function(){var e=this;t.prototype.onAdd.call(this);var n=this.map||this.getMap();return n?(Qn.forEach((function(t){n.on(t,e._identifyBaseObjectEvents,e)})),this._needsUpdate=!0,this._animationBaseObjectMap||(this._animationBaseObjectMap={}),n.on("zooming zoomend",this._zoomend,this),this):this},o.onRemove=function(){var e=this;t.prototype.onRemove.call(this);var n=this.map||this.getMap();return n?(Qn.forEach((function(t){n.off(t,e._identifyBaseObjectEvents,e)})),n.off("zooming zoomend",this._zoomend,this),this):this},o._callbackBaseObjectAnimation=function(){var t=this;if(t._animationBaseObjectMap)for(var e in t._animationBaseObjectMap){t._animationBaseObjectMap[e]._animation()}return this},o._getFovRatio=function(){var t=this.getMap().getFov();return Math.tan(t/2*Jn)},i}(e.CanvasLayer);tr.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null,geometryEvents:!0,identifyCountOnEvent:0,forceRenderOnZooming:!0,loopRenderCount:50});var er=function(t){function i(){var e;return(e=t.apply(this,arguments)||this)._renderTime=0,e}r(i,t);var o=i.prototype;return o.getPrepareParams=function(){return[this.scene,this.camera]},o.getDrawParams=function(){return[this.scene,this.camera]},o._drawLayer=function(){t.prototype._drawLayer.apply(this,arguments)},o.hitDetect=function(){return!1},o.createCanvas=function(){t.prototype.createCanvas.call(this),this.createContext()},o.createContext=function(){if(this.canvas.gl&&this.canvas.gl.wrap)this.gl=this.canvas.gl.wrap();else{var t=this.layer.options.glOptions||{alpha:!0,depth:!0,antialias:!0,stencil:!0,preserveDrawingBuffer:!1};t.preserveDrawingBuffer=!0,this.gl=this.gl||this._createGLContext(this.canvas,t)}this._initThreeRenderer(),this.layer.onCanvasCreate(this.context,this.scene,this.camera)},o._initThreeRenderer=function(){this.matrix4=new n.Matrix4;var t=new n.WebGLRenderer({context:this.gl,alpha:!0});t.autoClear=!1,t.setClearColor(new n.Color(1,1,1),0),t.setSize(this.canvas.width,this.canvas.height),t.clear(),this.context=t;var e=this.scene=new n.Scene,r=this.layer.getMap(),i=r.getFov()*Math.PI/180,o=this.camera=new n.PerspectiveCamera(i,r.width/r.height,r.cameraNear,r.cameraFar);o.matrixAutoUpdate=!1,this._syncCamera(),e.add(o),this.pick=new Zn(this.layer)},o.onCanvasCreate=function(){t.prototype.onCanvasCreate.call(this)},o.resizeCanvas=function(t){if(this.canvas){var n,r=this.getMap();n=t||r.getSize();var i=r.getDevicePixelRatio?r.getDevicePixelRatio():e.Browser.retina?2:1,o=this.canvas;o.height=i*n.height,o.width=i*n.width,this.layer._canvas&&o.style&&(o.style.width=n.width+"px",o.style.height=n.height+"px"),this.context.setSize(o.width,o.height)}},o.clearCanvas=function(){this.canvas&&this.context.clear()},o.prepareCanvas=function(){return this.canvas?this.clearCanvas():this.createCanvas(),this.layer.fire("renderstart",{context:this.context}),null},o.renderScene=function(){var t=e.Util.now();t-this._renderTime>=16&&(this.layer._callbackBaseObjectAnimation(),this._renderTime=t),this._syncCamera(),this.context.render(this.scene,this.camera),this.completeRender()},o.remove=function(){delete this._drawContext,t.prototype.remove.call(this)},o._syncCamera=function(){var t=this.getMap(),e=this.camera;e.matrix.elements=t.cameraWorldMatrix,e.projectionMatrix.elements=t.projMatrix,this.matrix4.invert?e.projectionMatrixInverse.elements=this.matrix4.copy(e.projectionMatrix).invert().elements:e.projectionMatrixInverse.elements=this.matrix4.getInverse(e.projectionMatrix).elements},o._createGLContext=function(t,e){for(var n=["webgl2","webgl","experimental-webgl"],r=null,i=0;i<n.length;++i){try{r=t.getContext(n[i],e)}catch(t){}if(r)break}return r},i}(e.renderer.CanvasLayerRenderer);function nr(t){return t.getGLRes?t.getGLRes():t.getGLZoom()}function rr(t,e,n,r){return t.coordToPointAtRes?t.coordToPointAtRes(e,n,r):t.coordinateToPoint(e,n,r)}tr.registerRenderer("gl",er),e.registerWorkerAdapter&&e.registerWorkerAdapter("__maptalks.three__",'function(e){"use strict";var d=n,t=n;function n(e,t,n){n=n||2;var r,i,o,a,v,h=t&&t.length,l=h?t[0]*n:e.length,u=p(e,0,l,n,!0),x=[];if(!u||u.next===u.prev)return x;if(h&&(u=function(e,t,n,r){var i,o,a,v,h=[];for(i=0,o=t.length;i<o;i++)a=t[i]*r,v=i<o-1?t[i+1]*r:e.length,(v=p(e,a,v,r,!1))===v.next&&(v.steiner=!0),h.push(function(e){var t=e,n=e;for(;(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next,t!==e;);return n}(v));for(h.sort(m),i=0;i<h.length;i++)!function(e,t){(t=function(e,t){var n,r=t,i=e.x,o=e.y,a=-1/0;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var v=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(v<=i&&a<v){if((a=v)===i){if(o===r.y)return r;if(o===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}}while(r=r.next,r!==t);if(!n)return null;if(i===a)return n;var h,l=n,u=n.x,x=n.y,f=1/0;r=n;for(;i>=r.x&&r.x>=u&&i!==r.x&&M(o<x?i:a,o,u,x,o<x?a:i,o,r.x,r.y)&&(h=Math.abs(o-r.y)/(i-r.x),Z(r,e)&&(h<f||h===f&&(r.x>n.x||r.x===n.x&&function(e,t){return w(e.prev,e,t.prev)<0&&w(t.next,e,e.next)<0}(n,r)))&&(n=r,f=h)),r=r.next,r!==l;);return n}(e,t))&&(e=S(t,e),g(t,t.next),g(e,e.next))}(h[i],n),n=g(n,n.next);return n}(e,t,u,n)),e.length>80*n){for(var f=r=e[0],s=i=e[1],c=n;c<l;c+=n)(o=e[c])<f&&(f=o),(a=e[c+1])<s&&(s=a),r<o&&(r=o),i<a&&(i=a);v=0!==(v=Math.max(r-f,i-s))?1/v:0}return y(u,x,n,f,s,v),x}function p(e,t,n,r,i){var o,a;if(i===0<z(e,t,n,r))for(o=t;o<n;o+=r)a=v(o,e[o],e[o+1],a);else for(o=n-r;t<=o;o-=r)a=v(o,e[o],e[o+1],a);return a&&u(a,a.next)&&(f(a),a=a.next),a}function g(e,t){if(!e)return e;t=t||e;var n,r=e;do{if(n=!1,r.steiner||!u(r,r.next)&&0!==w(r.prev,r,r.next))r=r.next;else{if(f(r),(r=t=r.prev)===r.next)break;n=!0}}while(n||r!==t);return t}function y(e,t,n,r,i,o,a){if(e){!a&&o&&function(e,t,n,r){for(var i=e;null===i.z&&(i.z=b(i.x,i.y,t,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next,i!==e;);i.prevZ.nextZ=null,i.prevZ=null,function(e){var t,n,r,i,o,a,v,h,l=1;do{for(n=e,o=e=null,a=0;n;){for(a++,r=n,t=v=0;t<l&&(v++,r=r.nextZ);t++);for(h=l;0<v||0<h&&r;)0!==v&&(0===h||!r||n.z<=r.z)?(n=(i=n).nextZ,v--):(r=(i=r).nextZ,h--),o?o.nextZ=i:e=i,i.prevZ=o,o=i;n=r}}while(o.nextZ=null,l*=2,1<a)}(i)}(e,r,i,o);for(var v,h,l=e;e.prev!==e.next;)if(v=e.prev,h=e.next,o?function(e,t,n,r){var i=e.prev,o=e,a=e.next;if(0<=w(i,o,a))return!1;var v=(i.x<o.x?i.x<a.x?i:a:o.x<a.x?o:a).x,h=(i.y<o.y?i.y<a.y?i:a:o.y<a.y?o:a).y,l=(i.x>o.x?i.x>a.x?i:a:o.x>a.x?o:a).x,u=(i.y>o.y?i.y>a.y?i:a:o.y>a.y?o:a).y,x=b(v,h,t,n,r),f=b(l,u,t,n,r),s=e.prevZ,c=e.nextZ;for(;s&&s.z>=x&&c&&c.z<=f;){if(s!==e.prev&&s!==e.next&&M(i.x,i.y,o.x,o.y,a.x,a.y,s.x,s.y)&&0<=w(s.prev,s,s.next))return!1;if(s=s.prevZ,c!==e.prev&&c!==e.next&&M(i.x,i.y,o.x,o.y,a.x,a.y,c.x,c.y)&&0<=w(c.prev,c,c.next))return!1;c=c.nextZ}for(;s&&s.z>=x;){if(s!==e.prev&&s!==e.next&&M(i.x,i.y,o.x,o.y,a.x,a.y,s.x,s.y)&&0<=w(s.prev,s,s.next))return!1;s=s.prevZ}for(;c&&c.z<=f;){if(c!==e.prev&&c!==e.next&&M(i.x,i.y,o.x,o.y,a.x,a.y,c.x,c.y)&&0<=w(c.prev,c,c.next))return!1;c=c.nextZ}return!0}(e,r,i,o):function(e){var t=e.prev,n=e,r=e.next;if(0<=w(t,n,r))return!1;var i=e.next.next;for(;i!==e.prev;){if(M(t.x,t.y,n.x,n.y,r.x,r.y,i.x,i.y)&&0<=w(i.prev,i,i.next))return!1;i=i.next}return!0}(e))t.push(v.i/n),t.push(e.i/n),t.push(h.i/n),f(e),e=h.next,l=h.next;else if((e=h)===l){a?1===a?y(e=function(e,t,n){var r=e;do{var i=r.prev,o=r.next.next}while(!u(i,o)&&x(i,r,r.next,o)&&Z(i,o)&&Z(o,i)&&(t.push(i.i/n),t.push(r.i/n),t.push(o.i/n),f(r),f(r.next),r=e=o),r=r.next,r!==e);return g(r)}(g(e),t,n),t,n,r,i,o,2):2===a&&function(e,t,n,r,i,o){var a=e;do{for(var v=a.next.next;v!==a.prev;){if(a.i!==v.i&&function(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&x(n,n.next,e,t))return!0}while(n=n.next,n!==e);return!1}(e,t)&&(Z(e,t)&&Z(t,e)&&function(e,t){var n=e,r=!1,i=(e.x+t.x)/2,o=(e.y+t.y)/2;for(;n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next,n!==e;);return r}(e,t)&&(w(e.prev,e,t.prev)||w(e,t.prev,t))||u(e,t)&&0<w(e.prev,e,e.next)&&0<w(t.prev,t,t.next))}(a,v)){var h=S(a,v);return a=g(a,a.next),h=g(h,h.next),y(a,t,n,r,i,o),y(h,t,n,r,i,o)}v=v.next}}while((a=a.next)!==e)}(e,t,n,r,i,o):y(g(e),t,n,r,i,o,1);break}}}function m(e,t){return e.x-t.x}function b(e,t,n,r,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*i)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*i)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function M(e,t,n,r,i,o,a,v){return 0<=(i-a)*(t-v)-(e-a)*(o-v)&&0<=(e-a)*(r-v)-(n-a)*(t-v)&&0<=(n-a)*(o-v)-(i-a)*(r-v)}function w(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function u(e,t){return e.x===t.x&&e.y===t.y}function x(e,t,n,r){var i=l(w(e,t,n)),o=l(w(e,t,r)),a=l(w(n,r,e)),v=l(w(n,r,t));return i!==o&&a!==v||(0===i&&h(e,n,t)||(0===o&&h(e,r,t)||(0===a&&h(n,e,r)||!(0!==v||!h(n,t,r)))))}function h(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}function l(e){return 0<e?1:e<0?-1:0}function Z(e,t){return w(e.prev,e,e.next)<0?0<=w(e,t,e.next)&&0<=w(e,e.prev,t):w(e,t,e.prev)<0||w(e,e.next,t)<0}function S(e,t){var n=new a(e.i,e.x,e.y),r=new a(t.i,t.x,t.y),i=e.next,o=t.prev;return(e.next=t).prev=e,(n.next=i).prev=n,(r.next=n).prev=r,(o.next=r).prev=o,r}function v(e,t,n,r){n=new a(e,t,n);return r?(n.next=r.next,(n.prev=r).next.prev=n,r.next=n):(n.prev=n).next=n,n}function f(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function a(e,t,n){this.i=e,this.x=t,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function z(e,t,n,r){for(var i=0,o=t,a=n-r;o<n;o+=r)i+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return i}function r(e,t){var n=e.length-1,r=[e[0]];return function e(t,n,r,i,o){for(var a,v,h,l,u,x,f,s=i,c=n+1;c<r;c++){var p=(v=t[c],h=t[n],l=t[r],p=f=x=u=void 0,u=h[0],x=h[1],f=l[0]-u,p=l[1]-x,0===f&&0===p||(1<(h=((v[0]-u)*f+(v[1]-x)*p)/(f*f+p*p))?(u=l[0],x=l[1]):0<h&&(u+=f*h,x+=p*h)),(f=v[0]-u)*f+(p=v[1]-x)*p);s<p&&(a=c,s=p)}i<s&&(1<a-n&&e(t,n,a,i,o),o.push(t[a]),1<r-a&&e(t,a,r,i,o))}(e,0,n,t,r),r.push(e[n]),r}function A(e,t,n){if(e.length<=2)return e;t=void 0!==t?t*t:1;return e=r(e=n?e:function(e,t){for(var n,r,i,o,a=e[0],v=[a],h=1,l=e.length;h<l;h++)n=e[h],i=a,o=void 0,o=(r=n)[0]-i[0],i=r[1]-i[1],t<o*o+i*i&&(v.push(n),a=n);return a!==n&&v.push(n),v}(e,t),t)}function R(e,t){var n=t[0],r=t[1],t=Math.sqrt(n*n+r*r);return e[0]=n/t,e[1]=r/t,e}function s(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e}function F(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e}n.deviation=function(e,t,n,r){var i=t&&t.length,o=i?t[0]*n:e.length,a=Math.abs(z(e,0,o,n));if(i)for(var v=0,h=t.length;v<h;v++){var l=t[v]*n,u=v<h-1?t[v+1]*n:e.length;a-=Math.abs(z(e,l,u,n))}for(var x=0,v=0;v<r.length;v+=3){var f=r[v]*n,s=r[v+1]*n,c=r[v+2]*n;x+=Math.abs((e[f]-e[c])*(e[1+s]-e[1+f])-(e[f]-e[s])*(e[1+c]-e[1+f]))}return 0===a&&0===x?0:Math.abs((x-a)/a)},n.flatten=function(e){for(var t=e[0][0].length,n={vertices:[],holes:[],dimensions:t},r=0,i=0;i<e.length;i++){for(var o=0;o<e[i].length;o++)for(var a=0;a<t;a++)n.vertices.push(e[i][o][a]);0<i&&(r+=e[i-1].length,n.holes.push(r))}return n},d.default=t;var c=[];function ee(e,t,n,r){var i,o,a=(o=n,(i=t)[0]*o[0]+i[1]*o[1]+i[2]*o[2]),v=Math.acos(a)*r;return s(c,n,t,-a),r=(o=i=c)[0],n=o[1],a=o[2],o=Math.sqrt(r*r+n*n+a*a),i[0]=r/o,i[1]=n/o,i[2]=a/o,a=e,o=t,t=Math.cos(v),a[0]=o[0]*t,a[1]=o[1]*t,a[2]=o[2]*t,s(e,e,c,Math.sin(v)),e}function q(e,t,n){if(n-t<3)return 0;for(var r=0,i=2*(n-1),o=2*t;o<2*n;){var a=e[i],v=e[i+1],h=e[o],l=e[o+1],i=o;o+=2,r+=a*l-h*v}return r}var B=[],U=[],L=[];function O(e,t,n,r,i,o,a,v){var h=null!=a,l=i,u=null;h&&(u=new Uint32Array(r-n));for(var x=n;x<r;x++){var f=x===r-1?n:x+1,s=x===n?r-1:x-1,c=e[2*s],p=e[2*s+1],g=e[2*x],d=e[2*x+1],s=e[2*f],f=e[2*f+1];B[0]=g-c,B[1]=d-p,U[0]=s-g,U[1]=f-d,R(B,B),R(U,U),h&&(u[x]=l),v||x!==n?v||x!==r-1?(c=U,p=B,(s=L)[0]=c[0]+p[0],s[1]=c[1]+p[1],f=L[1],L[1]=-L[0],L[0]=f,R(L,L),s=U,p=(c=L)[0]*s[0]+c[1]*s[1],f=Math.sqrt(1-p*p),c=o*Math.min(10,1/f),h&&a<1/f&&o*p<0?(s=g+L[0]*o,p=d+L[1]*o,f=Math.acos(f)/2,f=Math.tan(f)*Math.abs(o),t[2*l]=s+L[1]*f,t[2*l+1]=p-L[0]*f,t[2*++l]=s-L[1]*f,t[2*l+1]=p+L[0]*f):(t[2*l]=g+L[0]*c,t[2*l+1]=d+L[1]*c)):(L[0]=B[1],L[1]=-B[0],R(L,L),t[2*l]=g+L[0]*o,t[2*l+1]=d+L[1]*o):(L[0]=U[1],L[1]=-U[0],R(L,L),t[2*l]=g+L[0]*o,t[2*l+1]=d+L[1]*o),l++}return u}function P(e,t,n,r,i){var o=null!=r?[]:new Float32Array(e.length);if(O(e,o,0,t&&t.length?t[0]:e.length/2,0,n,r,i),t)for(var a=0;a<t.length;a++){var v=t[a];O(e,o,v,t[a+1]||e.length/2,null!=r?o.length/2:v,n,r,i)}return o}function V(e,t,n,r){for(var i=0;i<Math.floor((r-n)/2);i++)for(var o=0;o<t;o++){var a=(i+n)*t+o,v=(r-i-1)*t+o,h=e[a];e[a]=e[v],e[v]=h}return e}function W(e){e.depth=e.depth||1,e.bevelSize=e.bevelSize||0,e.bevelSegments=null==e.bevelSegments?2:e.bevelSegments,e.smoothSide=e.smoothSide||!1,e.smoothBevel=e.smoothBevel||!1,e.simplify=e.simplify||0,"number"==typeof e.depth&&(e.bevelSize=Math.min(0<e.bevelSegments?e.bevelSize:0,e.depth/2)),0<e.bevelSize||(e.bevelSegments=0),e.bevelSegments=Math.round(e.bevelSegments);var t,n,r,i,o=e.boundingRect;e.translate=e.translate||[0,0],e.scale=e.scale||[1,1],e.fitRect&&(t=null==e.fitRect.x?o.x||0:e.fitRect.x,n=null==e.fitRect.y?o.y||0:e.fitRect.y,r=e.fitRect.width,i=e.fitRect.height,null==r?null!=i?r=i/o.height*o.width:(r=o.width,i=o.height):null==i&&(i=r/o.width*o.height),e.scale=[r/o.width,i/o.height],e.translate=[(t-o.x)*e.scale[0],(n-o.y)*e.scale[1]])}function j(e,t){function n(e,t,n,r){e[0]=t,e[1]=n,e[2]=r}for(var r,i,o,a,v,h,l,u=[],x=[],f=[],s=[],c=[],p=[],g=e.length,d=new Float32Array(t.length),y=0;y<g;){var m=3*e[y++],b=3*e[y++],M=3*e[y++];n(u,t[m],t[1+m],t[2+m]),n(x,t[b],t[1+b],t[2+b]),n(f,t[M],t[1+M],t[2+M]),F(s,u,x),F(c,x,f),r=p,o=c,l=h=v=a=void 0,a=(i=s)[0],v=i[1],h=i[2],l=o[0],i=o[1],o=o[2],r[0]=v*o-h*i,r[1]=h*l-a*o,r[2]=a*i-v*l;for(var w=0;w<3;w++)d[m+w]=d[m+w]+p[w],d[b+w]=d[b+w]+p[w],d[M+w]=d[M+w]+p[w]}for(var Z,S,z,A,R,q=0;q<d.length;)n(p,d[q],d[q+1],d[q+2]),R=A=z=void 0,z=(S=Z=p)[0],A=S[1],R=S[2],S=Math.sqrt(z*z+A*A+R*R),Z[0]=z/S,Z[1]=A/S,Z[2]=R/S,d[q++]=p[0],d[q++]=p[1],d[q++]=p[2];return d}var te=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function H(e,t,n,r,i,o){var a=t.vertices,v=t.topVertices,h=t.depth,t=t.rect,l=r-n,u=o.smoothSide?1:2,x=l*u,f=o.smoothBevel?1:2,s=Math.min(h/2,o.bevelSize),c=o.bevelSegments,p=i.vertex,g=Math.max(t.width,t.height,h);if(0<s)for(var d=[0,0,1],y=[],m=[0,0,-1],b=[],M=0,w=new Float32Array(l),Z=0;Z<2;Z++)for(var S=0===Z?h-s:s,z=0;z<=c*f;z++){for(var A=0,R=void 0,q=void 0,F=0;F<l;F++){for(var B=0;B<u;B++){var U=2*((F+B)%l+n);y[0]=a[U]-v[U],y[1]=a[1+U]-v[1+U],y[2]=0;var L=Math.sqrt(y[0]*y[0]+y[1]*y[1]);y[0]/=L,y[1]/=L;var O=(Math.floor(z/f)+z%f)/c;0===Z?ee(b,d,y,O):ee(b,y,m,O);var P=0===Z?O:1-O,V=s*Math.sin(P*Math.PI/2),W=L*Math.cos(P*Math.PI/2),O=s*L/Math.sqrt(V*V+W*W),P=b[0]*O+v[U],L=b[1]*O+v[1+U],V=b[2]*O+S;e.position[3*i.vertex]=P,e.position[3*i.vertex+1]=L,e.position[3*i.vertex+2]=V,(0<F||0<B)&&(A+=Math.sqrt((R-P)*(R-P)+(q-L)*(q-L))),(0<z||0<Z)&&(W=3*(i.vertex-x),U=e.position[W],O=e.position[1+W],W=e.position[2+W],w[F]+=Math.sqrt((U-P)*(U-P)+(O-L)*(O-L)+(W-V)*(W-V))),e.uv[2*i.vertex]=A/g,e.uv[2*i.vertex+1]=w[F]/g,R=P,q=L,i.vertex++}if(1<f&&z%f||1==f&&1<=z)for(var j=0;j<6;j++){var H=(te[j][0]+F*u)%x,k=te[j][1]+M;e.indices[i.index++]=(k-1)*x+H+p}}M++}else for(var I=0;I<2;I++)for(var _=0===I?h-s:s,D=0,E=void 0,C=void 0,G=0;G<l;G++)for(var J=0;J<u;J++){var K=2*((G+J)%l+n),N=a[K],K=a[1+K];e.position[3*i.vertex]=N,e.position[3*i.vertex+1]=K,e.position[3*i.vertex+2]=_,(0<G||0<J)&&(D+=Math.sqrt((E-N)*(E-N)+(C-K)*(C-K))),e.uv[2*i.vertex]=D/g,e.uv[2*i.vertex+1]=_/g,E=N,C=K,i.vertex++}for(var Q=0<s?c*f+1:1,T=0;T<l;T++)for(var X=0;X<6;X++){var Y=(te[X][0]+T*u)%x,$=te[X][1]+Q;e.indices[i.index++]=($-1)*x+Y+p}}function k(e,t){for(var n=0,r=0,i=0;i<e.length;i++){var o=e[i],a=o.indices,v=o.vertices,h=o.holes,o=o.depth,l=v.length/2,u=0<Math.min(o/2,t.bevelSize)?t.bevelSegments:0;n+=a.length*(t.excludeBottom?1:2),r+=l*(t.excludeBottom?1:2);for(var x=2+2*u,f=0,s=0,c=0;c<(h?h.length:0)+1;c++){n+=6*((s=0===c?h&&h.length?h[0]:l:(f=h[c-1],h[c]||l))-f)*(x-1);var p=(s-f)*(t.smoothSide?1:2);r+=p*x+(t.smoothBevel?0:u*p*2)}}for(var g={position:new Float32Array(3*r),indices:new(65535<r?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*r)},d={vertex:0,index:0},y=0;y<e.length;y++)!function(e,t,n,r){var i=e.indices,o=e.vertices,a=e.topVertices,v=e.rect,h=e.depth;if(!(o.length<=4)){for(var l=n.vertex,u=i.length,x=0;x<u;x++)t.indices[n.index++]=l+i[x];for(var f=Math.max(v.width,v.height),s=0;s<(r.excludeBottom?1:2);s++)for(var c=0;c<a.length;c+=2){var p=a[c],g=a[c+1];t.position[3*n.vertex]=p,t.position[3*n.vertex+1]=g,t.position[3*n.vertex+2]=(1-s)*h,t.uv[2*n.vertex]=(p-v.x)/f,t.uv[2*n.vertex+1]=(g-v.y)/f,n.vertex++}if(!r.excludeBottom)for(var d=o.length/2,y=0;y<u;y+=3)for(var m=0;m<3;m++)t.indices[n.index++]=l+d+i[y+2-m]}}(e[y],g,d,t);for(var m=0;m<e.length;m++){var b,M=e[m],w=M.holes,Z=M.vertices.length/2,S=w&&w.length?w[0]:Z;if(H(g,e[m],0,S,d,t),w)for(var z=0;z<w.length;z++)b=w[z],S=w[z+1]||Z,H(g,e[m],b,S,d,t)}for(var A=0;A<g.uv.length;A++){var R=g.uv[A];0<R&&Math.round(R)===R?g.uv[A]=1:g.uv[A]=R%1}return g.normal=j(g.indices,g.position),g.boundingRect=e[0]&&e[0].rect,g}function I(e,t){t=Object.assign({},t);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<e.length;i++)D(e[i][0],n,r);t.boundingRect=t.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},W(t);for(var o=[],a=t.translate||[0,0],v=t.scale||[1,1],h=t.boundingRect,l={x:h.x*v[0]+a[0],y:h.y*v[1]+a[1],width:h.width*v[0],height:h.height*v[1]},u=Math.min(h.width,h.height)/1e5,x=0;x<e.length;x++){var f=function(e,t){for(var n=[],r=0;r<e.length;r++){for(var i=e[r],o=[],a=i.length,v=i[a-1][0],h=i[a-1][1],l=0,u=0;u<a;u++){var x=i[u][0],f=i[u][1],s=x-v,c=f-h;t<(l+=Math.sqrt(s*s+c*c))&&(o.push(i[u]),l=0),v=x,h=f}3<=o.length&&n.push(o)}return 0<n.length?n:null}(e[x],u);if(f){var s=t.simplify/Math.max(v[0],v[1]);if(f=0<s?function(e,t){for(var n=[],r=0;r<e.length;r++){var i=e[r];3<=(i=A(i,t,!0)).length&&n.push(i)}return 0<n.length?n:null}(f,s):f){for(var c=d.flatten(f),p=c.vertices,s=c.holes,f=c.dimensions,g=0;g<p.length;)p[g]=p[g++]*v[0]+a[0],p[g]=p[g++]*v[1]+a[1];if(!function(e,t){var n=e.length/2,r=0,i=t&&t.length?t[0]:n;0<q(e,r,i)&&V(e,2,r,i);for(var o=1;o<(t?t.length:0)+1;o++)q(e,r=t[o-1],i=t[o]||n)<0&&V(e,2,r,i)}(p,s),2!==f)throw new Error("Only 2D polygon points are supported");c=0<t.bevelSize?P(p,s,t.bevelSize,null,!0):p,f=d(c,s,f=void 0===(f=f)?2:f);o.push({indices:f,vertices:p,topVertices:c,holes:s,rect:l,depth:"function"==typeof t.depth?t.depth(x):t.depth})}}}return k(o,t)}function _(e,t){t=Object.assign({},t);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<e.length;i++)D(e[i],n,r);t.boundingRect=t.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},W(t);var o=t.scale||[1,1];null==t.lineWidth&&(t.lineWidth=1),null==t.miterLimit&&(t.miterLimit=2);for(var a=[],v=0;v<e.length;v++){var h=e[v],l=t.simplify/Math.max(o[0],o[1]);0<l&&(h=A(h,l,!0)),a.push(function(e,t,n){for(var r=n.lineWidth,i=e.length,o=new Float32Array(2*i),a=n.translate||[0,0],v=n.scale||[1,1],h=0,l=0;h<i;h++)o[l++]=e[h][0]*v[0]+a[0],o[l++]=e[h][1]*v[1]+a[1];q(o,0,i)<0&&V(o,2,0,i);var u=[],x=[],f=n.miterLimit,s=O(o,x,0,i,0,-r/2,f,!1);V(o,2,0,i);for(var c=O(o,u,0,i,0,-r/2,f,!1),r=(u.length+x.length)/2,p=new Float32Array(2*r),g=0,d=x.length/2,y=0;y<x.length;y++)p[g++]=x[y];for(var m=0;m<u.length;m++)p[g++]=u[m];for(var b=new(65535<r?Uint32Array:Uint16Array)(3*(2*(i-1)+(r-2*i))),M=0,w=0;w<i-1;w++){var Z=w+1;b[M++]=d-1-s[w],b[M++]=d-1-s[w]-1,b[M++]=c[w]+1+d,b[M++]=d-1-s[w],b[M++]=c[w]+1+d,b[M++]=c[w]+d,c[Z]-c[w]==2?(b[M++]=c[w]+2+d,b[M++]=c[w]+1+d,b[M++]=d-s[Z]-1):s[Z]-s[w]==2&&(b[M++]=c[Z]+d,b[M++]=d-1-(s[w]+1),b[M++]=d-1-(s[w]+2))}return f=0<n.bevelSize?P(p,[],n.bevelSize,null,!0):p,r=n.boundingRect,{vertices:p,indices:b,topVertices:f,rect:{x:r.x*v[0]+a[0],y:r.y*v[1]+a[1],width:r.width*v[0],height:r.height*v[1]},depth:"function"==typeof n.depth?n.depth(t):n.depth,holes:[]}}(h,v,t))}return k(a,t)}function D(e,t,n){for(var r=0;r<e.length;r++)t[0]=Math.min(e[r][0],t[0]),t[1]=Math.min(e[r][1],t[1]),n[0]=Math.max(e[r][0],n[0]),n[1]=Math.max(e[r][1],n[1])}function E(e){for(var t=new Float32Array(e),n=[],r=0,i=t.length;r<i;r+=2){var o=t[r],a=t[r+1];n.push([o,a])}return n}function C(e,t){void 0===t&&(t=!1);for(var n,r,i,o,a=e.length,v=[],h=[],l=[],u=0,x=0,f=0,s=0,c=0;c<a;c++){var p=t?(p=e[c],r=i=n=o=i=r=n=void 0,n=p.data,r=p.height,i=p.width,o=p.bottomHeight,p=_(n,{lineWidth:i,depth:r}),n=p.position,i=p.normal,r=p.uv,p=p.indices,G(n,o),{position:n,normal:i,uv:r,indices:p}):(d=e[c],b=m=y=b=g=m=y=void 0,y=d.data,m=d.height,g=d.bottomHeight,b=I(y,{depth:m}),d=b.position,y=b.normal,m=b.uv,b=b.indices,G(d,g),{position:d,normal:y,uv:m,indices:b}),g=e[c].bottomHeight||0,d=p.position,y=p.normal,m=p.uv,b=p.indices;h.push(p);b=b.length/3;l[c]=[u+1,u+b],u+=b;d=d.length/3,y=y.length/3,m=m.length/2;v[c]={position:{middleZ:g+(e[c].height||0)/2,count:d,start:x,end:x+3*d},normal:{count:y,start:f,end:f+3*y},uv:{count:m,start:s,end:s+2*m},hide:!1},x+=3*d,f+=3*y,s+=2*m}var M=function(e){for(var t={},n={},r=0;r<e.length;++r){var i,o=e[r];for(i in o)void 0===t[i]&&(t[i]=[],n[i]=0),t[i].push(o[i]),n[i]+=o[i].length}var a,v={},h=0,l=[];for(a in t)if("indices"===a)for(var u=t[a],x=0,f=u.length;x<f;x++){for(var s=u[x],c=0,p=s.length;c<p;c++)l.push(s[c]+h);h+=t.position[x].length/3}else{var g=function(e,t){for(var n=new Float32Array(t),r=0,i=0;i<e.length;++i)n.set(e[i],r),r+=e[i].length;return n}(t[a],n[a]);if(!g)return null;v[a]=g}return v.indices=new Uint32Array(l),v}(h),w=M.position,Z=M.normal,S=M.uv,M=M.indices;return{position:w.buffer,normal:Z.buffer,uv:S.buffer,indices:M.buffer,faceMap:l,geometriesAttributes:v}}function G(e,t){if(void 0!==t&&"number"==typeof t&&0!==t)for(var n=0,r=e.length;n<r;n+=3)e[n+2]+=t}e.initialize=function(){},e.onmessage=function(e,t){var n=e.data,e=n.type,r=n.datas;if("Polygon"===e){!function(e){for(var t=e.length,n=0;n<t;n++)for(var r=e[n].data,i=0,o=r.length;i<o;i++)for(var a=r[i],v=0,h=a.length;v<h;v++)e[n].data[i][v]=E(a[v])}(r);n=C(r);t(null,n,[n.position,n.normal,n.uv,n.indices])}else if("LineString"===e){for(var i=0,o=r.length;i<o;i++)for(var a=0,v=r[i].data.length;a<v;a++)r[i].data[a]=E(r[i].data[a]);e=C(r,!0);t(null,e,[e.position,e.normal,e.uv,e.indices])}},Object.defineProperty(e,"__esModule",{value:!0})}'),t.BaseObject=y,t.ExtrudeUtil=be,t.GeoJSONUtil=ie,t.GeoUtil=Pe,t.IdentifyUtil=Ke,t.LineMaterial=f,t.LineUtil=le,t.MergeGeometryUtil=S,t.MergedMixin=Fe,t.ThreeLayer=tr,t.ThreeRenderer=er,t.geometryExtrude=Nt,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.three v0.17.2")}));
